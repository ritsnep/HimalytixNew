{% extends 'accounting/_form_base.html' %}
{% load static %}

{% block title %}AP Payment{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .form-section { margin-bottom: 2rem; }
        .form-section-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        .form-group { margin-bottom: 1rem; }
        .required-field::after { content: " *"; color: #dc3545; }
        .invalid-feedback { display: block; }
        .table-allocations thead { background-color: #f8f9fa; }
        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    </style>
{% endblock %}

{% block form_content %}
<div class="card shadow-sm">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-3">
        <div>
            <h4 class="card-title mb-0">
                <i class="fe fe-credit-card me-2"></i>{{ form_title }}
            </h4>
            <p class="text-muted small mb-0">Create and manage vendor payment transactions</p>
        </div>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'accounting:ap_payment_list' %}">
            <i class="fe fe-arrow-left me-1"></i>Back to List
        </a>
    </div>
    <div class="card-body">
        <form method="post" novalidate id="paymentForm">
            {% csrf_token %}

            <!-- Basic Information Section -->
            <div class="form-section">
                <h5 class="form-section-title"><i class="fe fe-info me-2"></i>Basic Information</h5>
                <div class="row">
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Payment Number</label>
                        {{ form.payment_number }}
                        {% if form.payment_number.errors %}<div class="invalid-feedback d-block">{{ form.payment_number.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Vendor</label>
                        {{ form.vendor }}
                        {% if form.vendor.errors %}<div class="invalid-feedback d-block">{{ form.vendor.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Payment Date</label>
                        {{ form.payment_date }}
                        {% if form.payment_date.errors %}<div class="invalid-feedback d-block">{{ form.payment_date.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Payment Method</label>
                        {{ form.payment_method }}
                        {% if form.payment_method.errors %}<div class="invalid-feedback d-block">{{ form.payment_method.errors.0 }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Financial Details Section -->
            <div class="form-section">
                <h5 class="form-section-title"><i class="fe fe-dollar-sign me-2"></i>Financial Details</h5>
                <div class="row">
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Bank / Cash Account</label>
                        {{ form.bank_account }}
                        {% if form.bank_account.errors %}<div class="invalid-feedback d-block">{{ form.bank_account.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Currency</label>
                        {{ form.currency }}
                        {% if form.currency.errors %}<div class="invalid-feedback d-block">{{ form.currency.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label">Exchange Rate</label>
                        {{ form.exchange_rate }}
                        {% if form.exchange_rate.errors %}<div class="invalid-feedback d-block">{{ form.exchange_rate.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Status</label>
                        {{ form.status }}
                        {% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 form-group">
                        <label class="form-label required-field">Amount</label>
                        {{ form.amount }}
                        {% if form.amount.errors %}<div class="invalid-feedback d-block">{{ form.amount.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-3 form-group">
                        <label class="form-label">Discount Taken</label>
                        {{ form.discount_taken }}
                        {% if form.discount_taken.errors %}<div class="invalid-feedback d-block">{{ form.discount_taken.errors.0 }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Invoice Allocations Section -->
            <div class="form-section">
                <h5 class="form-section-title"><i class="fe fe-file-text me-2"></i>Invoice Allocations</h5>
                <div class="table-responsive">
                    {{ formset.management_form }}
                    <table class="table table-hover align-middle table-allocations">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Purchase Invoice</th>
                                <th style="width: 25%;">Applied Amount</th>
                                <th style="width: 25%;">Discount</th>
                                <th style="width: 15%;" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="payment-lines">
                            {% for line_form in formset %}
                            <tr class="line-row">
                                {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <td>{{ line_form.invoice }}</td>
                                <td>{{ line_form.applied_amount }}</td>
                                <td>{{ line_form.discount_taken }}</td>
                                <td class="text-center">
                                    {% if formset.can_delete %}
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-action delete-line" 
                                            title="Delete this allocation" data-delete-field="{{ line_form.DELETE.id_for_label }}">
                                        <i class="fe fe-trash"></i>
                                    </button>
                                    {{ line_form.DELETE }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-payment-line">
                    <i class="fe fe-plus me-1"></i>Add Allocation
                </button>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <a class="btn btn-outline-secondary" href="{% url 'accounting:ap_payment_list' %}">
                    <i class="fe fe-x me-1"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fe fe-check me-2"></i>Save Payment
                </button>
            </div>
        </form>
    </div>
</div>
<template id="payment-line-template">
    <tr class="line-row">
        {% with form=formset.empty_form %}
            {% for hidden in form.hidden_fields %}{{ hidden.as_widget|safe }}{% endfor %}
            <td>{{ form.invoice.as_widget }}</td>
            <td>{{ form.applied_amount.as_widget }}</td>
            <td>{{ form.discount_taken.as_widget }}</td>
            <td>
                <div class="form-check">
                    {{ form.DELETE }}
                    <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">Delete</label>
                </div>
            </td>
        {% endwith %}
    </tr>
</template>
{% endblock form_content %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    const addBtn = document.getElementById('add-payment-line');
    const tbody = document.getElementById('payment-lines');
    const totalForms = document.getElementById('id_lines-TOTAL_FORMS');
    const template = document.querySelector('template#payment-line-template');
    
    if (!addBtn || !tbody || !totalForms) {
        return;
    }

    // Handle delete buttons
    function setupDeleteButtons() {
        document.querySelectorAll('.delete-line').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const deleteField = this.getAttribute('data-delete-field');
                const checkbox = document.getElementById(deleteField);
                if (checkbox) {
                    checkbox.checked = true;
                    this.closest('tr').style.opacity = '0.6';
                    this.closest('tr').style.textDecoration = 'line-through';
                }
            });
        });
    }

    // Add new line
    addBtn.addEventListener('click', function() {
        const index = parseInt(totalForms.value, 10);
        const newForm = document.createElement('tr');
        newForm.className = 'line-row';
        
        // Clone empty form and update field names/IDs
        const emptyForm = document.querySelector('#id_lines-__prefix__-invoice');
        if (!emptyForm) return;
        
        const parent = emptyForm.closest('form');
        const html = `
            <input type="hidden" name="lines-${index}-id" id="id_lines-${index}-id">
            <input type="hidden" name="lines-${index}-payment" id="id_lines-${index}-payment">
            <td>
                <select name="lines-${index}-invoice" id="id_lines-${index}-invoice" class="form-select form-select-sm">
                    ${document.getElementById('id_lines-__prefix__-invoice').innerHTML}
                </select>
            </td>
            <td>
                <input type="number" name="lines-${index}-applied_amount" step="0.01" id="id_lines-${index}-applied_amount" class="form-control form-control-sm">
            </td>
            <td>
                <input type="number" name="lines-${index}-discount_taken" step="0.01" id="id_lines-${index}-discount_taken" class="form-control form-control-sm">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger btn-action delete-line" 
                        title="Delete this allocation" data-delete-field="id_lines-${index}-DELETE">
                    <i class="fe fe-trash"></i>
                </button>
                <input type="hidden" name="lines-${index}-DELETE" id="id_lines-${index}-DELETE">
            </td>
        `;
        
        newForm.innerHTML = html;
        tbody.appendChild(newForm);
        totalForms.value = index + 1;
        
        setupDeleteButtons();
    });

    setupDeleteButtons();
})();
</script>
{% endblock extra_js %}
