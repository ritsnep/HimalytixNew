{% extends 'accounting/_list_base.html' %}
{% load static %}

{% block title %}Tax Authorities{% endblock %}
{% block breadcrumb %}Tax Authorities{% endblock %}
{% block add_url %}{% url 'accounting:tax_authority_create' %}{% endblock %}

{% block list_header %}
<h4 class="card-title">Tax Authorities</h4>
{% endblock %}

{% block create_button %}
<div class="d-flex align-items-center gap-2 flex-wrap">
  <a href="{% url 'accounting:tax_authority_create' %}" class="btn btn-success btn-sm">
    <i class="mdi mdi-plus me-1"></i> New Tax Authority
  </a>
  <div class="input-group input-group-sm" style="width: 320px;">
    <label class="input-group-text" for="bulk-action">Bulk</label>
    <select id="bulk-action" name="action" class="form-select form-select-sm" form="bulk-action-form">
      <option value="">Select action</option>
      <option value="activate">Mark Active</option>
      <option value="deactivate">Mark Inactive</option>
    </select>
    <button id="bulk-action-apply" type="submit" class="btn btn-outline-primary" form="bulk-action-form">Apply</button>
  </div>
</div>
{% endblock %}

{% block table_head %}
<thead>
  <tr>
    <th class="no-search no-export" style="width:30px;"><input type="checkbox" id="select-all" class="form-check-input form-check-sm"></th>
    <th>Code</th>
    <th>Name</th>
    <th>Description</th>
    <th>Action</th>
  </tr>
</thead>
{% endblock %}

{% block table_body %}
<tbody>
  {% for t in tax_authorities %}
  <tr data-pk="{{ t.pk }}">
    <td><input type="checkbox" class="form-check-input row-select" name="selected_ids" value="{{ t.pk }}" form="bulk-action-form"></td>
    <td>{{ t.code }}</td>
    <td>{{ t.name }}</td>
    <td>{{ t.description }}</td>
    <td>
      <a href="{% url 'accounting:tax_authority_update' t.pk %}" class="btn btn-sm btn-primary">Edit</a>
    </td>
  </tr>
  {% empty %}
  <tr><td colspan="5">No tax authorities found.</td></tr>
  {% endfor %}
</tbody>
{% endblock %} 

  {% block custom_filters %}
  <form id="bulk-action-form" method="post">
    {% csrf_token %}
  </form>
  {% endblock %}

  {% block extra_js %}
  <script id="datatable-config" type="application/json">
  {
    "columnDefs": [
      {"targets": [0, -1], "orderable": false, "searchable": false}
    ]
  }
  </script>
  {{ block.super }}
  <script>
    $(function() {
      var selectAll = $('#select-all');
      var rowChecks = $('input.row-select');
      var actionSelect = $('#bulk-action');
      var applyBtn = $('#bulk-action-apply');

      function syncSelectAll() {
        var checkedCount = rowChecks.filter(':checked').length;
        selectAll.prop('checked', checkedCount > 0 && checkedCount === rowChecks.length);
      }

      selectAll.on('change', function() {
        rowChecks.prop('checked', $(this).is(':checked'));
      });

      rowChecks.on('change', syncSelectAll);

      applyBtn.on('click', function(e) {
        if (!actionSelect.val()) {
          e.preventDefault();
          alert('Choose a bulk action to apply.');
          return;
        }
        if (!rowChecks.filter(':checked').length) {
          e.preventDefault();
          alert('Select at least one item.');
        }
      });
    });
  </script>
  {% endblock %}