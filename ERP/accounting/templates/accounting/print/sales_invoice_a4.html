{% extends "base.html" %}
{% load static %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block extra_css %}
<style>
  .invoice-shell {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px;
    border: 1px solid #e5e7eb;
    background: #fff;
  }
  .logo {
    max-height: 64px;
  }
  .table-tight td, .table-tight th {
    padding: 0.35rem 0.5rem;
  }
  @media print {
    body { background: #fff; }
    .no-print { display: none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="no-print text-end my-3">
  <button class="btn btn-primary" onclick="window.print()">Print</button>
  <a class="btn btn-outline-secondary" href="{% url 'accounting:sales_invoice_list' %}">Back to list</a>
</div>

<div class="invoice-shell shadow-sm">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      {% if invoice_logo_url %}
      <img src="{{ invoice_logo_url }}" alt="Logo" class="logo mb-2">
      {% else %}
      <h4 class="mb-1">{{ organization.name }}</h4>
      {% endif %}
      <div class="small text-muted">
        <div>{{ organization.address|default_if_none:"" }}</div>
        <div>PAN/VAT: {{ organization.tax_id|default:"N/A" }}</div>
      </div>
    </div>
    <div class="text-end">
      <h5 class="text-uppercase mb-1">Sales Invoice</h5>
      <div><strong>Invoice #:</strong> {{ invoice.invoice_number }}</div>
      <div><strong>Date:</strong> {{ invoice.invoice_date }}</div>
      <div><strong>Due:</strong> {{ invoice.due_date }}</div>
      {% if invoice.reference_number %}<div><strong>Reference:</strong> {{ invoice.reference_number }}</div>{% endif %}
    </div>
  </div>

  <hr>

  <div class="row mb-3">
    <div class="col-md-6">
      <h6 class="mb-1">Bill To</h6>
      <div>{{ invoice.customer_display_name }}</div>
      {% if invoice.customer %}
      <div class="small text-muted">{{ invoice.customer.address|default_if_none:"" }}</div>
      <div class="small">Customer VAT/PAN: {{ invoice.customer.tax_id|default:"N/A" }}</div>
      {% endif %}
    </div>
    <div class="col-md-6 text-md-end">
      <h6 class="mb-1">Payment</h6>
      <div>Currency: {{ invoice.currency.currency_code }}</div>
      <div>Payment Term: {{ invoice.payment_term|default:"N/A" }}</div>
      <div>Status: {{ invoice.status|capfirst }}</div>
    </div>
  </div>

  <table class="table table-bordered table-tight align-middle">
    <thead class="table-light">
      <tr>
        <th style="width:4%">#</th>
        <th>Description</th>
        <th class="text-end" style="width:8%">Qty</th>
        <th class="text-end" style="width:12%">Rate</th>
        <th class="text-end" style="width:10%">Discount</th>
        <th class="text-end" style="width:12%">Tax</th>
        <th class="text-end" style="width:14%">Line Total</th>
      </tr>
    </thead>
    <tbody>
      {% for line in lines %}
      <tr>
        <td>{{ line.line_number }}</td>
        <td>
          <div>{{ line.description }}</div>
          {% if line.product_code %}<div class="small text-muted">Code: {{ line.product_code }}</div>{% endif %}
        </td>
        <td class="text-end">{{ line.quantity }}</td>
        <td class="text-end">{{ line.unit_price|floatformat:2 }}</td>
        <td class="text-end">{{ line.discount_amount|floatformat:2 }}</td>
        <td class="text-end">
          {{ line.tax_amount|floatformat:2 }}
          {% if tax_breakdown[line.pk] %}
          <div class="small text-muted">
            {% for comp in tax_breakdown[line.pk] %}
              {{ comp.code }}: {{ comp.amount|floatformat:2 }}{% if not forloop.last %}<br>{% endif %}
            {% endfor %}
          </div>
          {% elif line.tax_code %}
          <div class="small text-muted">{{ line.tax_code.code }}</div>
          {% endif %}
        </td>
        <td class="text-end">{{ line.line_total|add:line.tax_amount|floatformat:2 }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="row justify-content-end">
    <div class="col-md-5">
      <table class="table table-sm mb-0">
        <tr>
          <td class="text-end"><strong>Subtotal</strong></td>
          <td class="text-end" style="width: 35%">{{ invoice.subtotal|floatformat:2 }}</td>
        </tr>
        <tr>
          <td class="text-end"><strong>Tax</strong></td>
          <td class="text-end">{{ invoice.tax_total|floatformat:2 }}</td>
        </tr>
        <tr class="table-light">
          <td class="text-end"><strong>Total</strong></td>
          <td class="text-end fw-bold">{{ invoice.total|floatformat:2 }}</td>
        </tr>
      </table>
    </div>
  </div>

  {% if invoice.notes %}
  <div class="mt-3">
    <strong>Notes:</strong>
    <div class="small text-muted">{{ invoice.notes }}</div>
  </div>
  {% endif %}

  <div class="mt-3 small text-muted">
    Nepal VAT (13%) or local multi-tax amounts are shown above per line. Generated on {{ invoice.created_at|date:"Y-m-d H:i" }}.
  </div>
</div>
{% endblock %}
