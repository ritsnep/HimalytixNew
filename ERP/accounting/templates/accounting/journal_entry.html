{% extends "partials/base.html" %}
{% load static %}

{% block title %}Journal Entry{% endblock title %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'accounting/css/voucher_entry.css' %}">
<link rel="stylesheet" href="{% static 'accounting/css/voucher_entry_dason.css' %}">
<style>
  #journal-debug-panel {
    font-size: 0.9rem;
  }
  #journal-debug-panel pre {
    background-color: #f8f9fa;
    border-radius: 0.35rem;
    padding: 0.75rem;
    max-height: 260px;
    overflow: auto;
    font-family: var(--bs-font-monospace, SFMono-Regular, Consolas, 'Liberation Mono', monospace);
    white-space: pre-wrap;
    margin-bottom: 0;
  }
  #journal-debug-entries {
    max-height: 320px;
    overflow-y: auto;
  }
</style>
{% endblock extra_css %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
{% endblock extra_js %}

{% block content %}
<div class="main-content">
  <div class="page-content py-3 py-md-4">
    <div class="container-fluid px-2 px-md-3 journal-entry-page">
      {# Hidden CSRF token for JavaScript fetch requests #}
      {% csrf_token %}
      
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-flex align-items-center justify-content-between">
            <h4 class="mb-0">Journal Entry</h4>
            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'accounting:voucher_list' %}">Vouchers</a></li>
                <li class="breadcrumb-item active">Journal Entry</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <!-- In-page alert region (messages appear just below the top bar) -->
      <div id="app-alerts" class="mb-3" aria-live="polite" aria-atomic="true"></div>

      {% if journal_debug_enabled %}
      <div id="journal-debug-panel" class="card border border-warning mb-3" role="region" aria-label="Journal entry debug log">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <strong>Save Debugging</strong>
            <span class="text-muted d-block small">Every request & response is captured here while debug mode is enabled.</span>
          </div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Debug log actions">
            <button type="button" class="btn btn-outline-secondary" id="journal-debug-copy">Copy</button>
            <button type="button" class="btn btn-outline-secondary" id="journal-debug-download">Download</button>
            <button type="button" class="btn btn-outline-secondary" id="journal-debug-clear">Clear</button>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="journal-debug-entries" class="debug-log-entries" aria-live="polite"></div>
        </div>
      </div>
      {% endif %}

    <!-- Main Content Card -->
    <div class="journal-entry-shell">
      <div class="row g-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div
                class="container-fluid px-2 px-md-3"
                id="journal-app"
                data-row-endpoint="{{ row_endpoint }}"
                data-header-endpoint="{{ header_partial_endpoint }}"
                data-lines-endpoint="{{ lines_partial_endpoint }}"
                data-side-panel-endpoint="{{ side_panel_endpoint }}"
                data-add-row-endpoint="{{ add_row_endpoint }}"
                data-duplicate-row-endpoint="{{ duplicate_row_endpoint }}"
                data-bulk-add-endpoint="{{ bulk_add_rows_endpoint }}"
                data-lookup-account="{{ lookup_urls.account }}"
                data-lookup-cost-center="{{ lookup_urls.costCenter }}"
                data-auto-balance-endpoint="{{ auto_balance_endpoint }}"
                data-initial-journal-id="{{ initial_journal_id }}"
                data-ui-preferences="{{ ui_preferences_json|escapejs }}"
                data-line-density="{{ line_density }}"
              >
                <div id="app-alerts" class="mb-3" aria-live="polite" aria-atomic="true"></div>

                <div class="row">
                  <div class="col-md-8 pe-md-4" id="journal-main">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                      <button
                        type="button"
                        id="auto-balance"
                        class="btn btn-sm btn-secondary"
                        data-auto-balance-endpoint="{{ auto_balance_endpoint }}"
                        data-auto-balance-enabled="{{ auto_balance_enabled|yesno:'true,false' }}"
                        {% if not auto_balance_enabled %}disabled{% endif %}
                      >
                        Auto Balance
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#column-manager-modal"
                      >
                        Column Manager
                      </button>
                    </div>
                    <div
                      id="journal-header"
                      hx-get="{{ header_partial_endpoint }}"
                      hx-trigger="load"
                      hx-target="#journal-header"
                      hx-swap="innerHTML"
                      hx-vals='{"journalId": "{{ initial_journal_id }}"}'
                    ></div>
                    <div
                      id="lines-section"
                      hx-get="{{ lines_partial_endpoint }}"
                      hx-trigger="load"
                      hx-target="#lines-section"
                      hx-swap="innerHTML"
                      hx-vals='{"journalId": "{{ initial_journal_id }}"}'
                    ></div>
                  </div>
                  <div
                    class="col-md-4"
                    id="journal-sidebar"
                    hx-get="{{ side_panel_endpoint }}"
                    hx-trigger="load"
                    hx-target="#journal-sidebar"
                    hx-swap="innerHTML"
                    hx-vals='{"journalId": "{{ initial_journal_id }}"}'
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>
<!-- END main-content -->
<div
  class="modal fade"
  id="column-manager-modal"
  tabindex="-1"
  aria-labelledby="columnManagerLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable">
    <form
      id="column-manager-form"
      class="modal-content"
      hx-post="{{ prefs_save_endpoint }}"
      hx-target="#app-alerts"
      hx-swap="innerHTML"
    >
      {% csrf_token %}
      <input type="hidden" name="preferences" id="column-manager-payload">
      <div class="modal-header">
        <h5 class="modal-title" id="columnManagerLabel">Column Manager</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Reorder columns or toggle their visibility for the lines grid.</p>
        <div class="mb-3">
          <label class="form-label small mb-1" for="column-density-select">Row density</label>
          <select class="form-select form-select-sm" id="column-density-select">
            <option value="comfortable">Comfortable</option>
            <option value="compact">Compact</option>
          </select>
        </div>
        <ul class="list-group list-group-flush" id="column-manager-list" role="list"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-sm btn-primary">Save preferences</button>
      </div>
    </form>
  </div>
</div>
<script src="{% static 'libs/htmx.org/dist/htmx.min.js' %}" defer></script>
<script>window.disableLegacyVoucherEntry = true;</script>
<!-- Keep voucher_entry.js for features not yet migrated; ensure it loads after HTMX -->
<script src="{% static 'accounting/js/voucher_entry.js' %}" defer></script>
<script src="{% static 'accounting/js/journal_grid.js' %}" defer></script>

{# Removed in-page config modal; users are redirected to a dedicated selection page instead. #}
{% endblock content %}
