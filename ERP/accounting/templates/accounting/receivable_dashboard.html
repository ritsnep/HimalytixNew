{% extends "base.html" %}
{% block page_title %}Receivable Dashboard{% endblock page_title %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Receivable Dashboard</h4>
    <small class="text-muted">Snapshot as of {{ as_of_date|date:"Y-m-d" }}</small>
  </div>
  <form class="d-flex gap-2" method="get">
    <label for="as_of_date" class="sr-only">As of</label>
    <input id="as_of_date" type="date" name="as_of_date" value="{{ as_of_date|date:"Y-m-d" }}" class="form-control form-control-sm" />
    <button type="submit" class="btn btn-primary btn-sm">Refresh</button>
  </form>
</div>
{% endblock %}

{% block page_content %}
<div class="row gy-3">
  <div class="col-md-6">
    <div class="card border-primary">
      <div class="card-body">
        <p class="text-muted mb-1">Grand Outstanding</p>
        <h3 class="fw-bold mb-0">{{ receivable_total|floatformat:2 }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card border-info">
      <div class="card-body">
        <p class="text-muted mb-1">Open invoices</p>
        <h3 class="fw-bold mb-0">{{ receivable_rows|length }}</h3>
      </div>
    </div>
  </div>
</div>

<div class="row gy-3 mt-3">
  {% for bucket in receivable_buckets %}
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <p class="text-muted mb-1 small">{{ bucket.label }}</p>
        <h5 class="fw-semibold mb-0">{{ bucket.total|floatformat:2 }}</h5>
        <small class="text-muted">{{ bucket.count }} invoices</small>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12">
    <div class="alert alert-secondary">No receivables found for the selected date.</div>
  </div>
  {% endfor %}
</div>

<div class="card mt-4">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Invoice</th>
            <th>Customer</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Currency</th>
            <th class="text-end">Outstanding</th>
            <th>Days Overdue</th>
            <th>Last Reminder</th>
          </tr>
        </thead>
        <tbody>
          {% for row in receivable_rows %}
          <tr>
            <td>{{ row.invoice_number }}</td>
            <td>{{ row.customer }}</td>
            <td>{{ row.due_date }}</td>
            <td>{{ row.status|capfirst }}</td>
            <td>{{ row.currency }}</td>
            <td class="text-end">{{ row.outstanding|floatformat:2 }}</td>
            <td>{{ row.days_overdue }}</td>
            <td>
              {% if row.last_reminder %}
              <div>{{ row.last_reminder.channel|capfirst }}</div>
              <small class="text-muted">Sent {{ row.last_reminder.sent_at }}</small>
              {% else %}
              <span class="text-muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No outstanding invoices.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
