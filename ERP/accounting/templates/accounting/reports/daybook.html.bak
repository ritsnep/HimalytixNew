{% extends "accounting/reports/report_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Daybook Report" %}{% endblock %}

{% block extra_css %}
<style>
    .daybook-container {
        min-height: 100vh;
        background: #f8f9fa;
        padding-bottom: 1rem;
    }
    
    .container-fluid {
        max-width: 100%;
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .daybook-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 0;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .daybook-header h1 {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 0.15rem;
    }
    
    .daybook-header .subtitle {
        font-size: 0.8rem;
        opacity: 0.9;
    }
    
    .filter-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .filter-card .filter-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label.small {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .stat-card:hover {
        transform: translateY(-1px);
    }
    
    .stat-card .stat-label {
        font-size: 0.7rem;
        color: #718096;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 0.15rem;
    }
    
    .stat-card .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2d3748;
        line-height: 1.2;
    }
    
    .stat-card .stat-icon {
        width: 35px;
        height: 35px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }
    
    .stat-card.debit .stat-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .stat-card.credit .stat-icon {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .stat-card.balance .stat-icon {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .stat-card.transactions .stat-icon {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .daybook-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 0.75rem;
    }
    
    .daybook-table-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .daybook-table-header h3 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .export-buttons {
        display: flex;
        gap: 0.375rem;
    }
    
    .export-buttons .btn {
        padding: 0.25rem 0.5rem;
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.1);
        color: white;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 0.75rem;
    }
    
    .export-buttons .btn:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
    }
    
    .daybook-table {
        width: 100%;
        margin: 0;
    }
    
    .daybook-table thead {
        background: #f7fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .daybook-table thead th {
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .daybook-table tbody tr {
        transition: background-color 0.2s;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .daybook-table tbody tr:hover {
        background-color: #f7fafc;
    }
    
    .daybook-table tbody td {
        padding: 0.5rem 0.75rem;
        color: #4a5568;
        font-size: 0.85rem;
    }
    
    .daybook-table .voucher-link {
        color: #667eea;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.2s;
    }
    
    .daybook-table .voucher-link:hover {
        color: #764ba2;
        text-decoration: underline;
    }
    
    .daybook-table .account-info {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }
    
    .daybook-table .account-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: #2d3748;
        font-size: 0.8rem;
    }
    
    .daybook-table .account-name {
        color: #718096;
        font-size: 0.75rem;
    }
    
    .daybook-table .amount {
        font-weight: 600;
        font-family: 'Courier New', monospace;
    }
    
    .daybook-table .amount.debit {
        color: #e53e3e;
    }
    
    .daybook-table .amount.credit {
        color: #38a169;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge.draft {
        background: #fef5e7;
        color: #d68910;
    }
    
    .status-badge.awaiting_approval {
        background: #ebf4ff;
        color: #3182ce;
    }
    
    .status-badge.approved {
        background: #e6f7ed;
        color: #2f855a;
    }
    
    .status-badge.posted {
        background: #e6fffa;
        color: #047857;
    }
    
    .status-badge.rejected {
        background: #fff5f5;
        color: #c53030;
    }
    
    .table-footer {
        background: #f7fafc;
        padding: 0.75rem 1rem;
        border-top: 2px solid #e2e8f0;
    }
    
    .table-footer .totals {
        display: flex;
        justify-content: flex-end;
        gap: 2rem;
    }
    
    .table-footer .total-item {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    
    .table-footer .total-label {
        font-size: 0.75rem;
        color: #718096;
        font-weight: 500;
        margin-bottom: 0.15rem;
    }
    
    .table-footer .total-value {
        font-size: 1.2rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
    }
    
    .table-footer .total-value.debit {
        color: #e53e3e;
    }
    
    .table-footer .total-value.credit {
        color: #38a169;
    }
    
    .table-footer .total-value.balanced {
        color: #2d3748;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #718096;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }
    
    @media print {
        .filter-card, .daybook-header .subtitle, .export-buttons, .btn {
            display: none !important;
        }
        .daybook-header {
            background: white;
            color: black;
            padding: 1rem 0;
        }
        .daybook-table-container {
            box-shadow: none;
        }
    }
</style>
{% endblock %}

{% block report_body %}
<div class="daybook-container">
    <!-- Header Section -->
    <div class="daybook-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="fas fa-calendar-alt me-2"></i>
                        {% trans "Daybook Report" %}
                    </h1>
                    <p class="subtitle mb-0">
                        {% trans "Chronological record of all transactions" %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'accounting:report_list' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        {% trans "Back" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Filter Card -->
        <div class="filter-card">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                {% trans "Filters" %}
            </div>
            <form method="get" class="row g-2">
                <div class="col-md-2">
                    <label for="start_date" class="form-label small">{% trans "Start Date" %}</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" 
                           class="form-control form-control-sm" required>
                </div>
                <div class="col-md-2">
                    <label for="end_date" class="form-label small">{% trans "End Date" %}</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" 
                           class="form-control form-control-sm" required>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label small">{% trans "Status" %}</label>
                    <select name="status" id="status" class="form-select form-select-sm">
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if value == status %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="journal_type" class="form-label small">{% trans "Type" %}</label>
                    <select name="journal_type" id="journal_type" class="form-select form-select-sm">
                        <option value="">{% trans "All Types" %}</option>
                        {% for jtype in journal_types %}
                            <option value="{{ jtype.code }}" {% if jtype.code == journal_type %}selected{% endif %}>
                                {{ jtype.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="account_id" class="form-label small">{% trans "Account" %}</label>
                    <select name="account_id" id="account_id" class="form-select form-select-sm">
                        <option value="">{% trans "All Accounts" %}</option>
                        {% for account in accounts %}
                            <option value="{{ account.id }}" {% if account.id|stringformat:"s" == account_id %}selected{% endif %}>
                                {{ account.account_code }} - {{ account.account_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="voucher_number" class="form-label small">{% trans "Voucher #" %}</label>
                    <input type="text" id="voucher_number" name="voucher_number" value="{{ voucher_number }}" 
                           class="form-control form-control-sm" placeholder="{% trans 'Search' %}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <a href="{% url 'accounting:report_daybook' %}" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
            </form>
        </div>

        {% if error %}
            <div class="alert alert-danger alert-sm py-2" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            </div>
        {% endif %}

        {% if report_data %}
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card debit">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div>
                        <div class="stat-label">{% trans "Total Debits" %}</div>
                        <div class="stat-value">{{ report_data.totals.debit|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="stat-card credit">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div>
                        <div class="stat-label">{% trans "Total Credits" %}</div>
                        <div class="stat-value">{{ report_data.totals.credit|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="stat-card balance">
                    <div class="stat-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div>
                        <div class="stat-label">{% trans "Balance" %}</div>
                        <div class="stat-value">{{ report_data.totals.balance|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="stat-card transactions">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div>
                        <div class="stat-label">{% trans "Transactions" %}</div>
                        <div class="stat-value">{{ report_data.totals.transaction_count }}</div>
                    </div>
                </div>
            </div>

            <!-- Daybook Table -->
            <div class="daybook-table-container">
                <div class="daybook-table-header">
                    <h3>
                        <i class="fas fa-list-ul me-2"></i>
                        {% trans "Transaction Details" %}
                    </h3>
                    <div class="export-buttons">
                        <a href="?{{ request.GET.urlencode }}&export=csv" class="btn">
                            <i class="fas fa-file-csv me-1"></i> CSV
                        </a>
                        <a href="?{{ request.GET.urlencode }}&export=excel" class="btn">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="?{{ request.GET.urlencode }}&export=pdf" class="btn">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                        <button onclick="window.print()" class="btn">
                            <i class="fas fa-print me-1"></i> Print
                        </button>
                    </div>
                </div>

                {% if report_data.rows %}
                    <div class="table-responsive">
                        <table class="daybook-table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">{% trans "Date" %}</th>
                                    <th style="width: 130px;">{% trans "Voucher #" %}</th>
                                    <th style="width: 120px;">{% trans "Type" %}</th>
                                    <th style="width: 150px;">{% trans "Account" %}</th>
                                    <th>{% trans "Description" %}</th>
                                    <th style="width: 130px;" class="text-end">{% trans "Debit" %}</th>
                                    <th style="width: 130px;" class="text-end">{% trans "Credit" %}</th>
                                    <th style="width: 100px;" class="text-center">{% trans "Status" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in report_data.rows %}
                                    <tr>
                                        <td>{{ row.journal_date|date:"Y-m-d" }}</td>
                                        <td>
                                            <a href="{% url 'accounting:journal_detail' row.journal_id %}" 
                                               class="voucher-link" target="_blank">
                                                {{ row.journal_number }}
                                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7rem;"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ row.journal_type }}</span>
                                        </td>
                                        <td>
                                            <div class="account-info">
                                                <span class="account-code">{{ row.account_code }}</span>
                                                <span class="account-name">{{ row.account_name }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 300px;" title="{{ row.description }}">
                                                {{ row.description|default:"—" }}
                                            </div>
                                            {% if row.department or row.project %}
                                                <div class="text-muted small mt-1">
                                                    {% if row.department %}
                                                        <span class="me-2">
                                                            <i class="fas fa-building"></i> {{ row.department }}
                                                        </span>
                                                    {% endif %}
                                                    {% if row.project %}
                                                        <span>
                                                            <i class="fas fa-project-diagram"></i> {{ row.project }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if row.debit > 0 %}
                                                <span class="amount debit">{{ row.debit|floatformat:2 }}</span>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if row.credit > 0 %}
                                                <span class="amount credit">{{ row.credit|floatformat:2 }}</span>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <span class="status-badge {{ row.status }}">
                                                {{ row.status|title }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="table-footer">
                        <div class="totals">
                            <div class="total-item">
                                <div class="total-label">{% trans "Total Debits" %}</div>
                                <div class="total-value debit">{{ report_data.totals.debit|floatformat:2 }}</div>
                            </div>
                            <div class="total-item">
                                <div class="total-label">{% trans "Total Credits" %}</div>
                                <div class="total-value credit">{{ report_data.totals.credit|floatformat:2 }}</div>
                            </div>
                            <div class="total-item">
                                <div class="total-label">{% trans "Difference" %}</div>
                                <div class="total-value balanced">{{ report_data.totals.balance|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h4>{% trans "No transactions found" %}</h4>
                        <p>{% trans "Try adjusting your filters or date range." %}</p>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="daybook-table-container">
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h4>{% trans "Ready to generate" %}</h4>
                    <p>{% trans "Select your filters above and click 'Generate Report' to view daybook entries." %}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
