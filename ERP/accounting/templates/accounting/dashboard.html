{% extends "base.html" %}
{% block page_title %}Finance Dashboard{% endblock page_title %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Finance Dashboard</h4>
  {% if not error %}
  <a href="{{ export_url }}" class="btn btn-outline-primary">Export CSV</a>
  {% endif %}
</div>
{% endblock %}

{% block page_content %}
<div class="row">
  <div class="col-xl-12">
    <div class="card">
      <div class="card-body">
        {% if error %}
          <div class="alert alert-warning mb-0">{{ error }}</div>
        {% else %}
          <div class="row gy-3">
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">AP Aging</p>
                <h5 class="mb-0">{{ metrics.ap_aging.total }}</h5>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">AR Outstanding</p>
                <h5 class="mb-0">{{ metrics.ar_aging.ar_outstanding }}</h5>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">Cash Balance</p>
                <h5 class="mb-0">{{ metrics.cash.cash_balance }}</h5>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h6 class="fw-semibold">AP Aging Detail</h6>
            {% if metrics.ap_aging_detail.rows %}
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Vendor</th>
                    {% for header in metrics.ap_aging_detail.headers %}
                    <th>{{ header }}</th>
                    {% endfor %}
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in metrics.ap_aging_detail.rows %}
                  <tr>
                    <td>{{ row.vendor_name }}</td>
                    {% for amount in row.buckets %}
                    <td>{{ amount }}</td>
                    {% endfor %}
                    <td>{{ row.total }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No outstanding vendor balances at this time.</p>
            {% endif %}
          </div>

          <div class="row mt-4 gy-3">
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">Budget Variance</p>
                <div>Budget: {{ metrics.budget_variance.total_budget }}</div>
                <div>Actual: {{ metrics.budget_variance.total_actual }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">Assets</p>
                <div>Book value: {{ metrics.assets.book_value }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <p class="text-muted mb-1">Tax Liabilities</p>
                <div>Payable: {{ metrics.tax_liabilities.total_payable }}</div>
                <div>Receivable: {{ metrics.tax_liabilities.total_receivable }}</div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h6 class="fw-semibold">Budget Variance Detail</h6>
            <div class="table-responsive">
              <table class="table">
                <thead class="table-light"><tr><th>Account</th><th>Budget</th><th>Actual</th><th>Variance</th></tr></thead>
                <tbody>
                {% for row in metrics.budget_variance.variances %}
                <tr>
                  <td>{{ row.account }}</td>
                  <td>{{ row.budget }}</td>
                  <td>{{ row.actual }}</td>
                  <td>{{ row.variance }}</td>
                </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
