{% extends 'components/base/form_base.html' %}
{% load static i18n %}

{% block page_title %}{% trans "Delivery Note" %}{% endblock %}

{% block form_content %}
<form method="post" id="delivery-note-form" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Header Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h5 class="mb-3">{% trans "Delivery Information" %}</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.delivery_date.id_for_label }}" class="form-label">
                        {% trans "Delivery Date" %} <span class="text-danger">*</span>
                    </label>
                    {{ form.delivery_date }}
                    {% if form.delivery_date.errors %}
                        <div class="invalid-feedback d-block">{{ form.delivery_date.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.note_number.id_for_label }}" class="form-label">
                        {% trans "Note Number" %}
                    </label>
                    {{ form.note_number }}
                    {% if form.note_number.errors %}
                        <div class="invalid-feedback d-block">{{ form.note_number.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="mb-3">
                <label for="{{ form.customer.id_for_label }}" class="form-label">
                    {% trans "Customer" %} <span class="text-danger">*</span>
                </label>
                {{ form.customer }}
                {% if form.customer.errors %}
                    <div class="invalid-feedback d-block">{{ form.customer.errors }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.warehouse.id_for_label }}" class="form-label">
                    {% trans "Warehouse" %} <span class="text-danger">*</span>
                </label>
                {{ form.warehouse }}
                {% if form.warehouse.errors %}
                    <div class="invalid-feedback d-block">{{ form.warehouse.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-6">
            <h5 class="mb-3">{% trans "Additional Information" %}</h5>
            <div class="mb-3">
                <label for="{{ form.reference_number.id_for_label }}" class="form-label">
                    {% trans "Reference Number" %}
                </label>
                {{ form.reference_number }}
                {% if form.reference_number.errors %}
                    <div class="invalid-feedback d-block">{{ form.reference_number.errors }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.sales_order.id_for_label }}" class="form-label">
                    {% trans "Sales Order" %}
                </label>
                {{ form.sales_order }}
                {% if form.sales_order.errors %}
                    <div class="invalid-feedback d-block">{{ form.sales_order.errors }}</div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.notes.id_for_label }}" class="form-label">
                    {% trans "Notes" %}
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="invalid-feedback d-block">{{ form.notes.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Line Items -->
    <div class="mb-4">
        <h5 class="mb-3">{% trans "Line Items" %}</h5>
        <div id="line-items-container">
            {{ line_formset.management_form }}
            <div class="table-responsive">
                <table class="table table-bordered" id="line-items-table">
                    <thead class="table-light">
                        <tr>
                            <th width="5%">#</th>
                            <th width="25%">{% trans "Product" %}</th>
                            <th width="35%">{% trans "Description" %}</th>
                            <th width="15%">{% trans "Quantity" %}</th>
                            <th width="10%">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in line_formset %}
                        <tr class="line-item-row">
                            <td>
                                {{ form.line_number }}
                                {% if form.line_number.errors %}
                                    <div class="invalid-feedback d-block">{{ form.line_number.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.product }}
                                {% if form.product.errors %}
                                    <div class="invalid-feedback d-block">{{ form.product.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                    <div class="invalid-feedback d-block">{{ form.quantity.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ form.DELETE }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="add-line-item">
                <i class="mdi mdi-plus"></i> {% trans "Add Line Item" %}
            </button>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="form-shell__actions">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'accounting:delivery_note_list' %}" class="btn btn-secondary">
                    <i class="mdi mdi-arrow-left me-1"></i>{% trans "Cancel" %}
                </a>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" name="action" value="save" class="btn btn-primary">
                    <i class="mdi mdi-content-save me-1"></i>{% trans "Save as Draft" %}
                </button>
                <button type="submit" name="action" value="confirm" class="btn btn-success">
                    <i class="mdi mdi-check-circle me-1"></i>{% trans "Confirm & Dispatch" %}
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock form_content %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'libs/flatpickr/dist/flatpickr.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize date picker
    flatpickr('#{{ form.delivery_date.id_for_label }}', {
        dateFormat: 'Y-m-d',
        allowInput: true
    });

    // Add line item functionality
    $('#add-line-item').click(function() {
        var formset = $('#line-items-table tbody');
        var totalForms = $('#id_lines-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());
        var emptyForm = $('#empty-line-form').html().replace(/__prefix__/g, formNum);
        formset.append(emptyForm);
        totalForms.val(formNum + 1);
    });

    // Remove line item
    $(document).on('click', '.remove-line-item', function() {
        $(this).closest('tr').remove();
    });
});
</script>
{% endblock extra_js %}
