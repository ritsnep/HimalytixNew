{% load static %}

{% comment %}
Voucher Entry Base Template - Phase 1 Foundation

This is the base template for all voucher/journal entry operations.
It extends the main base.html and provides the structure for:
- Journal header information
- Line items table
- Error displays
- HTMX integration points

Usage:
- Extend this template in specific views
- Override blocks as needed
- Use partials for modular components
{% endcomment %}

{% extends 'base.html' %}
{% load i18n %}

{% block title %}
  {% if object %}{% trans "Edit Journal Entry" %}{% else %}{% trans "New Journal Entry" %}{% endif %}
  {% if journal_type %} - {{ journal_type }}{% endif %}
{% endblock %}

{% block page_content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-0">
        {% if object %}{% trans "Edit Journal Entry" %}{% else %}{% trans "New Journal Entry" %}{% endif %}
      </h1>
      {% if page_title %}
        <small class="text-muted">{{ page_title }}</small>
      {% endif %}
    </div>
    <div class="btn-group" role="group">
      <a href="{% url 'accounting:journal_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-list"></i> {% trans "Back to List" %}
      </a>
    </div>
  </div>

  <!-- Alerts for Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Main Form Container -->
  <form method="post" enctype="multipart/form-data" id="journal-form" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- Validation Errors Summary -->
    {% if journal_form.errors or line_formset.errors or errors %}
      {% include 'accounting/partials/validation_errors.html' %}
    {% endif %}

    <!-- Journal Header Section -->
    <div class="card mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-info-circle"></i> {% trans "Journal Information" %}
        </h5>
      </div>
      <div class="card-body">
        {% include 'accounting/partials/journal_header_form.html' %}
      </div>
    </div>

    <!-- Journal Lines Section -->
    <div class="card mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-table"></i> {% trans "Journal Lines" %}
        </h5>
        <button type="button" class="btn btn-sm btn-outline-primary"
                hx-get="{% url 'accounting:journal_htmx' action='add_line' %}"
                hx-vals='js:{form_count: document.querySelectorAll("[name*=lines-]").length / 5}'
                hx-target="#journal-lines"
                hx-swap="beforeend"
                onclick="return validateFormsBefore(this)">
          <i class="bi bi-plus-circle"></i> {% trans "Add Line" %}
        </button>
      </div>
      <div class="card-body p-0">
        {% include 'accounting/partials/journal_lines_table.html' %}
      </div>
      <div class="card-footer bg-light">
        {% include 'accounting/partials/journal_totals.html' %}
      </div>
    </div>

    <!-- Attachments Section -->
    <div class="card mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-paperclip"></i> {% trans "Attachments" %}
        </h5>
      </div>
      <div class="card-body">
        {% include 'accounting/partials/attachments_upload.html' %}
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
      <button type="button" class="btn btn-secondary"
              onclick="if(confirm('{% trans "Discard changes?" %}')) window.history.back()">
        <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
      </button>
      <div class="btn-group" role="group">
        <button type="submit" name="action" value="save" class="btn btn-primary">
          <i class="bi bi-cloud-arrow-down"></i> {% trans "Save as Draft" %}
        </button>
        <button type="submit" name="action" value="post" class="btn btn-success">
          <i class="bi bi-check-circle"></i> {% trans "Save and Post" %}
        </button>
      </div>
    </div>
  </form>
</div>

{% block scripts %}
  <script src="{% static 'accounting/js/journal_entry.js' %}"></script>
  <script src="{% static 'accounting/js/journal_validation.js' %}"></script>
{% endblock %}
{% endblock %}
