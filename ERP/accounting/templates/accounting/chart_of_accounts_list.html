{% extends 'accounting/_list_base.html' %}
{% load static %}

{% block title %}Chart of Accounts{% endblock %}
{% block breadcrumb %}Chart of Accounts{% endblock %}
{% block add_url %}{{ create_url }}{% endblock %}

{% block list_header %}
<div class="d-flex align-items-center flex-wrap gap-2">
  <h4 class="card-title mb-0">Chart of Accounts</h4>
  <div class="btn-group btn-group-sm" role="group" aria-label="Tree controls">
    <button type="button" class="btn btn-outline-secondary" id="coa-expand-all" aria-label="Expand all accounts">Expand All</button>
    <button type="button" class="btn btn-outline-secondary" id="coa-collapse-all" aria-label="Collapse all accounts">Collapse All</button>
  </div>
</div>
{% endblock %}

{% block create_button %}
<a href="{{ create_url }}" class="btn btn-success mb-2" aria-label="Add a new account">
    <i class="mdi mdi-plus me-1"></i> New Account
</a>
{% endblock %}

{% block table_head %}
<thead>
  <tr>
    <th>Code</th>
    <th>Path</th>
    <th>Name</th>
    <th>Type</th>
    <th>Status</th>
    <th>Actions</th>
  </tr>
</thead>
{% endblock %}

{% block table_body %}
<tbody>
  {% if account_tree %}
    {% include 'accounting/partials/coa_tree_rows.html' with accounts=account_tree level=0 %}
  {% else %}
    <tr><td colspan="6" class="text-center">No chart of accounts found.</td></tr>
  {% endif %}
</tbody>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script id="datatable-config" type="application/json">{
  "columnDefs": [
    {"targets": -1, "orderable": false},
    {"targets": 1, "visible": true}
  ],
  "order": [[0, "asc"]]
}</script>
<script>
// Lightweight tree toggle within the table
document.addEventListener('click', function(e){
  const btn = e.target.closest('.coa-toggle');
  if (!btn) return;
  e.preventDefault();
  const id = btn.getAttribute('data-id');
  const currentlyCollapsed = btn.getAttribute('data-collapsed') === 'true';
  const willExpand = currentlyCollapsed;
  const newState = willExpand ? 'false' : 'true';
  const showChildren = willExpand;
  btn.setAttribute('data-collapsed', newState);
  btn.setAttribute('aria-expanded', showChildren ? 'true' : 'false');
  const icon = btn.querySelector('i');
  if (icon) icon.className = showChildren ? 'mdi mdi-chevron-down' : 'mdi mdi-chevron-right';

  function setChildrenVisibility(parentId, visible){
    const rows = document.querySelectorAll('tr.coa-row[data-parent="'+parentId+'"]');
    rows.forEach(row => {
      row.style.display = visible ? '' : 'none';
      const childId = row.getAttribute('data-id');
      const childBtn = row.querySelector('.coa-toggle');
      const childCollapsed = childBtn && childBtn.getAttribute('data-collapsed') === 'true';
      if (!visible){
        setChildrenVisibility(childId, false);
      } else {
        setChildrenVisibility(childId, !childCollapsed);
      }
    });
  }

  setChildrenVisibility(id, showChildren);
});

function setAllToggles(collapsed) {
  document.querySelectorAll('.coa-toggle').forEach(btn => {
    btn.setAttribute('data-collapsed', collapsed ? 'true' : 'false');
    btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
    const icon = btn.querySelector('i');
    if (icon) icon.className = collapsed ? 'mdi mdi-chevron-right' : 'mdi mdi-chevron-down';
  });

  document.querySelectorAll('tr.coa-row').forEach(row => {
    const level = parseInt(row.getAttribute('data-level') || '0', 10);
    row.style.display = collapsed && level > 0 ? 'none' : '';
  });
}

document.getElementById('coa-expand-all')?.addEventListener('click', () => setAllToggles(false));
document.getElementById('coa-collapse-all')?.addEventListener('click', () => setAllToggles(true));
</script>
{% endblock %}
