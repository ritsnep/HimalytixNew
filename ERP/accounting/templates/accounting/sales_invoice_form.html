{% extends 'accounting/_form_base.html' %}

{% block title %}Sales Invoice{% endblock %}

{% block form_content %}
{% include "accounting/partials/sales_invoice_form_panel.html" %}
{% endblock form_content %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    const productData = JSON.parse('{{ product_data_json|escapejs }}');
    const taxCodes = JSON.parse('{{ tax_code_data_json|escapejs }}');
    const customers = JSON.parse('{{ customer_data_json|escapejs }}');
    const paymentTerms = JSON.parse('{{ payment_term_data_json|escapejs }}');

    const productLookup = Object.fromEntries(productData.map(p => [String(p.code), p]));
    const taxLookup = Object.fromEntries(taxCodes.map(t => [String(t.id), t]));
    const paymentLookup = Object.fromEntries(paymentTerms.map(t => [String(t.id), t]));
    const customerLookup = Object.fromEntries(customers.map(c => [String(c.id), c]));

    const subtotalEl = document.getElementById('subtotal-display');
    const taxEl = document.getElementById('tax-display');
    const totalEl = document.getElementById('total-display');
    const dueDateInput = document.getElementById('{{ form.due_date.id_for_label }}');
    const invoiceDateInput = document.getElementById('{{ form.invoice_date.id_for_label }}');
    const customerTaxHint = document.getElementById('customer-tax-hint');
    const productOptions = document.getElementById('product-options');

    function formatMoney(value) {
        return Number(value || 0).toFixed(2);
    }

    function populateProductOptions() {
        if (!productOptions) return;
        productData.forEach((prod) => {
            const opt = document.createElement('option');
            opt.value = prod.code;
            opt.label = `${prod.code} â€” ${prod.name}`;
            productOptions.appendChild(opt);
        });
    }

    function updateDueDate() {
        if (!invoiceDateInput || !dueDateInput) return;
        const paymentTermSelect = document.getElementById('{{ form.payment_term.id_for_label }}');
        const paymentTermId = paymentTermSelect ? paymentTermSelect.value : null;
        const seedDate = invoiceDateInput.value ? new Date(invoiceDateInput.value) : null;
        if (!paymentTermId || !seedDate || !paymentLookup[paymentTermId]) return;
        const days = paymentLookup[paymentTermId].net_due_days || 0;
        const due = new Date(seedDate);
        due.setDate(seedDate.getDate() + Number(days));
        const iso = due.toISOString().slice(0, 10);
        dueDateInput.value = iso;
    }

    function syncCustomerDefaults() {
        const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
        if (!customerSelect) return;
        const customer = customerLookup[customerSelect.value];
        if (!customer) return;
        if (customer.tax_id && customerTaxHint) {
            customerTaxHint.textContent = `Tax ID: ${customer.tax_id}`;
        }
        const paymentTermSelect = document.getElementById('{{ form.payment_term.id_for_label }}');
        if (paymentTermSelect && !paymentTermSelect.value && customer.payment_term) {
            paymentTermSelect.value = customer.payment_term;
            updateDueDate();
        }
        const currencySelect = document.getElementById('{{ form.currency.id_for_label }}');
        if (currencySelect && customer.currency) {
            currencySelect.value = customer.currency;
        }
        if (customer.revenue_account) {
            document.querySelectorAll('#line-items [name$="-revenue_account"]').forEach((sel) => {
                if (!sel.value) sel.value = customer.revenue_account;
            });
        }
    }

    function calculateLine(row) {
        const qtyInput = row.querySelector('[name$="-quantity"]');
        const priceInput = row.querySelector('[name$="-unit_price"]');
        const discountInput = row.querySelector('[name$="-discount_amount"]');
        const taxSelect = row.querySelector('[name$="-tax_codes"]');
        const taxAmountInput = row.querySelector('[name$="-tax_amount"]');
        const revenueAccountSelect = row.querySelector('[name$="-revenue_account"]');
        const productInput = row.querySelector('[name$="-product_code"]');

        const qty = parseFloat(qtyInput?.value || '0') || 0;
        const rate = parseFloat(priceInput?.value || '0') || 0;
        const discount = parseFloat(discountInput?.value || '0') || 0;
        const baseAmount = Math.max((qty * rate) - discount, 0);

        // Auto-fill revenue account from product if provided
        if (productInput && productLookup[productInput.value] && revenueAccountSelect && !revenueAccountSelect.value) {
            const income = productLookup[productInput.value].revenue_account;
            if (income) {
                revenueAccountSelect.value = income;
            }
        }

        let runningTax = 0;
        if (taxSelect) {
            if (defaultTaxId && taxSelect.selectedOptions.length === 0) {
                Array.from(taxSelect.options).forEach((opt) => {
                    if (opt.value === defaultTaxId) opt.selected = true;
                });
            }
            const selections = Array.from(taxSelect.selectedOptions);
            selections.forEach((opt) => {
                const tax = taxLookup[opt.value];
                if (!tax) return;
                const ratePct = parseFloat(tax.rate || '0') || 0;
                const taxableBase = tax.is_compound ? (baseAmount + runningTax) : baseAmount;
                const taxAmount = (taxableBase * ratePct) / 100;
                runningTax += taxAmount;
            });
        }

        if (taxAmountInput) {
            taxAmountInput.value = formatMoney(runningTax);
        }
        const lineTotal = baseAmount + runningTax;
        const lineTotalCell = row.querySelector('.line-total');
        if (lineTotalCell) {
            lineTotalCell.textContent = formatMoney(lineTotal);
        }
        return { baseAmount, runningTax, lineTotal };
    }

    function recalcTotals() {
        let subtotal = 0;
        let taxTotal = 0;
        document.querySelectorAll('#line-items .line-row').forEach((row) => {
            const { baseAmount, runningTax } = calculateLine(row);
            subtotal += baseAmount;
            taxTotal += runningTax;
        });
        if (subtotalEl) subtotalEl.textContent = formatMoney(subtotal);
        if (taxEl) taxEl.textContent = formatMoney(taxTotal);
        if (totalEl) totalEl.textContent = formatMoney(subtotal + taxTotal);
    }

    function attachRowBehavior(row) {
        const inputs = row.querySelectorAll('[name$="-quantity"], [name$="-unit_price"], [name$="-discount_amount"], [name$="-tax_codes"], [name$="-product_code"]');
        inputs.forEach((el) => {
            el.addEventListener('change', recalcTotals);
            el.addEventListener('keyup', recalcTotals);
        });
        const productField = row.querySelector('[name$="-product_code"]');
        if (productField) {
            productField.setAttribute('list', 'product-options');
        }
        const taxSelect = row.querySelector('[name$="-tax_codes"]');
        if (taxSelect && defaultTaxId && taxSelect.selectedOptions.length === 0) {
            Array.from(taxSelect.options).forEach((opt) => {
                if (opt.value === defaultTaxId) opt.selected = true;
            });
        }
    }

    function wireExistingRows() {
        document.querySelectorAll('#line-items .line-row').forEach((row) => attachRowBehavior(row));
        recalcTotals();
    }

    function addNewLine() {
        const tableBody = document.getElementById('line-items');
        const totalForms = document.getElementById('id_lines-TOTAL_FORMS');
        const template = document.getElementById('empty-line-template');
        if (!tableBody || !totalForms || !template) return;

        const nextIndex = parseInt(totalForms.value, 10);
        const clone = template.content.cloneNode(true);
        clone.querySelectorAll('[name]').forEach((element) => {
            element.name = element.name.replace('__prefix__', nextIndex);
            element.id = element.id.replace('__prefix__', nextIndex);
            if (element.type === 'checkbox') {
                element.checked = false;
            } else if (element.type !== 'hidden') {
                element.value = '';
            }
        });
        totalForms.value = nextIndex + 1;
        const newRow = clone.querySelector('tr');
        tableBody.appendChild(clone);
        const appendedRow = tableBody.querySelectorAll('tr.line-row')[tableBody.querySelectorAll('tr.line-row').length - 1];
        attachRowBehavior(appendedRow);
        recalcTotals();
    }

    function bindEvents() {
        const addBtn = document.getElementById('add-line');
        if (addBtn) addBtn.addEventListener('click', addNewLine);
        if (invoiceDateInput) invoiceDateInput.addEventListener('change', updateDueDate);
        const paymentTermSelect = document.getElementById('{{ form.payment_term.id_for_label }}');
        if (paymentTermSelect) paymentTermSelect.addEventListener('change', updateDueDate);
        const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
        if (customerSelect) customerSelect.addEventListener('change', syncCustomerDefaults);
    }

    populateProductOptions();
    bindEvents();
    wireExistingRows();
    syncCustomerDefaults();
    updateDueDate();
})();
</script>
{% endblock extra_js %}
    const defaultTax =
        taxCodes.find((t) => (t.code || "").toUpperCase().includes("VAT")) ||
        taxCodes.find((t) => Math.abs(parseFloat(t.rate || "0") - 13) < 0.0001) ||
        taxCodes[0];
    const defaultTaxId = defaultTax ? String(defaultTax.id) : null;
