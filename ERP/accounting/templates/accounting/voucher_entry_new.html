{% extends "partials/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="{% static 'accounting/voucher_entry/app.css' %}">
    <!-- Dason / Bootstrap styles are used across the site; Tailwind CDN removed to match base UI -->
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-bottom mb-4">
        <div class="container py-3">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h4 mb-0">{{ page_title }}</h1>
                    <p class="small text-muted mb-0">Create a new journal voucher entry</p>
                </div>
                <div class="col-auto">
                    <a href="{{ cancel_url }}" class="btn btn-outline-secondary btn-sm me-2">Cancel</a>
                    <button type="submit" form="voucher-form" class="btn btn-primary btn-sm">Save Draft</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Main Content -->
        <div class="container py-4 pb-5">
                <!-- App bootstrap area (aligning with Journal-Entry architecture) -->
                <div id="app" class="card ve-app mb-3"
                         data-endpoint-save="{{ htmx_endpoints.save|default:'' }}"
                         data-endpoint-submit="{{ htmx_endpoints.submit|default:'' }}"
                         data-endpoint-approve="{{ htmx_endpoints.approve|default:'' }}"
                         data-endpoint-reject="{{ htmx_endpoints.reject|default:'' }}"
                         data-endpoint-post="{{ htmx_endpoints.post|default:'' }}"
                         data-endpoint-account-lookup="{{ htmx_endpoints.account_lookup|default:'' }}"
                         data-endpoint-add-line="{{ htmx_endpoints.add_line|default:'' }}"
                         data-default-currency="{{ initial_state.currency|default:initial_state.header.currency|default:'' }}"
                         data-default-date="{{ initial_state.header.date|default:'' }}"
                         data-voucher-debug="{{ journal_debug_enabled|yesno:'1,0' }}">
                    <div class="card-body text-center py-4 text-muted">
                        <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>
                        <p class="mb-0">Loading voucher workspace...</p>
                    </div>
                </div>

                <form id="voucher-form" method="post" action="{{ form_action }}" class="relative">
            {% csrf_token %}

            <!-- Voucher Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Voucher Header</h5>
                    <div class="row">
                        {% for field in header_form %}
                            <div class="col-12 col-md-6 col-lg-3 mb-3">
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger small">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Voucher Lines Grid -->
            {% include "accounting/htmx/voucher_entry_grid.html" with lines=None accounts=accounts %}

            <!-- Form Actions (sticky footer) -->
            <div class="fixed-bottom bg-white border-top py-2">
                <div class="container d-flex justify-content-end">
                    <a href="{{ cancel_url }}" class="btn btn-outline-secondary btn-sm me-2">Cancel</a>
                    <button type="submit" class="btn btn-success btn-sm">Create Voucher</button>
                </div>
            </div>
        </form>
    </div>
</div>

{# Debug console (copied from Journal Entry UI for parity) #}
<div class="card{% if not journal_debug_enabled %} d-none{% endif %} mt-3" id="voucher-debug-panel">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <strong>Voucher Debug Console</strong>
            <small class="text-muted d-block">Recent HTMX actions & payloads</small>
        </div>
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" id="voucher-debug-copy">
                <i class="mdi mdi-content-copy"></i>Copy
            </button>
            <button type="button" class="btn btn-outline-secondary" id="voucher-debug-download">
                <i class="mdi mdi-download"></i>Download
            </button>
            <button type="button" class="btn btn-outline-danger" id="voucher-debug-clear">
                <i class="mdi mdi-trash-can-outline"></i>Clear
            </button>
        </div>
    </div>
    <div class="card-body" id="voucher-debug-entries">
        <p class="text-muted mb-0 small">Logs will appear here once actions are performed.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
{% if initial_state %}
{{ initial_state|json_script:"initial-state-data" }}
{% endif %}
<script src="{% static 'accounting/voucher_entry/app.js' %}" defer></script>
<!-- Small HTMX debug/log helper for development -->
<script>
    document.addEventListener('htmx:afterRequest', function(evt) {
        console.debug('htmx:afterRequest', evt.detail);
    });
    document.addEventListener('htmx:afterSwap', function(evt) {
        console.debug('htmx:afterSwap', evt.detail);
        // Briefly flash a small visual indicator so devs can see the swap happened
        try {
            const app = document.getElementById('app');
            const debugOn = app && app.dataset && app.dataset.voucherDebug === '1';
            if (debugOn) {
                let el = document.createElement('div');
                el.textContent = 'HTMX swap completed';
                el.style.position = 'fixed';
                el.style.bottom = '12px';
                el.style.left = '12px';
                el.style.padding = '6px 10px';
                el.style.background = 'rgba(16,185,129,0.95)';
                el.style.color = '#fff';
                el.style.borderRadius = '6px';
                el.style.zIndex = 99999;
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 800);
            }
        } catch(e) { console.warn(e); }
    });
    document.addEventListener('htmx:responseError', function(evt){
        console.error('htmx:responseError', evt.detail);
        alert('HTMX error: ' + (evt.detail.xhr && evt.detail.xhr.statusText));
    });
</script>
<script>
    // Auto-add a first line on empty grid to match Journal Entry UX
    document.addEventListener('DOMContentLoaded', function(){
        try {
            var grid = document.getElementById('grid-rows');
            if (grid && grid.children.length === 0) {
                // find an Add Line button and trigger it
                var addBtn = document.querySelector('#voucher-grid button[name="add_line"]');
                if (!addBtn) addBtn = document.querySelector('#voucher-grid button[title="Add first journal line"]');
                if (addBtn) {
                    // small timeout to let HTMX and DOM settle
                    setTimeout(function(){ addBtn.click(); }, 120);
                }
            }
        } catch(e){ console.warn('Auto-add line failed', e); }
    });
</script>
{% endblock %}
