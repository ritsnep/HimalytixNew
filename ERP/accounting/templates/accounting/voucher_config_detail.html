{% extends 'accounting/_list_base.html' %}
{% load static %}
{% load permission_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .detail-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .detail-section h5 {
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .status-badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .feature-list {
        list-style: none;
        padding: 0;
    }
    
    .feature-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .feature-list li:last-child {
        border-bottom: none;
    }
    
    .feature-list i {
        width: 20px;
        text-align: center;
        margin-right: 0.5rem;
    }
    
    .udf-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }
    
    .udf-card:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .default-line-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff;
    }
    
    .default-line-card:hover {
        border-color: #28a745;
        background: #f8fff9;
    }
    
    .action-buttons {
        position: sticky;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="main-content">
    <div class="page-content">
<div class="container-fluid">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if breadcrumb.1 %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.1 }}">{{ breadcrumb.0 }}</a></li>
                {% else %}
                    <li class="breadcrumb-item active">{{ breadcrumb.0 }}</li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">{{ config.name }}</h2>
            <p class="text-muted mb-0">{{ config.description|default:"Voucher Configuration Details" }}</p>
        </div>
        <div class="action-buttons">
            <div class="btn-group" role="group">
                {% if user|has_permission:'accounting_journal_add' %}
                <a href="{% url 'accounting:voucher_wizard' %}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Create Voucher
                </a>
                {% else %}
                <button class="btn btn-success" title="No permission to create voucher" disabled><i class="fas fa-plus me-1"></i>Create Voucher</button>
                {% endif %}
                {% if user|has_permission:'accounting_vouchermodeconfig_change' %}
                <a href="{% url 'accounting:voucher_config_update' config.pk %}" class="btn btn-primary">
                    <i class="fas fa-edit me-1"></i>Edit
                </a>
                {% else %}
                <button class="btn btn-primary" title="No permission to edit" disabled><i class="fas fa-edit me-1"></i>Edit</button>
                {% endif %}
                <a href="{% url 'accounting:voucher_config_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back
                </a>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
        {% if perms.forms_designer.change_voucherschema %}
            <a href="{% url 'forms_designer:designer' config.config_id %}" class="btn btn-outline-success" title="Design the entry form for this voucher config">
                <i class="bi bi-pencil-square"></i> Design Form
            </a>
        {% else %}
            <button class="btn btn-outline-success" title="No permission to design form" disabled><i class="bi bi-pencil-square"></i> Design Form</button>
        {% endif %}
        {% if perms.forms_designer.view_voucherschema %}
            <a href="{% url 'forms_designer:preview' config.config_id %}" class="btn btn-outline-primary ms-2" title="Preview the entry form for this voucher config">
                <i class="bi bi-eye"></i> Preview
            </a>
        {% else %}
            <button class="btn btn-outline-primary ms-2" title="No permission to preview" disabled><i class="bi bi-eye"></i> Preview</button>
        {% endif %}
        <a href="{% url 'accounting:voucher_udf_list' %}?config_id={{ config.pk }}" class="btn btn-outline-info ms-2">Manage UDFs</a>
    </div>

    <div class="row">
        <!-- Main Configuration Details -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="detail-section">
                <h5><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Name:</th>
                                <td><strong>{{ config.name }}</strong></td>
                            </tr>
                            <tr>
                                <th>Journal Type:</th>
                                <td>
                                    <span class="badge bg-info status-badge">{{ config.journal_type.name }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Layout Style:</th>
                                <td>
                                    <span class="badge bg-secondary status-badge">{{ config.get_layout_style_display }}</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Default Currency:</th>
                                <td>
                                    <span class="badge bg-success status-badge">{{ config.default_currency }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if config.is_default %}
                                        <span class="badge bg-primary status-badge">Default</span>
                                    {% endif %}
                                    {% if config.is_active %}
                                        <span class="badge bg-success status-badge">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger status-badge">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td>{{ config.created_at|date:"M d, Y" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if config.description %}
                <div class="mt-3">
                    <strong>Description:</strong>
                    <p class="text-muted mb-0">{{ config.description }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Display Settings -->
            <div class="detail-section">
                <h5><i class="fas fa-eye me-2"></i>Display Settings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="feature-list">
                            <li>
                                <i class="fas fa-{% if config.show_account_balances %}check text-success{% else %}times text-danger{% endif %}"></i>
                                Show Account Balances
                            </li>
                            <li>
                                <i class="fas fa-{% if config.show_tax_details %}check text-success{% else %}times text-danger{% endif %}"></i>
                                Show Tax Details
                            </li>
                            <li>
                                <i class="fas fa-{% if config.show_dimensions %}check text-success{% else %}times text-danger{% endif %}"></i>
                                Show Dimensions
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="feature-list">
                            <li>
                                <i class="fas fa-{% if config.allow_multiple_currencies %}check text-success{% else %}times text-danger{% endif %}"></i>
                                Allow Multiple Currencies
                            </li>
                            <li>
                                <i class="fas fa-{% if config.require_line_description %}check text-success{% else %}times text-danger{% endif %}"></i>
                                Require Line Description
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- User-Defined Fields -->
            <div class="detail-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>User-Defined Fields (UDFs)</h5>
                    {% if user|has_permission:'accounting_voucherudfconfig_add' %}
                    <a href="{% url 'accounting:voucher_udf_create' %}?voucher_mode={{ config.pk }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>Add UDF
                    </a>
                    {% else %}
                    <button class="btn btn-sm btn-outline-primary" title="No permission to add UDF" disabled><i class="fas fa-plus me-1"></i>Add UDF</button>
                    {% endif %}
                </div>
                
                {% with udf_configs=config.udf_configs.all %}
                    {% if udf_configs %}
                        <div class="row">
                            {% for udf in udf_configs %}
                                <div class="col-md-6">
                                    <div class="udf-card">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ udf.display_name }}</h6>
                                                <small class="text-muted">{{ udf.field_name }}</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-{% if udf.scope == 'header' %}primary{% else %}info{% endif %}">{{ udf.scope|title }}</span>
                                                {% if udf.is_required %}
                                                    <span class="badge bg-warning">Required</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <strong>Type:</strong> {{ udf.get_field_type_display }}<br>
                                                <strong>Order:</strong> {{ udf.display_order }}
                                            </small>
                                        </div>
                                        <div class="mt-2">
                                            {% if user|has_permission:'accounting_voucherudfconfig_change' %}
                                            <a href="{% url 'accounting:voucher_udf_update' udf.pk %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-secondary" title="No permission to edit UDF" disabled><i class="fas fa-edit"></i> Edit</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-cogs fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No user-defined fields configured</p>
                            {% if user|has_permission:'accounting_voucherudfconfig_add' %}
                            <a href="{% url 'accounting:voucher_udf_create' %}?voucher_mode={{ config.pk }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add First UDF
                            </a>
                            {% else %}
                            <button class="btn btn-primary" title="No permission to add UDF" disabled><i class="fas fa-plus me-1"></i>Add First UDF</button>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}
            </div>

            <!-- Default Line Items -->
            <div class="detail-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Default Line Items</h5>
                    {% if user|has_permission:'accounting_vouchermodedefault_add' %}
                    <a href="{% url 'accounting:voucher_default_create' config.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>Add Default Line
                    </a>
                    {% else %}
                    <button class="btn btn-sm btn-outline-primary" title="No permission to add default line" disabled><i class="fas fa-plus me-1"></i>Add Default Line</button>
                    {% endif %}
                </div>
                
                {% with defaults=config.defaults.all %}
                    {% if defaults %}
                        <div class="row">
                            {% for default in defaults %}
                                <div class="col-md-6">
                                    <div class="default-line-card">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    {% if default.account %}
                                                        {{ default.account.account_code }} - {{ default.account.account_name }}
                                                    {% elif default.account_type %}
                                                        {{ default.account_type.name }}
                                                    {% else %}
                                                        Default Line
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">Order: {{ default.display_order }}</small>
                                            </div>
                                            <div>
                                                {% if default.default_debit %}
                                                    <span class="badge bg-danger">Debit</span>
                                                {% elif default.default_credit %}
                                                    <span class="badge bg-success">Credit</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if default.default_amount %}
                                        <div class="mt-2">
                                            <strong>Amount:</strong> {{ default.default_amount }}
                                        </div>
                                        {% endif %}
                                        <div class="mt-2">
                                            {% if user|has_permission:'accounting_vouchermodedefault_change' %}
                                            <a href="{% url 'accounting:voucher_default_update' default.pk %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-secondary" title="No permission to edit default line" disabled><i class="fas fa-edit"></i> Edit</button>
                                            {% endif %}
                                            {% if user|has_permission:'accounting_vouchermodedefault_delete' %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDefault('{{ default.pk }}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-danger" title="No permission to delete default line" disabled><i class="fas fa-trash"></i> Delete</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-list fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No default line items configured</p>
                            {% if user|has_permission:'accounting_vouchermodedefault_add' %}
                            <a href="{% url 'accounting:voucher_default_create' config.pk %}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add First Default Line
                            </a>
                            {% else %}
                            <button class="btn btn-primary" title="No permission to add default line" disabled><i class="fas fa-plus me-1"></i>Add First Default Line</button>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="detail-section">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                <div class="d-grid gap-2">
                    {% if user|has_permission:'accounting_journal_add' %}
                    <a href="{% url 'accounting:voucher_wizard' %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Create New Voucher
                    </a>
                    {% else %}
                    <button class="btn btn-success" title="No permission to create voucher" disabled><i class="fas fa-plus me-2"></i>Create New Voucher</button>
                    {% endif %}
                    {% if user|has_permission:'accounting_voucherudfconfig_add' %}
                    <a href="{% url 'accounting:voucher_udf_create' %}?voucher_mode={{ config.pk }}" class="btn btn-outline-primary">
                        <i class="fas fa-cogs me-2"></i>Add UDF
                    </a>
                    {% else %}
                    <button class="btn btn-outline-primary" title="No permission to add UDF" disabled><i class="fas fa-cogs me-2"></i>Add UDF</button>
                    {% endif %}
                    {% if user|has_permission:'accounting_vouchermodedefault_add' %}
                    <a href="{% url 'accounting:voucher_default_create' config.pk %}" class="btn btn-outline-info">
                        <i class="fas fa-list me-2"></i>Add Default Line
                    </a>
                    {% else %}
                    <button class="btn btn-outline-info" title="No permission to add default line" disabled><i class="fas fa-list me-2"></i>Add Default Line</button>
                    {% endif %}
                    {% if user|has_permission:'accounting_voucherudfconfig_change' %}
                    <a href="{% url 'accounting:voucher_udf_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-cogs me-2"></i>Manage All UDFs
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary" title="No permission to manage UDFs" disabled><i class="fas fa-cogs me-2"></i>Manage All UDFs</button>
                    {% endif %}
                </div>
            </div>

            <!-- Configuration Stats -->
            <div class="detail-section">
                <h5><i class="fas fa-chart-bar me-2"></i>Configuration Stats</h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary mb-1">{{ config.udf_configs.count }}</h4>
                            <small class="text-muted">UDFs</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-1">{{ config.defaults.count }}</h4>
                        <small class="text-muted">Defaults</small>
                    </div>
                </div>
            </div>

            <!-- Usage Information -->
            <div class="detail-section">
                <h5><i class="fas fa-info-circle me-2"></i>Usage Information</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-calendar text-primary me-2"></i>
                        <strong>Created:</strong><br>
                        <small class="text-muted">{{ config.created_at|date:"M d, Y H:i" }}</small>
                    </li>
                    {% if config.updated_at %}
                    <li class="mb-2">
                        <i class="fas fa-edit text-secondary me-2"></i>
                        <strong>Last Updated:</strong><br>
                        <small class="text-muted">{{ config.updated_at|date:"M d, Y H:i" }}</small>
                    </li>
                    {% endif %}
                    {% if config.created_by %}
                    <li class="mb-2">
                        <i class="fas fa-user text-info me-2"></i>
                        <strong>Created By:</strong><br>
                        <small class="text-muted">{{ config.created_by.get_full_name|default:config.created_by.username }}</small>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Delete Default Line Modal -->
<div class="modal fade" id="deleteDefaultModal" tabindex="-1" aria-labelledby="deleteDefaultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDefaultModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this default line item?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteDefaultForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
</div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDeleteDefault(defaultId) {
    document.getElementById('deleteDefaultForm').action = `/accounting/voucher-defaults/${defaultId}/delete/`;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteDefaultModal'));
    deleteModal.show();
}
</script>
{% endblock %} 
