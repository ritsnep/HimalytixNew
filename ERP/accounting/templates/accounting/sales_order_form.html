{% extends 'accounting/_form_base.html' %}

{% block title %}Sales Order{% endblock %}

{% block form_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="card-title mb-0">{{ form_title|default:"Sales Order" }}</h4>
            <p class="text-muted mb-0">Capture pre-invoice customer commitments and products.</p>
        </div>
        <a href="{% url back_url %}" class="btn btn-secondary btn-sm">Back</a>
    </div>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.order_number.id_for_label }}">Order Number</label>
                    {{ form.order_number }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.customer.id_for_label }}">Customer</label>
                    {{ form.customer }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.reference_number.id_for_label }}">Reference</label>
                    {{ form.reference_number }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.order_date.id_for_label }}">Order Date</label>
                    {{ form.order_date }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.expected_ship_date.id_for_label }}">Expected Ship</label>
                    {{ form.expected_ship_date }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="{{ form.currency.id_for_label }}">Currency</label>
                    {{ form.currency }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="{{ form.exchange_rate.id_for_label }}">Exchange Rate</label>
                    {{ form.exchange_rate }}
                </div>
            </div>

            <div class="table-responsive mt-4">
                {{ formset.management_form }}
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Description</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Discount</th>
                            <th>Revenue Account</th>
                            <th>Tax Code</th>
                            <th>Tax</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="line-items">
                        {% for line_form in formset %}
                        <tr class="line-row">
                            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
                            <td>{{ line_form.description }}</td>
                            <td>{{ line_form.product_code }}</td>
                            <td>{{ line_form.quantity }}</td>
                            <td>{{ line_form.unit_price }}</td>
                            <td>{{ line_form.discount_amount }}</td>
                            <td>{{ line_form.revenue_account }}</td>
                            <td>{{ line_form.tax_code }}</td>
                            <td>{{ line_form.tax_amount }}</td>
                            <td>
                                {% if formset.can_delete %}
                                <div class="form-check">
                                    {{ line_form.DELETE }}
                                    <label class="form-check-label" for="{{ line_form.DELETE.id_for_label }}">Delete</label>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">Add at least one line.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-line">Add Line</button>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary">Save Order</button>
            </div>
        </form>
    </div>
</div>
<template id="empty-line-template">
    <tr class="line-row">
        {% with form=formset.empty_form %}
            {% for hidden in form.hidden_fields %}{{ hidden.as_widget|safe }}{% endfor %}
            <td>{{ form.description.as_widget }}</td>
            <td>{{ form.product_code.as_widget }}</td>
            <td>{{ form.quantity.as_widget }}</td>
            <td>{{ form.unit_price.as_widget }}</td>
            <td>{{ form.discount_amount.as_widget }}</td>
            <td>{{ form.revenue_account.as_widget }}</td>
            <td>{{ form.tax_code.as_widget }}</td>
            <td>{{ form.tax_amount.as_widget }}</td>
            <td>
                <div class="form-check">
                    {{ form.DELETE }}
                    <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">Delete</label>
                </div>
            </td>
        {% endwith %}
    </tr>
</template>
{% endblock form_content %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    const addBtn = document.getElementById('add-line');
    const tableBody = document.getElementById('line-items');
    const totalForms = document.getElementById('id_lines-TOTAL_FORMS');
    const template = document.getElementById('empty-line-template');
    if (!addBtn || !tableBody || !totalForms || !template) { return; }

    addBtn.addEventListener('click', function() {
        const nextIndex = parseInt(totalForms.value, 10);
        const clone = template.content.cloneNode(true);
        clone.querySelectorAll('[name]').forEach((element) => {
            element.name = element.name.replace('__prefix__', nextIndex);
            element.id = element.id.replace('__prefix__', nextIndex);
            if (element.type !== 'hidden') {
                if (element.type === 'checkbox') {
                    element.checked = false;
                } else {
                    element.value = '';
                }
            }
        });
        totalForms.value = nextIndex + 1;
        tableBody.appendChild(clone);
    });
})();
</script>
{% endblock extra_js %}
