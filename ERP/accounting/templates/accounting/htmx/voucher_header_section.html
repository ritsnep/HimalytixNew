{% load static widget_tweaks %}
<!-- Voucher Header Section -->
<div class="voucher-header-section card border-primary mb-4" id="voucher-header">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-file-invoice-dollar me-2"></i>
                {% if voucher %}
                    Edit Voucher {{ voucher.journal_number }}
                {% else %}
                    Create New Voucher
                {% endif %}
            </h5>
            <div class="badge bg-light text-dark fs-6">
                {% if voucher %}
                    Status: {{ voucher.get_status_display }}
                {% else %}
                    Status: Draft
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card-body">
        <form id="voucher-header-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="row g-3">
                <!-- Journal Date -->
                <div class="col-md-3">
                    <label for="{{ header_form.journal_date.id_for_label }}" class="form-label">
                        Journal Date <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                        {{ header_form.journal_date }}
                    </div>
                    {% if header_form.journal_date.errors %}
                        <div class="invalid-feedback d-block">
                            {{ header_form.journal_date.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>

                <!-- Journal Type -->
                <div class="col-md-3">
                    <label for="{{ header_form.journal_type.id_for_label }}" class="form-label">
                        Journal Type <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                        {{ header_form.journal_type|add_class:"form-select"|attr:"required" }}
                    </div>
                    {% if header_form.journal_type.errors %}
                        <div class="invalid-feedback d-block">
                            {{ header_form.journal_type.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>

                <!-- Reference -->
                <div class="col-md-3">
                    <label for="{{ header_form.reference.id_for_label }}" class="form-label">
                        Reference
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                        {{ header_form.reference|add_class:"form-control" }}
                    </div>
                    {% if header_form.reference.errors %}
                        <div class="invalid-feedback d-block">
                            {{ header_form.reference.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>

                <!-- Period -->
                <div class="col-md-3">
                    <label for="{{ header_form.period.id_for_label }}" class="form-label">
                        Accounting Period <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                        {{ header_form.period|add_class:"form-select"|attr:"required" }}
                    </div>
                    {% if header_form.period.errors %}
                        <div class="invalid-feedback d-block">
                            {{ header_form.period.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Description -->
            <div class="row mt-3">
                <div class="col-12">
                    <label for="{{ header_form.description.id_for_label }}" class="form-label">
                        Description <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                        {{ header_form.description|add_class:"form-control"|attr:"required"|attr:"rows:2" }}
                    </div>
                    {% if header_form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ header_form.description.errors|join:", " }}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        Provide a clear description of the journal entry (e.g., "Payment for office supplies")
                    </div>
                </div>
            </div>

            <!-- Additional Fields (if any) -->
            {% for field in header_form %}
                {% if field.name != 'journal_date' and field.name != 'journal_type' and field.name != 'reference' and field.name != 'period' and field.name != 'description' %}
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ field|add_class:"form-control" }}
                            {% if field.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ field.errors|join:", " }}
                                </div>
                            {% endif %}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Hidden Fields -->
            {% for field in header_form.hidden_fields %}
                {{ field }}
            {% endfor %}
        </form>
    </div>

    <!-- Header Actions -->
    <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                <i class="fas fa-info-circle me-1"></i>
                Fields marked with <span class="text-danger">*</span> are required
            </div>
            <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        onclick="resetHeaderForm()"
                        title="Reset form to original values">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        onclick="validateHeader()"
                        title="Validate header information">
                    <i class="fas fa-check"></i> Validate
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.voucher-header-section .card-header {
    border-bottom: 2px solid #0d6efd;
}

.voucher-header-section .form-label {
    font-weight: 600;
    color: #495057;
}

.voucher-header-section .input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.voucher-header-section .form-control:focus,
.voucher-header-section .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.voucher-header-section .invalid-feedback {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.voucher-header-section .card-footer {
    border-top: 1px solid #dee2e6;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .voucher-header-section .row > div {
        margin-bottom: 1rem;
    }

    .voucher-header-section .btn-group {
        flex-direction: column;
        width: 100%;
    }

    .voucher-header-section .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
}
</style>

<script>
// Header form functions
function resetHeaderForm() {
    if (confirm('Are you sure you want to reset the header form? All changes will be lost.')) {
        document.getElementById('voucher-header-form').reset();

        // Clear any validation errors
        document.querySelectorAll('.is-invalid').forEach(element => {
            element.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(element => {
            element.remove();
        });

        addSuccessMessage('Header form reset successfully');
    }
}

function validateHeader() {
    const form = document.getElementById('voucher-header-form');
    const formData = new FormData(form);

    showActionStatus('Validating header...');

    // Send validation request
    fetch('{% url "accounting:voucher_status_validation_hx" journal_id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.text())
    .then(html => {
        hideActionStatus();

        // Update validation messages
        const validationContainer = document.getElementById('validation-messages');
        if (validationContainer) {
            validationContainer.innerHTML = html;
        }

        // Check if there are any errors
        const hasErrors = html.includes('alert-danger');
        if (!hasErrors) {
            addSuccessMessage('Header validation passed');
        }
    })
    .catch(error => {
        hideActionStatus();
        addErrorMessage('Validation failed: ' + error.message);
    });
}

// Auto-save header changes (optional)
let headerSaveTimeout;
function autoSaveHeader() {
    clearTimeout(headerSaveTimeout);
    headerSaveTimeout = setTimeout(() => {
        // Optional: Implement auto-save functionality
        console.log('Header auto-save triggered');
    }, 2000);
}

// Attach auto-save to form inputs
document.addEventListener('DOMContentLoaded', function() {
    const headerForm = document.getElementById('voucher-header-form');
    if (headerForm) {
        headerForm.addEventListener('input', autoSaveHeader);
        headerForm.addEventListener('change', autoSaveHeader);
    }
});
</script>
