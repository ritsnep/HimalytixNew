{% load static %}
<!-- Line Actions Panel -->
<div class="line-actions-panel card border-secondary mt-3" id="line-actions-panel">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-tools me-2"></i>Line Actions
            </h6>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button"
                        class="btn btn-outline-primary"
                        onclick="addNewLine()"
                        title="Add new line">
                    <i class="fas fa-plus"></i> Add Line
                </button>
                <button type="button"
                        class="btn btn-outline-secondary"
                        onclick="clearAllLines()"
                        title="Clear all lines">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
            </div>
        </div>
    </div>

    <div class="card-body p-3">
        <div class="row g-3">
            <!-- Bulk Actions -->
            <div class="col-md-6">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-layer-group me-1"></i>Bulk Actions
                </h6>
                <div class="d-grid gap-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-info"
                            onclick="bulkSetAccount()"
                            title="Set account for all lines">
                        <i class="fas fa-edit"></i> Set Account for All
                    </button>
                    <button type="button"
                            class="btn btn-sm btn-outline-warning"
                            onclick="bulkSetDepartment()"
                            title="Set department for all lines">
                        <i class="fas fa-building"></i> Set Department for All
                    </button>
                    <button type="button"
                            class="btn btn-sm btn-outline-success"
                            onclick="autoBalanceLines()"
                            title="Automatically balance the voucher">
                        <i class="fas fa-balance-scale"></i> Auto Balance
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-6">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-bolt me-1"></i>Quick Actions
                </h6>
                <div class="d-grid gap-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            onclick="duplicateLastLine()"
                            title="Duplicate the last line">
                        <i class="fas fa-copy"></i> Duplicate Last Line
                    </button>
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            onclick="sortLinesByAccount()"
                            title="Sort lines by account code">
                        <i class="fas fa-sort-alpha-down"></i> Sort by Account
                    </button>
                    <button type="button"
                            class="btn btn-sm btn-outline-info"
                            onclick="validateLines()"
                            title="Validate all lines">
                        <i class="fas fa-check-circle"></i> Validate Lines
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Status -->
        <div id="action-status" class="mt-3" style="display: none;">
            <div class="alert alert-info py-2">
                <small id="action-status-message">Processing...</small>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Account Selection Modal -->
<div class="modal fade" id="bulkAccountModal" tabindex="-1" aria-labelledby="bulkAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkAccountModalLabel">Set Account for All Lines</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bulk-account-select" class="form-label">Select Account</label>
                    <select class="form-select" id="bulk-account-select">
                        <option value="">Choose an account...</option>
                        <!-- Accounts will be loaded here -->
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="overwrite-existing" checked>
                    <label class="form-check-label" for="overwrite-existing">
                        Overwrite existing account selections
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyBulkAccount()">Apply</button>
            </div>
        </div>
    </div>
</div>

<style>
.line-actions-panel .card-header {
    border-bottom: 1px solid #dee2e6;
}

.line-actions-panel .btn {
    white-space: nowrap;
}

.line-actions-panel .d-grid {
    grid-template-columns: 1fr;
}

@media (min-width: 576px) {
    .line-actions-panel .d-grid {
        grid-template-columns: 1fr 1fr;
    }
}

#action-status .alert {
    margin-bottom: 0;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

<script>
// Line Actions Functions
function addNewLine() {
    showActionStatus('Adding new line...');

    htmx.ajax('POST', '{% url "accounting:voucher_add_line_hx" journal_id %}', {
        target: '#lines-container',
        swap: 'beforeend'
    }).then(() => {
        hideActionStatus();
        addSuccessMessage('New line added successfully');
        scrollToBottom();
    });
}

function clearAllLines() {
    if (confirm('Are you sure you want to clear all lines? This action cannot be undone.')) {
        showActionStatus('Clearing all lines...');

        // Remove all line rows except the first one (template)
        const linesContainer = document.getElementById('lines-container');
        const lineRows = linesContainer.querySelectorAll('.voucher-line-row');

        lineRows.forEach((row, index) => {
            if (index > 0) { // Keep the first row as template
                row.remove();
            }
        });

        hideActionStatus();
        addSuccessMessage('All lines cleared');
    }
}

function duplicateLastLine() {
    const linesContainer = document.getElementById('lines-container');
    const lastLine = linesContainer.querySelector('.voucher-line-row:last-child');

    if (lastLine) {
        showActionStatus('Duplicating last line...');

        const clonedLine = lastLine.cloneNode(true);
        const newId = 'line-' + Date.now();

        clonedLine.id = newId;

        // Update form field names and IDs
        const inputs = clonedLine.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.name) {
                const match = input.name.match(/lines-(\d+)-/);
                if (match) {
                    const newIndex = parseInt(match[1]) + 1;
                    input.name = input.name.replace(/lines-\d+-/, `lines-${newIndex}-`);
                }
            }
            if (input.id) {
                input.id = input.id.replace(/-\d+$/, `-${Date.now()}`);
            }
        });

        // Clear values
        inputs.forEach(input => {
            if (input.type !== 'hidden') {
                input.value = '';
            }
        });

        linesContainer.appendChild(clonedLine);
        htmx.process(clonedLine);

        hideActionStatus();
        addSuccessMessage('Line duplicated successfully');
        scrollToElement(clonedLine);
    } else {
        addErrorMessage('No lines to duplicate');
    }
}

function sortLinesByAccount() {
    showActionStatus('Sorting lines by account...');

    const linesContainer = document.getElementById('lines-container');
    const lineRows = Array.from(linesContainer.querySelectorAll('.voucher-line-row'));

    lineRows.sort((a, b) => {
        const accountA = a.querySelector('select[name*="-account"]')?.selectedOptions[0]?.text || '';
        const accountB = b.querySelector('select[name*="-account"]')?.selectedOptions[0]?.text || '';
        return accountA.localeCompare(accountB);
    });

    // Re-append sorted rows
    lineRows.forEach(row => {
        linesContainer.appendChild(row);
    });

    hideActionStatus();
    addSuccessMessage('Lines sorted by account');
}

function validateLines() {
    showActionStatus('Validating lines...');

    // Trigger HTMX validation
    htmx.ajax('POST', '{% url "accounting:voucher_line_validation_hx" journal_id %}', {
        target: '#validation-messages'
    }).then(() => {
        hideActionStatus();
    });
}

function autoBalanceLines() {
    showActionStatus('Auto-balancing lines...');

    // Calculate current totals
    let totalDebit = 0;
    let totalCredit = 0;

    document.querySelectorAll('.voucher-line-row').forEach(row => {
        const debitInput = row.querySelector('input[name*="-debit_amount"]');
        const creditInput = row.querySelector('input[name*="-credit_amount"]');

        if (debitInput) totalDebit += parseFloat(debitInput.value) || 0;
        if (creditInput) totalCredit += parseFloat(creditInput.value) || 0;
    });

    const difference = totalDebit - totalCredit;

    if (Math.abs(difference) < 0.01) {
        hideActionStatus();
        addSuccessMessage('Voucher is already balanced');
        return;
    }

    // Add balancing line
    const linesContainer = document.getElementById('lines-container');
    const balancingAmount = Math.abs(difference);

    // Create a simple balancing line
    const balancingLine = document.createElement('div');
    balancingLine.className = 'voucher-line-row border rounded p-3 mb-3 bg-warning';
    balancingLine.innerHTML = `
        <div class="row g-3 align-items-end">
            <div class="col-auto">
                <span class="badge bg-warning text-dark">AUTO</span>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Balancing account..." required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" value="Auto-balancing entry" readonly>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" value="${difference > 0 ? balancingAmount.toFixed(2) : ''}" readonly>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" value="${difference < 0 ? balancingAmount.toFixed(2) : ''}" readonly>
            </div>
        </div>
    `;

    linesContainer.appendChild(balancingLine);
    scrollToElement(balancingLine);

    hideActionStatus();
    addSuccessMessage('Balancing line added');
}

function bulkSetAccount() {
    // Load accounts for bulk selection
    htmx.ajax('GET', '{% url "accounting:voucher_account_lookup" %}', {
        target: '#bulk-account-select',
        swap: 'innerHTML'
    });

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('bulkAccountModal'));
    modal.show();
}

function applyBulkAccount() {
    const accountId = document.getElementById('bulk-account-select').value;
    const overwrite = document.getElementById('overwrite-existing').checked;

    if (!accountId) {
        addErrorMessage('Please select an account');
        return;
    }

    showActionStatus('Applying account to all lines...');

    document.querySelectorAll('.voucher-line-row select[name*="-account"]').forEach(select => {
        if (overwrite || !select.value) {
            select.value = accountId;
        }
    });

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAccountModal'));
    modal.hide();

    hideActionStatus();
    addSuccessMessage('Account applied to lines');
}

// Utility functions
function showActionStatus(message) {
    const statusDiv = document.getElementById('action-status');
    const messageDiv = document.getElementById('action-status-message');
    messageDiv.textContent = message;
    statusDiv.style.display = 'block';
}

function hideActionStatus() {
    document.getElementById('action-status').style.display = 'none';
}

function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function scrollToElement(element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>