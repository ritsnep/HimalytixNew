{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Create Purchase Invoice{% endblock %}

{% block head %}
<style>
  .form-control-sm, .form-select-sm { font-size: 0.85rem; }
  .text-end { text-align: right; }
  .money { font-family: 'Courier New', monospace; text-align: right; font-size: 0.95rem; }
  .table-responsive { max-height: 600px; overflow-y: auto; }
  .item-row:hover { background-color: #f8f9fa; }
  .sticky-header { position: sticky; top: 0; background: white; z-index: 10; }
  .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
  .autocomplete-results.show { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
<div class="page-content py-4">
    <div class="container-fluid">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Create Purchase Invoice</h2>
      <div>
        <a href="javascript:history.back();" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Previous
        </a>
      </div>
    </div>

    <!-- Main Form -->
    <form id="purchase-form" method="post" action="{% url 'accounting:purchase_invoice_new_enhanced' %}"
          data-add-line-url="{% url 'accounting:purchase_add_line_hx' %}"
          data-add-payment-url="{% url 'accounting:purchase_add_payment_hx' %}"
          data-product-detail-url="{% url 'accounting:load_product_details' 0 %}"
          novalidate>

      {% csrf_token %}

      <!-- SUPPLIER INFO SECTION -->
      {% include "accounting/purchase/_supplier_info_new.html" %}

      <!-- MAIN GRID: Items + Totals -->
      <div class="row g-3">
        
        <!-- Items Section (Left) -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-check"></i> Line Items</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-line">
                  <i class="bi bi-plus-circle"></i> Add Item
                </button>
              </div>
            </div>

            <div class="card-body p-0">
              {% if line_formset and line_formset.non_form_errors %}
                <div class="alert alert-danger m-3">
                  {{ line_formset.non_form_errors }}
                </div>
              {% endif %}

              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 px-3 pt-3">
                <div class="small text-muted">Columns</div>
                <div class="btn-group" role="group" aria-label="Column toggles">
                  <input type="checkbox" class="btn-check" id="chip_code" autocomplete="off">
                  <label class="btn btn-outline-secondary btn-sm" for="chip_code">Code</label>

                  <input type="checkbox" class="btn-check" id="chip_description" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary btn-sm" for="chip_description">Description</label>

                  <input type="checkbox" class="btn-check" id="chip_discount" autocomplete="off">
                  <label class="btn btn-outline-secondary btn-sm" for="chip_discount">Discount</label>

                  <input type="checkbox" class="btn-check" id="chip_net" autocomplete="off">
                  <label class="btn btn-outline-secondary btn-sm" for="chip_net">Net</label>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="sticky-header">
                    <tr class="border-bottom">
                      <th class="text-muted small" width="30">#</th>
                      <th class="text-muted small">Product</th>
                      <th class="text-muted small col-code">Code</th>
                      <th class="text-muted small col-description">Description</th>
                      <th class="text-muted small">Qty/Unit</th>
                      <th class="text-muted small">Warehouse</th>
                      <th class="text-muted small">Rate</th>
                      <th class="text-muted small">VAT%</th>
                      <th class="text-muted small col-discount">Discount</th>
                      <th class="text-muted small text-end col-net">Net</th>
                      <th class="text-muted small text-end">Total</th>
                      <th width="40"></th>
                    </tr>
                  </thead>
                  <tbody id="items-tbody">
                    {% if line_formset and line_formset.forms %}
                      {% for form in line_formset.forms %}
                        {% include "accounting/purchase/_line_row_new.html" with form=form form_index=forloop.counter0 %}
                      {% endfor %}
                    {% else %}
                      <tr id="item-row-empty" class="item-row">
                        <td class="text-center text-muted small" width="30">1</td>
                        <td colspan="11" class="text-muted small py-3">
                          <em>No items yet. Add items using the "Add Item" button above</em>
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <div style="display:none;">
                {% if line_formset %}
                  {% for f in line_formset.management_form %}
                    {{ f }}
                  {% endfor %}
                {% else %}
                  <input type="hidden" name="items-TOTAL_FORMS" value="0">
                  <input type="hidden" name="items-INITIAL_FORMS" value="0">
                  <input type="hidden" name="items-MIN_NUM_FORMS" value="0">
                  <input type="hidden" name="items-MAX_NUM_FORMS" value="1000">
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Totals Section (Right) -->
        <div class="col-lg-4">
          <div id="totals-wrap">
            {% include "accounting/purchase/_totals_panel_new.html" %}
          </div>
        </div>

      </div>

      <!-- BOTTOM SECTIONS: Terms + Payments -->
      <div class="row g-3 mt-2">
        
        <!-- Terms Panel -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
              <h6 class="mb-0"><i class="bi bi-file-text"></i> Terms & Conditions</h6>
            </div>
            <div class="card-body p-3">
              <div class="mb-3">
                <label class="form-label small text-muted">Payment Terms</label>
                {% if form.payment_term %}
                  {{ form.payment_term }}
                {% endif %}
              </div>
              <div class="mb-3">
                <label class="form-label small text-muted">Terms &amp; Conditions</label>
                {% if form.terms_and_conditions %}
                  {{ form.terms_and_conditions }}
                {% endif %}
              </div>
              <div class="mb-3">
                <label class="form-label small text-muted">Notes</label>
                {% if form.notes %}
                  {{ form.notes }}
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Payments Panel -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-credit-card"></i> Payment Schedule</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-payment">
                  <i class="bi bi-plus-circle"></i> Add Payment
                </button>
              </div>
            </div>

            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead class="sticky-header border-bottom">
                    <tr>
                      <th class="text-muted small">Method</th>
                      <th class="text-muted small">Account</th>
                      <th class="text-muted small">Due Date</th>
                      <th class="text-muted small text-end">Amount</th>
                      <th class="text-muted small">Remarks</th>
                      <th width="40"></th>
                    </tr>
                  </thead>
                  <tbody id="payments-tbody">
                    {% if payments_formset and payments_formset.forms %}
                      {% for form in payments_formset.forms %}
                        {% include "accounting/purchase/_payment_row_new.html" with form=form form_index=forloop.counter0 %}
                      {% endfor %}
                    {% else %}
                      <tr class="payment-row">
                        <td colspan="6" class="text-muted small py-3">
                          <em>Add payments using the "Add Payment" button above</em>
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>

              <div class="p-3 border-top">
                <small class="text-muted">Remaining Balance:</small>
                <div class="money fw-bold h6 mb-0" id="remaining-balance">0.00</div>
              </div>

              <div style="display:none;">
                {% for form in payments_formset.management_form %}
                  {{ form }}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Narration -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label small text-muted">Narration</label>
            {% if form.narration %}
              {{ form.narration }}
            {% else %}
              <textarea class="form-control" name="narration" rows="3"></textarea>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- FOOTER ACTIONS -->
      <div class="d-flex gap-2 justify-content-between mt-4 pt-3 border-top sticky-bottom bg-white py-3">
        <div>
          <a href="javascript:history.back();" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Cancel
          </a>
        </div>
        <div class="d-flex gap-2">
          <button type="reset" class="btn btn-outline-info" id="btn-clear">
            <i class="bi bi-arrow-counterclockwise"></i> Clear
          </button>
          <button type="submit" class="btn btn-primary" id="btn-save">
            <i class="bi bi-check-circle"></i> Save Invoice
          </button>
        </div>
      </div>

    </form>

  </div>
</div>
</div>
<!-- JavaScript for interactivity -->
<script>
(function () {
  const form = document.getElementById('purchase-form');
  if (!form) return;

  const addLineUrl = form.dataset.addLineUrl;
  const addPaymentUrl = form.dataset.addPaymentUrl;
  const productDetailUrl = form.dataset.productDetailUrl;
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';

  const el = (id) => document.getElementById(id);
  const num = (val) => {
    const n = parseFloat(val);
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = (val) => (Math.round((val + Number.EPSILON) * 100) / 100).toFixed(2);

  function numberToWords(n) {
    const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
    const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
    if (!n || n === 0) return "Zero";
    function chunkToWords(num) {
      let words = "";
      if (num >= 100) {
        words += ones[Math.floor(num / 100)] + " Hundred ";
        num %= 100;
      }
      if (num >= 20) {
        words += tens[Math.floor(num / 10)] + " ";
        num %= 10;
      } else if (num >= 10) {
        words += teens[num - 10] + " ";
        num = 0;
      }
      if (num > 0) words += ones[num] + " ";
      return words.trim();
    }
    const scales = ["", "Thousand", "Million", "Billion"];
    let scale = 0;
    let words = "";
    let numVal = Math.floor(n);
    while (numVal > 0) {
      const chunk = numVal % 1000;
      if (chunk) {
        const chunkWords = chunkToWords(chunk);
        words = `${chunkWords} ${scales[scale]} ${words}`.trim();
      }
      numVal = Math.floor(numVal / 1000);
      scale += 1;
    }
    return words.trim();
  }

  function getProductUrl(productId) {
    if (!productDetailUrl) return '';
    return productDetailUrl.replace('0', String(productId));
  }

  function applyColumnVisibility(prefs) {
    const map = {
      code: "col-code",
      description: "col-description",
      discount: "col-discount",
      net: "col-net",
    };
    Object.entries(map).forEach(([key, cls]) => {
      document.querySelectorAll(`.${cls}`).forEach((cell) => {
        cell.classList.toggle("d-none", !prefs[key]);
      });
    });
    const setChecked = (id, val) => { const c = el(id); if (c) c.checked = !!val; };
    setChecked("chip_code", prefs.code);
    setChecked("chip_description", prefs.description);
    setChecked("chip_discount", prefs.discount);
    setChecked("chip_net", prefs.net);
  }

  const PREF_KEY = "purchase_invoice_columns_v1";
  const defaultPrefs = { code: false, description: true, discount: false, net: false };
  let prefs = defaultPrefs;
  try {
    prefs = { ...defaultPrefs, ...(JSON.parse(localStorage.getItem(PREF_KEY)) || {}) };
  } catch (_) {}
  applyColumnVisibility(prefs);

  ["code", "description", "discount", "net"].forEach((key) => {
    const chip = el(`chip_${key}`);
    if (chip) {
      chip.addEventListener("change", () => {
        prefs[key] = chip.checked;
        localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
        applyColumnVisibility(prefs);
      });
    }
  });

  function updateLineNumbers() {
    const rows = [...document.querySelectorAll('#items-tbody tr.item-row')].filter(r => !r.classList.contains('d-none'));
    rows.forEach((row, idx) => {
      const cell = row.querySelector('td');
      if (cell) cell.textContent = String(idx + 1);
    });
  }

  function setAccountDefaults(row) {
    const accountSelect = row.querySelector('select[name$="-account"]');
    const headerAccount = el('id_purchase_account');
    if (accountSelect && headerAccount && headerAccount.value && !accountSelect.value) {
      accountSelect.value = headerAccount.value;
    }
  }

  function updateLineRow(row) {
    const qty = num(row.querySelector('.line-qty')?.value);
    const rate = num(row.querySelector('.line-rate')?.value);
    const discount = num(row.querySelector('.line-discount')?.value);
    const vatRate = num(row.querySelector('.line-vat')?.value);
    const gross = qty * rate;
    const discAmt = Math.max(0, Math.min(discount, gross));
    const net = gross - discAmt;
    const netRate = qty ? (net / qty) : 0;
    const netRateInput = row.querySelector('.net-rate');
    if (netRateInput) netRateInput.value = fmt(netRate);
    const totalInput = row.querySelector('.line-total');
    if (totalInput) totalInput.value = fmt(net + (net * (vatRate / 100)));
    return { net, discAmt, vatRate };
  }

  function recalcTotals() {
    const rows = [...document.querySelectorAll('#items-tbody tr.item-row')].filter(r => !r.classList.contains('d-none'));
    let subTotal = 0;
    let lineDiscVat = 0;
    let lineDiscNonVat = 0;
    let netVat = 0;
    let netNonVat = 0;

    rows.forEach((row) => {
      const qty = num(row.querySelector('.line-qty')?.value);
      const rate = num(row.querySelector('.line-rate')?.value);
      const discount = num(row.querySelector('.line-discount')?.value);
      const vatRate = num(row.querySelector('.line-vat')?.value);
      const gross = qty * rate;
      const discAmt = Math.max(0, Math.min(discount, gross));
      const net = gross - discAmt;
      subTotal += gross;
      if (vatRate > 0) {
        lineDiscVat += discAmt;
        netVat += net;
      } else {
        lineDiscNonVat += discAmt;
        netNonVat += net;
      }
      updateLineRow(row);
    });

    const hdrType = el('id_discount_type')?.value || 'amount';
    const hdrVal = num(el('id_discount_value')?.value || '0');
    const netAfterLineDisc = Math.max(0, subTotal - (lineDiscVat + lineDiscNonVat));
    let hdrDisc = 0;
    if (hdrType === 'percent') hdrDisc = netAfterLineDisc * (hdrVal / 100);
    else hdrDisc = hdrVal;
    hdrDisc = Math.max(0, Math.min(hdrDisc, netAfterLineDisc));

    const netTotal = netVat + netNonVat;
    const shareVat = netTotal > 0 ? (netVat / netTotal) : 0;
    const hdrDiscVat = hdrDisc * shareVat;
    const hdrDiscNon = hdrDisc - hdrDiscVat;

    const totalVatable = Math.max(0, netVat - hdrDiscVat);
    const totalNonVatable = Math.max(0, netNonVat - hdrDiscNon);
    const taxable = totalVatable;
    const vatAmount = taxable * 0.13;

    const rounding = num(el('id_bill_rounding')?.value || '0');
    const grandTotal = totalNonVatable + totalVatable + vatAmount + rounding;

    el('calc-subtotal') && (el('calc-subtotal').textContent = fmt(subTotal));
    el('calc-nonvatable') && (el('calc-nonvatable').textContent = fmt(netNonVat));
    el('calc-nonvatable-disc') && (el('calc-nonvatable-disc').textContent = fmt(lineDiscNonVat + hdrDiscNon));
    el('calc-total-nonvatable') && (el('calc-total-nonvatable').textContent = fmt(totalNonVatable));
    el('calc-vatable') && (el('calc-vatable').textContent = fmt(netVat));
    el('calc-vatable-disc') && (el('calc-vatable-disc').textContent = fmt(lineDiscVat + hdrDiscVat));
    el('calc-taxable') && (el('calc-taxable').textContent = fmt(taxable));
    el('calc-vat') && (el('calc-vat').textContent = fmt(vatAmount));
    el('calc-grand-total') && (el('calc-grand-total').textContent = fmt(grandTotal));
    el('amount-in-words') && (el('amount-in-words').textContent = `${numberToWords(grandTotal)} only`);

    const paymentSum = [...document.querySelectorAll('.payment-amount')].reduce((sum, input) => sum + num(input.value), 0);
    const remaining = grandTotal - paymentSum;
    el('remaining-balance') && (el('remaining-balance').textContent = fmt(remaining));
  }

  function addLineRow() {
    const tbody = el('items-tbody');
    const totalInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
    if (!tbody || !totalInput) return;
    const formCount = parseInt(totalInput.value, 10) || 0;
    fetch(`${addLineUrl}?form_count=${formCount}&prefix=items&variant=enhanced`)
      .then((r) => r.text())
      .then((html) => {
        const emptyRow = el('item-row-empty');
        if (emptyRow) emptyRow.remove();
        tbody.insertAdjacentHTML('beforeend', html);
        totalInput.value = String(formCount + 1);
        const newRow = tbody.querySelector(`tr[data-line-index="${formCount}"]`);
        if (newRow) {
          setAccountDefaults(newRow);
          applyColumnVisibility(prefs);
        }
        updateLineNumbers();
        recalcTotals();
      });
  }

  function addPaymentRow() {
    const tbody = el('payments-tbody');
    const totalInput = document.querySelector('input[name="payments-TOTAL_FORMS"]');
    if (!tbody || !totalInput) return;
    const formCount = parseInt(totalInput.value, 10) || 0;
    fetch(`${addPaymentUrl}?form_count=${formCount}&variant=enhanced`)
      .then((r) => r.text())
      .then((html) => {
        const placeholder = tbody.querySelector('tr.payment-row');
        if (placeholder && placeholder.querySelector('em')) placeholder.remove();
        tbody.insertAdjacentHTML('beforeend', html);
        totalInput.value = String(formCount + 1);
        recalcTotals();
      });
  }

  el('btn-add-line')?.addEventListener('click', addLineRow);
  el('btn-add-payment')?.addEventListener('click', addPaymentRow);

  document.addEventListener('click', (e) => {
    const removeLine = e.target.closest('.btn-delete-row');
    if (removeLine) {
      const row = removeLine.closest('.item-row');
      const delInput = row?.querySelector('input[name$="-DELETE"]');
      if (delInput) {
        delInput.checked = true;
        row.classList.add('d-none');
      } else {
        row?.remove();
      }
      updateLineNumbers();
      recalcTotals();
    }
    const removePayment = e.target.closest('.btn-delete-payment');
    if (removePayment) {
      const row = removePayment.closest('.payment-row');
      const delInput = row?.querySelector('input[name$="-DELETE"]');
      if (delInput) {
        delInput.checked = true;
        row.classList.add('d-none');
      } else {
        row?.remove();
      }
      recalcTotals();
    }
  });

  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('product-select')) {
      const row = e.target.closest('.item-row');
      const productId = e.target.value;
      const vendorId = el('id_vendor')?.value || '';
      if (!productId || !row) return;
      const url = `${getProductUrl(productId)}?vendor_id=${encodeURIComponent(vendorId)}`;
      fetch(url, { headers: { 'X-CSRFToken': csrfToken } })
        .then((r) => r.json())
        .then((data) => {
          if (!data || !data.success) return;
          const codeInput = row.querySelector('.product-code');
          if (codeInput) codeInput.value = data.code || data.hs_code || '';
          const descInput = row.querySelector('input[name$="-description"]');
          if (descInput && !descInput.value) descInput.value = data.description || '';
          const unitInput = row.querySelector('.unit-display');
          if (unitInput) unitInput.value = data.unit || '';
          const rateInput = row.querySelector('.line-rate');
          if (rateInput) rateInput.value = data.rate || 0;
          const vatInput = row.querySelector('.line-vat');
          if (vatInput) vatInput.value = data.vat_rate || (data.vat_applicable ? 13 : 0);
          setAccountDefaults(row);
          recalcTotals();
        })
        .catch(() => {});
    }
  });

  document.addEventListener('input', (e) => {
    if (e.target.classList.contains('line-qty') ||
        e.target.classList.contains('line-rate') ||
        e.target.classList.contains('line-discount') ||
        e.target.classList.contains('line-vat') ||
        e.target.classList.contains('payment-amount') ||
        e.target.id === 'id_discount_value' ||
        e.target.id === 'id_bill_rounding') {
      recalcTotals();
    }
  });

  document.addEventListener('change', (e) => {
    if (e.target.id === 'id_discount_type') {
      recalcTotals();
    }
  });

  el('rounding-minus')?.addEventListener('click', () => {
    const input = el('id_bill_rounding');
    if (input) {
      input.value = String(num(input.value) - 0.01);
      recalcTotals();
    }
  });

  el('rounding-plus')?.addEventListener('click', () => {
    const input = el('id_bill_rounding');
    if (input) {
      input.value = String(num(input.value) + 0.01);
      recalcTotals();
    }
  });

  document.querySelectorAll('#items-tbody tr.item-row').forEach((row) => setAccountDefaults(row));
  el('id_purchase_account')?.addEventListener('change', () => {
    document.querySelectorAll('#items-tbody tr.item-row').forEach((row) => setAccountDefaults(row));
  });
  recalcTotals();
})();
</script>
{% endblock %}
