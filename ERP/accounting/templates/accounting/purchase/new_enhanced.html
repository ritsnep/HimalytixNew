{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Create Purchase Invoice{% endblock %}

{% block head %}
<style>
  .form-control-sm, .form-select-sm { font-size: 0.85rem; }
  .text-end { text-align: right; }
  .money { font-family: 'Courier New', monospace; text-align: right; font-size: 0.95rem; }
  .table-responsive { max-height: 600px; overflow-y: auto; }
  .item-row:hover { background-color: #f8f9fa; }
  .sticky-header { position: sticky; top: 0; background: white; z-index: 10; }
  .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
  .autocomplete-results.show { display: block; }
</style>
{{ form.media }}
{% endblock %}

{% block content %}
<div class="main-content">
<div class="page-content py-4">
    <div class="container-fluid">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Create Purchase Invoice</h2>
      <div>
        <a href="javascript:history.back();" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Previous
        </a>
      </div>
    </div>

    <!-- Main Form -->
    {% include "accounting/purchase/_purchase_form_panel.html" %}

  </div>
</div>
</div>
<!-- JavaScript for interactivity -->
<script>
(function () {
  const state = window.PurchaseInvoiceEnhanced || (window.PurchaseInvoiceEnhanced = {});
  if (state.bound) return;
  state.bound = true;

  const el = (id) => document.getElementById(id);
  const num = (val) => {
    const n = parseFloat(val);
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = (val) => (Math.round((val + Number.EPSILON) * 100) / 100).toFixed(2);
  const swapZoneIds = new Set(['purchase-form-panel', 'pi-form', 'pi-lines', 'pi-totals', 'pi-supplier-panel', 'items-tbody']);

  function numberToWords(n) {
    const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
    const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
    if (!n || n === 0) return "Zero";
    function chunkToWords(num) {
      let words = "";
      if (num >= 100) {
        words += ones[Math.floor(num / 100)] + " Hundred ";
        num %= 100;
      }
      if (num >= 20) {
        words += tens[Math.floor(num / 10)] + " ";
        num %= 10;
      } else if (num >= 10) {
        words += teens[num - 10] + " ";
        num = 0;
      }
      if (num > 0) words += ones[num] + " ";
      return words.trim();
    }
    const scales = ["", "Thousand", "Million", "Billion"];
    let scale = 0;
    let words = "";
    let numVal = Math.floor(n);
    while (numVal > 0) {
      const chunk = numVal % 1000;
      if (chunk) {
        const chunkWords = chunkToWords(chunk);
        words = `${chunkWords} ${scales[scale]} ${words}`.trim();
      }
      numVal = Math.floor(numVal / 1000);
      scale += 1;
    }
    return words.trim();
  }

  function getProductUrl(productId) {
    if (!state.productDetailUrl) return '';
    return state.productDetailUrl.replace('0', String(productId));
  }

  function applyColumnVisibility(prefs) {
    const map = {
      code: "col-code",
      description: "col-description",
      discount: "col-discount",
      net: "col-net",
    };
    Object.entries(map).forEach(([key, cls]) => {
      document.querySelectorAll(`.${cls}`).forEach((cell) => {
        cell.classList.toggle("d-none", !prefs[key]);
      });
    });
    const setChecked = (id, val) => { const c = el(id); if (c) c.checked = !!val; };
    setChecked("chip_code", prefs.code);
    setChecked("chip_description", prefs.description);
    setChecked("chip_discount", prefs.discount);
    setChecked("chip_net", prefs.net);
  }

  const PREF_KEY = "purchase_invoice_columns_v1";
  const defaultPrefs = { code: false, description: true, discount: false, net: false };

  function loadPrefs() {
    try {
      return { ...defaultPrefs, ...(JSON.parse(localStorage.getItem(PREF_KEY)) || {}) };
    } catch (_) {
      return { ...defaultPrefs };
    }
  }

  function savePrefs(nextPrefs) {
    localStorage.setItem(PREF_KEY, JSON.stringify(nextPrefs));
  }

  function updateLineNumbers() {
    const rows = [...document.querySelectorAll('#items-tbody tr.item-row')].filter(r => !r.classList.contains('d-none'));
    rows.forEach((row, idx) => {
      const cell = row.querySelector('td');
      if (cell) cell.textContent = String(idx + 1);
    });
  }

  function setAccountDefaults(row) {
    const accountSelect = row.querySelector('select[name$="-account"]');
    const headerAccount = el('id_purchase_account');
    if (accountSelect && headerAccount && headerAccount.value && !accountSelect.value) {
      accountSelect.value = headerAccount.value;
    }
  }

  function updateLineRow(row) {
    const qty = num(row.querySelector('.line-qty')?.value);
    const rate = num(row.querySelector('.line-rate')?.value);
    const discount = num(row.querySelector('.line-discount')?.value);
    const vatRate = num(row.querySelector('.line-vat')?.value);
    const gross = qty * rate;
    const discAmt = Math.max(0, Math.min(discount, gross));
    const net = gross - discAmt;
    const netRate = qty ? (net / qty) : 0;
    const netRateInput = row.querySelector('.net-rate');
    if (netRateInput) netRateInput.value = fmt(netRate);
    const totalInput = row.querySelector('.line-total');
    if (totalInput) totalInput.value = fmt(net + (net * (vatRate / 100)));
    return { net, discAmt, vatRate };
  }

  function recalcTotals() {
    const rows = [...document.querySelectorAll('#items-tbody tr.item-row')].filter(r => !r.classList.contains('d-none'));
    let subTotal = 0;
    let lineDiscVat = 0;
    let lineDiscNonVat = 0;
    let netVat = 0;
    let netNonVat = 0;

    rows.forEach((row) => {
      const qty = num(row.querySelector('.line-qty')?.value);
      const rate = num(row.querySelector('.line-rate')?.value);
      const discount = num(row.querySelector('.line-discount')?.value);
      const vatRate = num(row.querySelector('.line-vat')?.value);
      const gross = qty * rate;
      const discAmt = Math.max(0, Math.min(discount, gross));
      const net = gross - discAmt;
      subTotal += gross;
      if (vatRate > 0) {
        lineDiscVat += discAmt;
        netVat += net;
      } else {
        lineDiscNonVat += discAmt;
        netNonVat += net;
      }
      updateLineRow(row);
    });

    const hdrType = el('id_discount_type')?.value || 'amount';
    const hdrVal = num(el('id_discount_value')?.value || '0');
    const netAfterLineDisc = Math.max(0, subTotal - (lineDiscVat + lineDiscNonVat));
    let hdrDisc = 0;
    if (hdrType === 'percent') hdrDisc = netAfterLineDisc * (hdrVal / 100);
    else hdrDisc = hdrVal;
    hdrDisc = Math.max(0, Math.min(hdrDisc, netAfterLineDisc));

    const netTotal = netVat + netNonVat;
    const shareVat = netTotal > 0 ? (netVat / netTotal) : 0;
    const hdrDiscVat = hdrDisc * shareVat;
    const hdrDiscNon = hdrDisc - hdrDiscVat;

    const totalVatable = Math.max(0, netVat - hdrDiscVat);
    const totalNonVatable = Math.max(0, netNonVat - hdrDiscNon);
    const taxable = totalVatable;
    const vatAmount = taxable * 0.13;

    const rounding = num(el('id_bill_rounding')?.value || '0');
    const grandTotal = totalNonVatable + totalVatable + vatAmount + rounding;

    el('calc-subtotal') && (el('calc-subtotal').textContent = fmt(subTotal));
    el('calc-nonvatable') && (el('calc-nonvatable').textContent = fmt(netNonVat));
    el('calc-nonvatable-disc') && (el('calc-nonvatable-disc').textContent = fmt(lineDiscNonVat + hdrDiscNon));
    el('calc-total-nonvatable') && (el('calc-total-nonvatable').textContent = fmt(totalNonVatable));
    el('calc-vatable') && (el('calc-vatable').textContent = fmt(netVat));
    el('calc-vatable-disc') && (el('calc-vatable-disc').textContent = fmt(lineDiscVat + hdrDiscVat));
    el('calc-taxable') && (el('calc-taxable').textContent = fmt(taxable));
    el('calc-vat') && (el('calc-vat').textContent = fmt(vatAmount));
    el('calc-grand-total') && (el('calc-grand-total').textContent = fmt(grandTotal));
    el('amount-in-words') && (el('amount-in-words').textContent = `${numberToWords(grandTotal)} only`);

    const paymentSum = [...document.querySelectorAll('.payment-amount')].reduce((sum, input) => sum + num(input.value), 0);
    const remaining = grandTotal - paymentSum;
    el('remaining-balance') && (el('remaining-balance').textContent = fmt(remaining));
  }

  function addLineRow() {
    const tbody = el('items-tbody');
    const totalInput = document.querySelector('input[name="items-TOTAL_FORMS"]');
    if (!tbody || !totalInput) return;
    const formCount = parseInt(totalInput.value, 10) || 0;
    if (!state.addLineUrl) return;
    fetch(`${state.addLineUrl}?form_count=${formCount}&prefix=items&variant=enhanced`)
      .then((r) => r.text())
      .then((html) => {
        const emptyRow = el('item-row-empty');
        if (emptyRow) emptyRow.remove();
        tbody.insertAdjacentHTML('beforeend', html);
        totalInput.value = String(formCount + 1);
        const newRow = tbody.querySelector(`tr[data-line-index="${formCount}"]`);
        if (newRow) {
          setAccountDefaults(newRow);
          applyColumnVisibility(state.prefs);
        }
        updateLineNumbers();
        recalcTotals();
      });
  }

  function addPaymentRow() {
    const tbody = el('payments-tbody');
    const totalInput = document.querySelector('input[name="payments-TOTAL_FORMS"]');
    if (!tbody || !totalInput) return;
    const formCount = parseInt(totalInput.value, 10) || 0;
    if (!state.addPaymentUrl) return;
    fetch(`${state.addPaymentUrl}?form_count=${formCount}&variant=enhanced`)
      .then((r) => r.text())
      .then((html) => {
        const placeholder = tbody.querySelector('tr.payment-row');
        if (placeholder && placeholder.querySelector('em')) placeholder.remove();
        tbody.insertAdjacentHTML('beforeend', html);
        totalInput.value = String(formCount + 1);
        recalcTotals();
      });
  }

  document.addEventListener('click', (e) => {
    if (state.form && !state.form.contains(e.target)) return;
    if (e.target.closest('#btn-add-line')) {
      addLineRow();
      return;
    }
    if (e.target.closest('#btn-add-payment')) {
      addPaymentRow();
      return;
    }
    if (e.target.closest('#rounding-minus')) {
      const input = el('id_bill_rounding');
      if (input) {
        input.value = String(num(input.value) - 0.01);
        recalcTotals();
      }
      return;
    }
    if (e.target.closest('#rounding-plus')) {
      const input = el('id_bill_rounding');
      if (input) {
        input.value = String(num(input.value) + 0.01);
        recalcTotals();
      }
      return;
    }
    const removeLine = e.target.closest('.btn-delete-row');
    if (removeLine) {
      const row = removeLine.closest('.item-row');
      const delInput = row?.querySelector('input[name$="-DELETE"]');
      if (delInput) {
        delInput.checked = true;
        delInput.value = 'on';
        row.classList.add('d-none');
      } else if (row) {
        // If DELETE checkbox is absent (e.g., dynamically added/imported rows), inject one
        const idx = row.dataset.lineIndex;
        if (idx !== undefined) {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = `items-${idx}-DELETE`;
          hidden.value = 'on';
          row.appendChild(hidden);
        }
        row.classList.add('d-none');
      }
      updateLineNumbers();
      recalcTotals();
    }
    const removePayment = e.target.closest('.btn-delete-payment');
    if (removePayment) {
      const row = removePayment.closest('.payment-row');
      const delInput = row?.querySelector('input[name$="-DELETE"]');
      if (delInput) {
        delInput.checked = true;
        delInput.value = 'on';
        row.classList.add('d-none');
      } else {
        row?.remove();
      }
      recalcTotals();
    }
  });

  document.addEventListener('change', (e) => {
    if (state.form && !state.form.contains(e.target)) return;
    if (e.target.classList.contains('product-select')) {
      const row = e.target.closest('.item-row');
      const productId = e.target.value;
      const vendorId = el('id_vendor')?.value || '';
      if (!productId || !row) return;
      const url = `${getProductUrl(productId)}?vendor_id=${encodeURIComponent(vendorId)}`;
      fetch(url, { headers: { 'X-CSRFToken': state.csrfToken || '' } })
        .then((r) => r.json())
        .then((data) => {
          if (!data || !data.success) return;
          const codeInput = row.querySelector('.product-code');
          if (codeInput) codeInput.value = data.code || data.hs_code || '';
          const descInput = row.querySelector('input[name$="-description"]');
          if (descInput && !descInput.value) descInput.value = data.description || '';
          const unitInput = row.querySelector('.unit-display');
          if (unitInput) unitInput.value = data.unit || '';
          const rateInput = row.querySelector('.line-rate');
          if (rateInput) rateInput.value = data.rate || 0;
          const vatInput = row.querySelector('.line-vat');
          if (vatInput) vatInput.value = data.vat_rate || (data.vat_applicable ? 13 : 0);
          setAccountDefaults(row);
          recalcTotals();
        })
        .catch(() => {});
    }
    if (e.target.id === 'id_discount_type') {
      recalcTotals();
    }
    if (e.target.id === 'id_purchase_account') {
      document.querySelectorAll('#items-tbody tr.item-row').forEach((row) => setAccountDefaults(row));
    }
    if (e.target.id && e.target.id.startsWith('chip_')) {
      const key = e.target.id.replace('chip_', '');
      if (state.prefs && key in state.prefs) {
        state.prefs[key] = e.target.checked;
        savePrefs(state.prefs);
        applyColumnVisibility(state.prefs);
      }
    }
  });

  document.addEventListener('input', (e) => {
    if (state.form && !state.form.contains(e.target)) return;
    if (e.target.classList.contains('line-qty') ||
        e.target.classList.contains('line-rate') ||
        e.target.classList.contains('line-discount') ||
        e.target.classList.contains('line-vat') ||
        e.target.classList.contains('payment-amount') ||
        e.target.id === 'id_discount_value' ||
        e.target.id === 'id_bill_rounding') {
      recalcTotals();
    }
  });

  function attachPristine(form) {
    if (!form || form.dataset.pristineBound === 'true' || typeof Pristine === 'undefined') return;
    const pristine = new Pristine(form);
    window.pristineInstances = window.pristineInstances || new Map();
    window.pristineInstances.set(form, pristine);
    form.dataset.pristineBound = 'true';
    form.addEventListener('submit', (evt) => {
      if (!pristine.validate()) {
        evt.preventDefault();
        evt.stopPropagation();
      }
    });
  }

  function refreshFormState() {
    const form = document.getElementById('purchase-form');
    state.form = form;
    if (!form) return;
    state.addLineUrl = form.dataset.addLineUrl || '';
    state.addPaymentUrl = form.dataset.addPaymentUrl || '';
    state.productDetailUrl = form.dataset.productDetailUrl || '';
    state.csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
    state.prefs = loadPrefs();
    applyColumnVisibility(state.prefs);
    document.querySelectorAll('#items-tbody tr.item-row').forEach((row) => setAccountDefaults(row));
    attachPristine(form);
    recalcTotals();
  }

  function focusFirstInvalidField() {
    const invalidField = document.querySelector('#purchase-form .is-invalid');
    if (!invalidField) return;
    invalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    if (typeof invalidField.focus === 'function') {
      invalidField.focus({ preventScroll: true });
    }
  }

  document.body.addEventListener('htmx:afterSwap', (evt) => {
    if (evt.target && swapZoneIds.has(evt.target.id)) {
      refreshFormState();
      if (state.form && window.pristineInstances?.has(state.form)) {
        window.pristineInstances.get(state.form).validate();
      }
    }
  });

  document.body.addEventListener('htmx:responseError', (event) => {
    const triggerElement = event.detail?.requestConfig?.elt;
    if (!triggerElement || triggerElement.id !== 'purchase-form') return;
    const panel = document.getElementById('purchase-form-panel');
    if (!panel) return;
    const html = event.detail?.xhr?.response;
    if (!html) return;
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const replacement = doc.getElementById('purchase-form-panel');
    if (replacement) {
      panel.replaceWith(replacement);
      refreshFormState();
      focusFirstInvalidField();
    }
  });

  refreshFormState();
})();
</script>
{% endblock %}
