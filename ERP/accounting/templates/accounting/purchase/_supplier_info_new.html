{% load widget_tweaks %}
{% url 'accounting:api_vendor_summary' 0 as vendor_summary_url_template %}

<div class="card border-0 shadow-sm mb-3">
  <div class="card-body p-3">
    
    <!-- Row 1: Invoice Number, Vendor, Payment Mode -->
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label class="form-label small text-muted">Invoice Number</label>
        {% if form.invoice_number %}
          {{ form.invoice_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Vendor <span class="text-danger">*</span></label>
        {% if form.vendor %}
          {{ form.vendor|add_class:"form-select form-select-sm vendor-select" }}
        {% endif %}
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Payment Mode</label>
        {% if form.payment_mode %}
          {{ form.payment_mode|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- Row 2: Invoice Date, Due Days, Due Date, Payment Term -->
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label class="form-label small text-muted">Invoice Date <span class="text-danger">*</span></label>
        {% if form.invoice_date %}
          {% with invoice_class=form.invoice_date.errors|yesno:"form-control form-control-sm is-invalid,form-control form-control-sm" %}
            {% render_field form.invoice_date class=invoice_class %}
          {% endwith %}
          {% if form.invoice_date.errors %}
            {% for error in form.invoice_date.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Due Days</label>
        <input type="number" class="form-control form-control-sm" id="due_days" name="due_days" min="0" value="{{ due_days|default:0 }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Due Date</label>
        {% if form.due_date %}
          {% with due_class=form.due_date.errors|yesno:"form-control form-control-sm is-invalid,form-control form-control-sm" %}
            {% render_field form.due_date class=due_class %}
          {% endwith %}
          {% if form.due_date.errors %}
            {% for error in form.due_date.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Payment Term</label>
        {% if form.payment_term %}
          {{ form.payment_term|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- Row 2: Vendor Summary (Dynamic, loaded via HTMX) -->
    <div id="vendor-summary" class="alert alert-light border border-light small py-2 px-3 mb-2" style="display: none;">
      <div class="row g-2">
        <div class="col-md-3"><small class="text-muted">Outstanding:</small><div class="money fw-semibold" id="vendor-balance">-</div></div>
        <div class="col-md-3"><small class="text-muted">Terms:</small><div id="vendor-terms">-</div></div>
        <div class="col-md-3"><small class="text-muted">Last Invoice:</small><div id="vendor-last-inv">-</div></div>
        <div class="col-md-3"><small class="text-muted">Status:</small><div id="vendor-status">-</div></div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-md-4"><small class="text-muted">Tax/PAN No:</small><div id="vendor-pan">-</div></div>
        <div class="col-md-4"><small class="text-muted">Credit Limit:</small><div id="vendor-limit">-</div></div>
        <div class="col-md-4"><small class="text-muted">Available Credit:</small><div id="vendor-available">-</div></div>
      </div>
    </div>

    <!-- Row 3: Supplier Invoice No, Supplier Ref, Purchase Order -->
    <div class="row g-2 mb-2">
      <div class="col-md-3">
        <label class="form-label small text-muted">Supplier Invoice #</label>
        {% if form.supplier_invoice_number %}
          {{ form.supplier_invoice_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">External Reference</label>
        {% if form.external_reference %}
          {{ form.external_reference|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Purchase Order</label>
        <div class="d-flex gap-1">
          {% if form.purchase_order %}
            {{ form.purchase_order|add_class:"form-select form-select-sm" }}
          {% endif %}
          <button type="button" class="btn btn-sm btn-outline-primary" 
            hx-post="{% url 'accounting:purchase_apply_order_hx' %}" 
            hx-include="#purchase-form" 
            hx-vals='{"prefix":"items","variant":"enhanced"}'
            hx-target="#items-tbody" 
            hx-swap="beforeend">Apply</button>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">PO Number</label>
        {% if form.po_number %}
          {{ form.po_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- More Options (collapsible) -->
    <div class="d-flex justify-content-end mb-2">
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#pi-more-options" aria-expanded="false" aria-controls="pi-more-options">
        <i class="bi bi-sliders"></i> More options
      </button>
    </div>

    <div class="collapse" id="pi-more-options">
      <div class="card card-body border-0 p-3 shadow-sm">
        <div class="row g-3 mb-2">
          <div class="col-md-3">
            <label class="form-label small text-muted">Purchase Account</label>
            {% if form.purchase_account %}
              {{ form.purchase_account|add_class:"form-select form-select-sm" }}
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Agent</label>
            <select class="form-select form-select-sm" name="agent_id" id="agent_id">
              <option value="">- Select Agent -</option>
              {% for agent in agents %}
                <option value="{{ agent.id }}" {% if selected_agent_id|stringformat:"s" == agent.id|stringformat:"s" %}selected{% endif %}>{{ agent.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Agent Area</label>
            <select class="form-select form-select-sm" name="agent_area_id" id="agent_area_id">
              <option value="">- Select Area -</option>
              {% for area in areas %}
                <option value="{{ area.id }}" {% if selected_area_id|stringformat:"s" == area.id|stringformat:"s" %}selected{% endif %}>{{ area.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small text-muted">Currency</label>
            {% if form.currency %}
              {{ form.currency|add_class:"form-select form-select-sm" }}
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Exchange Rate</label>
            {% if form.exchange_rate %}
              {{ form.exchange_rate|add_class:"form-control form-control-sm text-end" }}
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Warehouse</label>
            {% if form.warehouse and form.warehouse.field.queryset %}
              {{ form.warehouse|add_class:"form-select form-select-sm" }}
            {% endif %}
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">GR/IR Account</label>
            {% if form.grir_account and form.grir_account.field.queryset %}
              {{ form.grir_account|add_class:"form-select form-select-sm" }}
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JavaScript to load vendor summary when vendor changes -->
<script>
(function () {
  if (window.purchaseVendorSummaryInit) return;
  window.purchaseVendorSummaryInit = true;
  const vendorSummaryUrlTemplate = "{{ vendor_summary_url_template|default:''|escapejs }}";
  const dueDaysField = document.getElementById('due_days');
  const invoiceDateField = document.getElementById('id_invoice_date');
  const dueDateField = document.getElementById('id_due_date');
  const dueDateBsField = document.getElementById('id_due_date_bs');
  let bsSyncAttempts = 0;
  const maxBsSyncAttempts = 4;

  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('vendor-select')) {
      const vendorId = e.target.value;
      const summaryDiv = document.getElementById('vendor-summary');
      const supplierInfoDiv = document.getElementById('supplier-info');
      
      if (vendorId) {
        fetch(`/accounting/purchase-invoice/load-vendor/${vendorId}/`)
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              if (supplierInfoDiv) {
                const infoText = data.supplier_info || '';
                supplierInfoDiv.innerHTML = infoText || '- Supplier details unavailable -';
                supplierInfoDiv.style.display = infoText ? 'block' : 'block';
              }
              const agentSelect = document.getElementById('agent_id');
              if (agentSelect && data.agent_id) agentSelect.value = String(data.agent_id);
              const areaSelect = document.getElementById('agent_area_id');
              if (areaSelect && data.area_id) areaSelect.value = String(data.area_id);
              if (dueDaysField && data.due_days !== undefined && data.due_days !== null) {
                dueDaysField.value = data.due_days;
                recalcDueDate();
              }
            }
          })
          .catch(() => {});
        const summaryUrl = vendorSummaryUrlTemplate
          ? vendorSummaryUrlTemplate.replace('/0/', `/${vendorId}/`)
          : '';
        if (summaryUrl) {
          fetch(summaryUrl)
            .then(r => {
              if (!r.ok) throw new Error('Failed to load vendor summary');
              return r.json();
            })
            .then(data => {
              const asMoney = (v) => {
                const n = parseFloat(v);
                return Number.isFinite(n) ? n.toFixed(2) : '-';
              };
              const orDash = (v) => (v === null || v === undefined || v === '' ? '-' : v);

              document.getElementById('vendor-balance').textContent = asMoney(data.outstanding_balance);
              document.getElementById('vendor-terms').textContent = orDash(data.payment_terms);
              document.getElementById('vendor-last-inv').textContent = orDash(data.last_invoice_date);
              const statusText = orDash(data.status);
              const holdFlag = data.on_hold ? ' (On Hold)' : '';
              document.getElementById('vendor-status').textContent = statusText + holdFlag;
              document.getElementById('vendor-pan').textContent = orDash(data.tax_id);
              document.getElementById('vendor-limit').textContent = data.credit_limit === null ? '-' : asMoney(data.credit_limit);
              document.getElementById('vendor-available').textContent = data.available_credit === null ? '-' : asMoney(data.available_credit);
              // Auto-select payment term if available
              if (data.payment_term_id) {
                const ptSelect = document.getElementById('{{ form.payment_term.id_for_label|default:"id_payment_term" }}');
                if (ptSelect && !ptSelect.value) {
                  ptSelect.value = String(data.payment_term_id);
                }
              }
              summaryDiv.style.display = 'block';
            })
            .catch(() => summaryDiv.style.display = 'none');
        } else {
          summaryDiv.style.display = 'none';
        }
      } else {
        summaryDiv.style.display = 'none';
        if (supplierInfoDiv) {
          supplierInfoDiv.innerHTML = '- Select a vendor to view credit summary -';
          supplierInfoDiv.style.display = 'block';
        }
      }
    }
  });

  const toIsoDateString = (value) => {
    if (!value) return '';
    if (typeof value === 'string') return value;
    if (value instanceof Date) {
      return value.toISOString().slice(0, 10);
    }
    if (typeof value === 'object' && 'year' in value && 'month' in value && 'day' in value) {
      const pad = (num) => String(num).padStart(2, '0');
      return `${value.year}-${pad(value.month)}-${pad(value.day)}`;
    }
    return '';
  };

  function setDueDateFromDate(date) {
    if (!date || Number.isNaN(date.getTime())) return;
    const isoValue = toIsoDateString(date);
    if (!isoValue) return;
    if (dueDateField) {
      if (dueDateField.type === 'date' && typeof dueDateField.valueAsDate !== 'undefined') {
        dueDateField.valueAsDate = date;
      } else {
        dueDateField.value = isoValue;
      }
      const changeEvent = new Event('change', { bubbles: true });
      const inputEvent = new Event('input', { bubbles: true });
      dueDateField.dispatchEvent(changeEvent);
      dueDateField.dispatchEvent(inputEvent);
    }
    syncBsField(date);
    }

  function syncBsField(date) {
    if (!dueDateBsField) return;
    const isoValue = toIsoDateString(date);
    if (!isoValue) return;
    if (!window.NepaliFunctions || typeof window.NepaliFunctions.AD2BS !== 'function') {
      if (bsSyncAttempts < maxBsSyncAttempts) {
        bsSyncAttempts += 1;
        setTimeout(() => syncBsField(date), 250);
      }
      return;
    }
    try {
      const converted = window.NepaliFunctions.AD2BS(isoValue);
      const bsString = toIsoDateString(converted);
      if (bsString) {
        dueDateBsField.value = bsString;
        bsSyncAttempts = 0;
      }
    } catch (err) {
      console.warn('Failed to convert AD to BS date', err);
    }
  }

  function recalcDueDate() {
    if (!dueDaysField || !invoiceDateField || !dueDateField) return;
    const days = parseInt(dueDaysField.value, 10);
    const base = new Date(invoiceDateField.value);
    if (Number.isNaN(days) || Number.isNaN(base.getTime())) return;
    const dt = new Date(base);
    dt.setDate(dt.getDate() + days);
    setDueDateFromDate(dt);
  }

  function updateDueDaysFromDueDate() {
    if (!dueDaysField || !invoiceDateField || !dueDateField) return;
    const invDate = new Date(invoiceDateField.value);
    const dueDate = new Date(dueDateField.value);
    if (Number.isNaN(invDate.getTime()) || Number.isNaN(dueDate.getTime())) return;
    const diffMs = dueDate - invDate;
    const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
    dueDaysField.value = diffDays >= 0 ? diffDays : 0;
  }

  if (dueDaysField) {
    dueDaysField.addEventListener('input', recalcDueDate);
    dueDaysField.addEventListener('change', recalcDueDate);
    dueDaysField.addEventListener('keydown', function(evt) {
      if (evt.key === 'Enter' || evt.key === 'NumpadEnter') {
        evt.preventDefault();
        recalcDueDate();
      }
    });
  }
  if (invoiceDateField) {
    invoiceDateField.addEventListener('change', recalcDueDate);
    invoiceDateField.addEventListener('blur', recalcDueDate);
    invoiceDateField.addEventListener('input', recalcDueDate);
  }

  if (dueDateField) {
    dueDateField.addEventListener('change', updateDueDaysFromDueDate);
    dueDateField.addEventListener('input', updateDueDaysFromDueDate);
  }
})();
</script>
