{% load widget_tweaks %}
{% url 'accounting:api_vendor_summary' 0 as vendor_summary_url_template %}

<div class="card border-0 shadow-sm mb-3">
  <div class="card-body p-3">
    
    <!-- Row 1: Invoice Number, Vendor, Payment Mode -->
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label class="form-label small text-muted">Invoice Number</label>
        {% if form.invoice_number %}
          {{ form.invoice_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Vendor <span class="text-danger">*</span></label>
        {% if form.vendor %}
          {{ form.vendor|add_class:"form-select form-select-sm vendor-select" }}
        {% endif %}
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Payment Mode</label>
        {% if form.payment_mode %}
          {{ form.payment_mode|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- Row 2: Invoice Date, Due Days, Due Date, Payment Term -->
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label class="form-label small text-muted">Invoice Date <span class="text-danger">*</span></label>
        {% if form.invoice_date %}
          {% with invoice_class=form.invoice_date.errors|yesno:"form-control form-control-sm is-invalid,form-control form-control-sm" %}
            {% render_field form.invoice_date class=invoice_class %}
          {% endwith %}
          {% if form.invoice_date.errors %}
            {% for error in form.invoice_date.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Due Days</label>
        <input type="number" class="form-control form-control-sm" id="due_days" name="due_days" min="0" value="0">
      </div>
      <div class="col-md-2">
        <label class="form-label small text-muted">Due Date</label>
        {% if form.due_date %}
          {% with due_class=form.due_date.errors|yesno:"form-control form-control-sm is-invalid,form-control form-control-sm" %}
            {% render_field form.due_date class=due_class %}
          {% endwith %}
          {% if form.due_date.errors %}
            {% for error in form.due_date.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Payment Term</label>
        {% if form.payment_term %}
          {{ form.payment_term|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- Row 2: Vendor Summary (Dynamic, loaded via HTMX) -->
    <div id="vendor-summary" class="alert alert-light border border-light small py-2 px-3 mb-2" style="display: none;">
      <div class="row g-2">
        <div class="col-md-3"><small class="text-muted">Outstanding:</small><div class="money fw-semibold" id="vendor-balance">-</div></div>
        <div class="col-md-3"><small class="text-muted">Terms:</small><div id="vendor-terms">-</div></div>
        <div class="col-md-3"><small class="text-muted">Last Invoice:</small><div id="vendor-last-inv">-</div></div>
        <div class="col-md-3"><small class="text-muted">Status:</small><div id="vendor-status">-</div></div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-md-4"><small class="text-muted">Tax/PAN No:</small><div id="vendor-pan">-</div></div>
        <div class="col-md-4"><small class="text-muted">Credit Limit:</small><div id="vendor-limit">-</div></div>
        <div class="col-md-4"><small class="text-muted">Available Credit:</small><div id="vendor-available">-</div></div>
      </div>
    </div>
    <!-- Row 3: Supplier Invoice No, Supplier Ref, Purchase Order -->
    <div class="row g-2 mb-2">
      <div class="col-md-3">
        <label class="form-label small text-muted">Supplier Invoice #</label>
        {% if form.supplier_invoice_number %}
          {{ form.supplier_invoice_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">External Reference</label>
        {% if form.external_reference %}
          {{ form.external_reference|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Purchase Order</label>
        <div class="d-flex gap-1">
          {% if form.purchase_order %}
            {{ form.purchase_order|add_class:"form-select form-select-sm" }}
          {% endif %}
          <button type="button" class="btn btn-sm btn-outline-primary" 
            hx-post="{% url 'accounting:purchase_apply_order_hx' %}" 
            hx-include="#purchase-form" 
            hx-vals='{"prefix":"items","variant":"enhanced"}'
            hx-target="#items-tbody" 
            hx-swap="beforeend">Apply</button>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">PO Number</label>
        {% if form.po_number %}
          {{ form.po_number|add_class:"form-control form-control-sm" }}
        {% endif %}
      </div>
    </div>

    <!-- Row 4: Purchase Account, Agent Area, Invoice Date (BS) -->
    <div class="row g-2 mb-2">
      <div class="col-md-3">
        <label class="form-label small text-muted">Purchase Account</label>
        {% if form.purchase_account %}
          {{ form.purchase_account|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Agent</label>
        <select class="form-select form-select-sm" name="agent_id" id="agent_id">
          <option value="">- Select Agent -</option>
          {% for agent in agents %}
            <option value="{{ agent.id }}">{{ agent.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Agent Area</label>
        <select class="form-select form-select-sm" name="agent_area_id" id="agent_area_id">
          <option value="">- Select Area -</option>
          {% for area in areas %}
            <option value="{{ area.id }}">{{ area.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Row 5: Due Days -->
    <div class="row g-2 mb-2">
      <div class="col-md-3">
        <label class="form-label small text-muted">Due Days</label>
        <input type="number" class="form-control form-control-sm" id="due_days" name="due_days" min="0" value="0">
      </div>
    </div>

    <!-- Row 6: Currency, Exchange Rate, Warehouse, GR/IR Account -->
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label small text-muted">Currency</label>
        {% if form.currency %}
          {{ form.currency|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Exchange Rate</label>
        {% if form.exchange_rate %}
          {{ form.exchange_rate|add_class:"form-control form-control-sm text-end" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Warehouse</label>
        {% if form.warehouse and form.warehouse.field.queryset %}
          {{ form.warehouse|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">GR/IR Account</label>
        {% if form.grir_account and form.grir_account.field.queryset %}
          {{ form.grir_account|add_class:"form-select form-select-sm" }}
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- JavaScript to load vendor summary when vendor changes -->
<script>
(function () {
  if (window.purchaseVendorSummaryInit) return;
  window.purchaseVendorSummaryInit = true;
  const vendorSummaryUrlTemplate = "{{ vendor_summary_url_template|default:''|escapejs }}";

  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('vendor-select')) {
      const vendorId = e.target.value;
      const summaryDiv = document.getElementById('vendor-summary');
      const supplierInfoDiv = document.getElementById('supplier-info');
      
      if (vendorId) {
        fetch(`/accounting/purchase-invoice/load-vendor/${vendorId}/`)
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              if (supplierInfoDiv) {
                supplierInfoDiv.textContent = data.supplier_info || '';
                supplierInfoDiv.style.display = data.supplier_info ? 'block' : 'none';
              }
              const agentSelect = document.getElementById('agent_id');
              if (agentSelect && data.agent_id) agentSelect.value = String(data.agent_id);
              const areaSelect = document.getElementById('agent_area_id');
              if (areaSelect && data.area_id) areaSelect.value = String(data.area_id);
              const dueDaysInput = document.getElementById('due_days');
              if (dueDaysInput && data.due_days) dueDaysInput.value = data.due_days;
              const invoiceDateInput = document.getElementById('id_invoice_date');
              const dueDateInput = document.getElementById('id_due_date');
              if (invoiceDateInput && dueDateInput && data.due_days) {
                const baseDate = new Date(invoiceDateInput.value);
                if (!isNaN(baseDate.getTime())) {
                  baseDate.setDate(baseDate.getDate() + parseInt(data.due_days, 10));
                  if (dueDateInput.type === 'date') {
                    dueDateInput.valueAsDate = baseDate;
                  } else {
                    dueDateInput.value = baseDate.toISOString().slice(0, 10);
                  }
                }
              }
            }
          })
          .catch(() => {});
        const summaryUrl = vendorSummaryUrlTemplate
          ? vendorSummaryUrlTemplate.replace('/0/', `/${vendorId}/`)
          : '';
        if (summaryUrl) {
          fetch(summaryUrl)
            .then(r => {
              if (!r.ok) throw new Error('Failed to load vendor summary');
              return r.json();
            })
            .then(data => {
              const asMoney = (v) => {
                const n = parseFloat(v);
                return Number.isFinite(n) ? n.toFixed(2) : '-';
              };
              const orDash = (v) => (v === null || v === undefined || v === '' ? '-' : v);

              document.getElementById('vendor-balance').textContent = asMoney(data.outstanding_balance);
              document.getElementById('vendor-terms').textContent = orDash(data.payment_terms);
              document.getElementById('vendor-last-inv').textContent = orDash(data.last_invoice_date);
              const statusText = orDash(data.status);
              const holdFlag = data.on_hold ? ' (On Hold)' : '';
              document.getElementById('vendor-status').textContent = statusText + holdFlag;
              document.getElementById('vendor-pan').textContent = orDash(data.tax_id);
              document.getElementById('vendor-limit').textContent = data.credit_limit === null ? '-' : asMoney(data.credit_limit);
              document.getElementById('vendor-available').textContent = data.available_credit === null ? '-' : asMoney(data.available_credit);
              // Auto-select payment term if available
              if (data.payment_term_id) {
                const ptSelect = document.getElementById('{{ form.payment_term.id_for_label|default:"id_payment_term" }}');
                if (ptSelect && !ptSelect.value) {
                  ptSelect.value = String(data.payment_term_id);
                }
              }
              summaryDiv.style.display = 'block';
            })
            .catch(() => summaryDiv.style.display = 'none');
        } else {
          summaryDiv.style.display = 'none';
        }
      } else {
        summaryDiv.style.display = 'none';
        if (supplierInfoDiv) supplierInfoDiv.style.display = 'none';
      }
    }
  });

  function recalcDueDate() {
    const daysInput = document.getElementById('due_days');
    const invInput = document.getElementById('id_invoice_date');
    const dueInput = document.getElementById('id_due_date');
    if (!daysInput || !invInput || !dueInput) return;
    const days = parseInt(daysInput.value, 10);
    const base = new Date(invInput.value);
    if (Number.isNaN(days) || Number.isNaN(base.getTime())) return;
    const dt = new Date(base);
    dt.setDate(dt.getDate() + days);
    const iso = dt.toISOString().slice(0, 10);
    if (dueInput.type === 'date') {
      dueInput.valueAsDate = dt;
    } else {
      dueInput.value = iso;
    }
  }

  const dueDaysField = document.getElementById('due_days');
  const invoiceDateField = document.getElementById('id_invoice_date');
  if (dueDaysField) {
    dueDaysField.addEventListener('input', recalcDueDate);
    dueDaysField.addEventListener('change', recalcDueDate);
  }
  if (invoiceDateField) {
    invoiceDateField.addEventListener('change', recalcDueDate);
    invoiceDateField.addEventListener('blur', recalcDueDate);
  }

  const dueInput = document.getElementById('id_due_date');
  if (dueInput) {
    dueInput.addEventListener('change', function() {
      const invInput = document.getElementById('id_invoice_date');
      const daysInput = document.getElementById('due_days');
      if (!invInput || !daysInput) return;
      const invDate = new Date(invInput.value);
      const dueDate = new Date(dueInput.value);
      if (Number.isNaN(invDate.getTime()) || Number.isNaN(dueDate.getTime())) return;
      const diffMs = dueDate - invDate;
      const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
      daysInput.value = diffDays >= 0 ? diffDays : 0;
    });
  }
})();
</script>
