{% extends "partials/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="{% static 'accounting/css/voucher.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-bottom mb-4">
        <div class="container py-3">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h4 mb-0">{{ page_title }}</h1>
                    <p class="small text-muted mb-0">Create a new {{ config.name }} voucher</p>
                </div>
                <div class="col-auto">
                    <a href="{% url 'accounting:generic_voucher_select' %}" class="btn btn-outline-secondary btn-sm me-2">Change Type</a>
                    <button type="submit" form="voucher-form" class="btn btn-primary btn-sm">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-4">
        <form id="voucher-form" method="post" action="">
            {% csrf_token %}
            
            <!-- Header Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Header Information</h5>
                </div>
                <div class="card-body">
                    {{ header_form|crispy }}
                </div>
            </div>

            <!-- Lines Formset -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Line Items</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-line-btn">
                        <i class="fas fa-plus"></i> Add Line
                    </button>
                </div>
                <div class="card-body">
                    <div id="lines-container">
                        {{ line_formset.management_form }}
                        {% for form in line_formset %}
                        <div class="line-item mb-3 p-3 border rounded">
                            <div class="row">
                                <div class="col-md-11">
                                    {{ form|crispy }}
                                </div>
                                <div class="col-md-1 d-flex align-items-center">
                                    {% if line_formset.can_delete %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="card">
                <div class="card-body text-end">
                    <a href="{% url 'accounting:generic_voucher_select' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save {{ config.name }}</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for select fields
    $('select').select2({
        theme: 'bootstrap-5'
    });

    // Add line functionality
    $('#add-line-btn').click(function() {
        var formset = $('#lines-container');
        var totalForms = $('#id_lines-TOTAL_FORMS');
        var formNum = parseInt(totalForms.val());
        
        // Clone the last line
        var lastLine = $('.line-item').last();
        var newLine = lastLine.clone();
        
        // Update form indices
        newLine.find('input, select, textarea').each(function() {
            var name = $(this).attr('name');
            if (name) {
                $(this).attr('name', name.replace(/-\d+-/, '-' + formNum + '-'));
                $(this).attr('id', $(this).attr('id').replace(/_\d+_/, '_' + formNum + '_'));
            }
            $(this).val(''); // Clear values
        });
        
        // Update form number
        totalForms.val(formNum + 1);
        
        // Append new line
        formset.append(newLine);
        
        // Re-initialize Select2
        newLine.find('select').select2({
            theme: 'bootstrap-5'
        });
    });

    // Remove line functionality
    $(document).on('click', '.remove-line-btn', function() {
        var lineItem = $(this).closest('.line-item');
        var deleteCheckbox = lineItem.find('input[type="checkbox"][name$="-DELETE"]');
        if (deleteCheckbox.length) {
            deleteCheckbox.prop('checked', true);
            lineItem.hide();
        } else {
            lineItem.remove();
        }
    });
});
</script>
{% endblock %}
{% endblock %}