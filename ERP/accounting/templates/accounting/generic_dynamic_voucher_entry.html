{% extends "partials/base.html" %}
{% load static %}
{% load generic_voucher_tags %}
{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/generic_voucher_entry.css' %}">
<link rel="stylesheet" href="{% static 'accounting/css/voucher_entry.css' %}">
<link rel="stylesheet" href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}">
{{ header_form.media }}
{{ line_formset.media }}
{% endblock %}

{% block content %}

<div class="main-content compact-page generic-voucher-shell">
<div class="page-content">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-start justify-content-between gap-2">
                    <div>
                        <p class="text-muted small mb-1">Dynamic Voucher &middot; {{ config.code }}</p>
                        <h4 class="mb-0">{{ config.name }}</h4>
                        <p class="text-muted small mb-0">
                            This view renders a configuration-driven voucher entry experience.
                            {% if journal_type_name %}<span class="ms-1">Journal Type: {{ journal_type_name }}</span>{% endif %}
                        </p>
                    </div>
                    <div class="d-flex gap-1 flex-wrap">
                        <a href="{% url 'accounting:generic_voucher_select' %}" class="btn btn-outline-secondary btn-sm">Change Type</a>
                        <button type="submit" form="voucher-form" class="btn btn-primary btn-sm" data-action="save" data-role="save-draft"{% if draft_saved %} disabled{% endif %}>Save Draft</button>
                        {% if can_submit %}
                            <button type="submit" form="voucher-form" class="btn btn-outline-primary btn-sm" data-action="submit_voucher">Submit for Approval</button>
                        {% endif %}
                        {% if can_post %}
                            <button type="submit" form="voucher-form" class="btn btn-success btn-sm" data-action="post_voucher">Post Now</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% include "accounting/partials/generic_voucher_form_panel.html" %}
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'libs/sweetalert2/dist/sweetalert2.min.js' %}"></script>
<script src="{% static 'js/generic_voucher_entry.js' %}"></script>
<script>
    (function () {
        const initVoucherForm = () => {
            const form = document.getElementById('voucher-form');
            const actionInput = document.getElementById('voucher-action');
            const tracker = document.getElementById('process-tracker');
            const trackerNote = document.getElementById('process-tracker-note');
            if (!form || !actionInput || !tracker) return;

            const setStepState = (step, state) => {
                const el = tracker.querySelector(`[data-step="${step}"]`);
                if (!el) return;
                el.classList.remove('bg-secondary', 'bg-success', 'bg-danger', 'bg-info');
                if (state === 'active') el.classList.add('bg-info');
                if (state === 'done') el.classList.add('bg-success');
                if (state === 'fail') el.classList.add('bg-danger');
                if (state === 'pending') el.classList.add('bg-secondary');
            };

            const applyAction = (action) => {
                actionInput.value = action || 'save';
                setStepState('save', 'active');
                setStepState('journal', 'pending');
                setStepState('post', 'pending');
                setStepState('inventory', 'pending');
                setStepState('complete', 'pending');
                if (trackerNote) {
                    if (action === 'post_voucher') trackerNote.textContent = 'Posting flow started.';
                    else if (action === 'submit_voucher') trackerNote.textContent = 'Submitting for approval.';
                    else trackerNote.textContent = 'Saving draft.';
                }
            };

            const toggleActions = (disabled) => {
                document.querySelectorAll('[data-action]').forEach((btn) => {
                    btn.disabled = disabled;
                });
            };

            document.querySelectorAll('[data-action]').forEach((btn) => {
                btn.addEventListener('click', () => applyAction(btn.dataset.action));
            });

            form.addEventListener('submit', () => {
                const action = actionInput.value || 'save';
                applyAction(action);
                toggleActions(true);
            });

            const setDraftState = (state) => {
                const draftButtons = document.querySelectorAll('[data-role="save-draft"]');
                const submitButtons = document.querySelectorAll('[data-action="submit_voucher"]');
                const postButtons = document.querySelectorAll('[data-action="post_voucher"]');
                if (state === 'draft_saved') {
                    draftButtons.forEach(btn => { btn.disabled = true; });
                    submitButtons.forEach(btn => { btn.disabled = false; });
                    postButtons.forEach(btn => { btn.disabled = false; });
                } else {
                    draftButtons.forEach(btn => { btn.disabled = false; });
                }
            };

            const showPostSuccessModal = (payload) => {
                if (!payload || !window.Swal) return;
                const detailUrl = payload.detail_url;
                const createUrl = payload.create_url;
                Swal.fire({
                    title: 'Voucher posted',
                    text: 'What would you like to do next?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'View Detail',
                    cancelButtonText: 'Create New',
                    confirmButtonColor: '#1c84ee',
                    cancelButtonColor: '#47bd9a',
                }).then((result) => {
                    if (result.isConfirmed && detailUrl) {
                        window.location.href = detailUrl;
                    } else if (createUrl) {
                        window.location.href = createUrl;
                    }
                });
            };

            const handleTrigger = (detail) => {
                const trigger = detail.xhr && detail.xhr.getResponseHeader('HX-Trigger');
                if (!trigger) return;
                let data = null;
                try {
                    data = JSON.parse(trigger);
                } catch (err) {
                    return;
                }
                const saveState = data['voucher:save'];
                const journalState = data['voucher:journal'];
                const postState = data['voucher:post'];
                const invState = data['voucher:inventory'];
                const completeState = data['voucher:complete'];
                if (saveState) setStepState('save', saveState);
                if (journalState) setStepState('journal', journalState);
                if (postState) setStepState('post', postState);
                if (invState) setStepState('inventory', invState);
                if (completeState) setStepState('complete', completeState);
                if (trackerNote && data['voucher:message']) {
                    trackerNote.textContent = data['voucher:message'];
                }
                if (data['voucher:state']) {
                    setDraftState(data['voucher:state']);
                }
                if (data['voucher:post_success']) {
                    showPostSuccessModal(data['voucher:post_success']);
                }
            };

            document.body.addEventListener('htmx:afterRequest', (evt) => {
                handleTrigger(evt.detail);
                toggleActions(false);
            });
            document.body.addEventListener('htmx:responseError', (evt) => {
                handleTrigger(evt.detail);
                toggleActions(false);
            });
        };

        initVoucherForm();
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            if (evt.detail && evt.detail.target && evt.detail.target.id === 'generic-voucher-panel') {
                initVoucherForm();
            }
        });
    })();
</script>
{% endblock %}
