{% extends "partials/base.html" %}
{% load static %}
{% load generic_voucher_tags %}
{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/generic_voucher_entry.css' %}">
<link rel="stylesheet" href="{% static 'accounting/css/voucher_entry.css' %}">
<link rel="stylesheet" href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}">
{{ header_form.media }}
{{ line_formset.media }}
<style>
  /* ===== Compact, production-safe UI tweaks (Bootstrap-friendly) ===== */

  .gv-page { --gv-pad: .75rem; --gv-radius: .85rem; --gv-border: rgba(0,0,0,.08); }

  .gv-toolbar {
    padding: .75rem 0 .5rem;
    border-bottom: 1px solid var(--gv-border);
    backdrop-filter: saturate(180%) blur(6px);
    z-index: 1030; /* above tables */
  }

  .gv-title { font-size: 1.15rem; line-height: 1.15; }
  .gv-badge { font-weight: 600; letter-spacing: .02em; }

  .gv-stepper {
    display: flex;
    gap: .5rem;
    overflow: auto;
    padding-bottom: .25rem;
    scrollbar-width: thin;
  }

  .gv-card { border-radius: var(--gv-radius); }
  .gv-card-body { padding: var(--gv-pad); }
  .gv-card-header { padding: .6rem var(--gv-pad) .4rem; }

  .gv-label { font-size: .78rem; color: rgba(0,0,0,.72); font-weight: 600; }

  /* Description: compact default, expand on focus for speed */
  .gv-desc { resize: vertical; max-height: 6rem; transition: all .12s ease-in-out; }
  .gv-desc:focus { min-height: 5.5rem; }

  /* Grid: maximize usable area */
  .gv-table-wrap { border-radius: .65rem; overflow: auto; border: 1px solid var(--gv-border); }
  .gv-grid { margin: 0; }
  .gv-grid th, .gv-grid td { vertical-align: middle; }
  .gv-grid th { position: sticky; top: 0; z-index: 2; }

  /* Sticky first and last columns */
  .gv-sticky-start { position: sticky; left: 0; background: var(--bs-body-bg); z-index: 3; }
  .gv-sticky-end { position: sticky; right: 0; background: var(--bs-body-bg); z-index: 3; }

  .gv-col-n { width: 44px; min-width: 44px; }
  .gv-col-act { width: 56px; min-width: 56px; }
  .gv-col-desc { min-width: 240px; }
  .gv-col-amt { width: 132px; min-width: 132px; }
  .gv-col-lookup { min-width: 180px; }

  /* Cells: tighter but still usable */
  .gv-cell { padding-top: .25rem; padding-bottom: .25rem; }
  .gv-amt { text-align: right; font-variant-numeric: tabular-nums; }

  /* Icon buttons: compact hit-area without looking cramped */
  .gv-icon-btn { width: 34px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }

  /* Summary: sticky, compact metrics */
  .gv-summary { padding: .55rem var(--gv-pad); }
  .gv-metric { display: grid; gap: .05rem; }
  .gv-metric-label { font-size: .7rem; text-transform: uppercase; letter-spacing: .04em; color: rgba(0,0,0,.55); }
  .gv-metric-value { font-weight: 700; font-variant-numeric: tabular-nums; }

  /* Mini keyboard hint badges */
  .gv-kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    padding: 0 .35rem;
    height: 20px;
    font-size: .72rem;
    border: 1px solid var(--gv-border);
    border-bottom-width: 2px;
    border-radius: .35rem;
    background: rgba(0,0,0,.02);
  }

  /* Reduce default Bootstrap table border heaviness */
  .table-bordered > :not(caption) > * { border-color: rgba(0,0,0,.07); }

  /* Mobile ergonomics */
  @media (max-width: 576px) {
    .gv-title { font-size: 1.05rem; }
    .gv-col-desc { min-width: 200px; }
    .gv-col-lookup { min-width: 160px; }
  }
</style>
{% endblock %}

{% block content %}
{% url 'accounting:generic_voucher_select' as default_change_type_url %}
<div class="main-content">

<div class="page-content gv-page">
  <div class="container-fluid">

    <!-- Sticky top toolbar: title + primary actions (minimum vertical space) -->
    <div class="gv-toolbar sticky-top bg-body" role="region" aria-label="Voucher toolbar">
      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <div class="min-w-0">
          <div class="d-flex align-items-center gap-2">
            <span class="badge text-bg-light gv-badge">Dynamic Voucher - {{ config.code }}</span>
            <span class="text-muted small d-none d-md-inline">{{ config.name }}</span>
          </div>
          <h4 class="mb-0 mt-1 gv-title">{{ config.name }}</h4>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <!-- Compact stepper toggle -->
          <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#process-tracker" aria-expanded="false" aria-controls="process-tracker">
            <i class="fas fa-route me-1"></i>Process
          </button>

          <a href="{{ change_type_url|default:default_change_type_url }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-exchange-alt me-1"></i>Change Type
          </a>

          <!-- Primary actions (kept visible) -->
          <div class="btn-group" role="group" aria-label="Voucher actions">
            <button type="submit" form="voucher-form" class="btn btn-primary btn-sm" data-action="save" data-role="save-draft"{% if draft_saved or voucher_status == 'awaiting_approval' or voucher_status == 'posted' %} disabled{% endif %}>
              <i class="fas fa-save me-1"></i>Save Draft
            </button>
            {% if can_submit %}
            <button type="submit" form="voucher-form" class="btn btn-outline-primary btn-sm" data-action="submit_voucher"{% if voucher_status == 'awaiting_approval' or voucher_status == 'posted' %} disabled{% endif %}>
              <i class="fas fa-paper-plane me-1"></i>Submit
            </button>
            {% endif %}
            {% if can_post %}
            <button type="submit" form="voucher-form" class="btn btn-success btn-sm" data-action="post_voucher"{% if voucher_status == 'posted' %} disabled{% endif %}>
              <i class="fas fa-check-circle me-1"></i>Post
            </button>
            {% endif %}
          </div>

          <!-- Optional: compact overflow menu on small screens -->
          <div class="dropdown d-md-none">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{{ change_type_url|default:default_change_type_url }}">Change Type</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item" type="submit" form="voucher-form" data-action="save">Save Draft</button></li>
              {% if can_submit %}
              <li><button class="dropdown-item" type="submit" form="voucher-form" data-action="submit_voucher">Submit</button></li>
              {% endif %}
              {% if can_post %}
              <li><button class="dropdown-item" type="submit" form="voucher-form" data-action="post_voucher">Post</button></li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Collapsible process tracker (compact, does not steal vertical space) -->
      <div class="collapse mt-2" id="process-tracker">
        <div class="gv-stepper" role="list">
          <span class="badge rounded-pill bg-secondary" data-step="save" role="listitem">1 - Saving</span>
          <span class="badge rounded-pill bg-secondary" data-step="journal" role="listitem">2 - Journal</span>
          <span class="badge rounded-pill bg-secondary" data-step="post" role="listitem">3 - GL</span>
          <span class="badge rounded-pill bg-secondary" data-step="inventory" role="listitem">4 - Inventory</span>
          <span class="badge rounded-pill bg-secondary" data-step="complete" role="listitem">5 - Done</span>
        </div>
      </div>
    </div>

    {% include "accounting/partials/generic_voucher_form_panel.html" %}
  </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'libs/sweetalert2/dist/sweetalert2.min.js' %}"></script>
<script src="{% static 'js/generic_voucher_entry.js' %}"></script>
<script>
    (function () {
        if (window.FormBase) {
            const form = document.getElementById('voucher-form');
            if (form) {
                window.FormBase.mount(form);
            }
        }
    })();

    (function () {
        const initVoucherForm = () => {
            const form = document.getElementById('voucher-form');
            const actionInput = document.getElementById('voucher-action');
            const tracker = document.getElementById('process-tracker');
            const trackerNote = document.getElementById('process-tracker-note');
            if (!form || !actionInput || !tracker) return;

            const setStepState = (step, state) => {
                const el = tracker.querySelector(`[data-step="${step}"]`);
                if (!el) return;
                el.classList.remove('bg-secondary', 'bg-success', 'bg-danger', 'bg-info');
                if (state === 'active') el.classList.add('bg-info');
                if (state === 'done') el.classList.add('bg-success');
                if (state === 'fail') el.classList.add('bg-danger');
                if (state === 'pending') el.classList.add('bg-secondary');
            };

            const applyAction = (action) => {
                actionInput.value = action || 'save';
                setStepState('save', 'active');
                setStepState('journal', 'pending');
                setStepState('post', 'pending');
                setStepState('inventory', 'pending');
                setStepState('complete', 'pending');
                if (trackerNote) {
                    if (action === 'post_voucher') trackerNote.textContent = 'Posting flow started.';
                    else if (action === 'submit_voucher') trackerNote.textContent = 'Submitting for approval.';
                    else trackerNote.textContent = 'Saving draft.';
                }
            };

            const toggleActions = (disabled) => {
                document.querySelectorAll('[data-action]').forEach((btn) => {
                    btn.disabled = disabled;
                });
            };

            document.querySelectorAll('[data-action]').forEach((btn) => {
                btn.addEventListener('click', () => applyAction(btn.dataset.action));
            });

            form.addEventListener('submit', () => {
                const action = actionInput.value || 'save';
                applyAction(action);
                toggleActions(true);
            });

            const setDraftState = (state) => {
                const draftButtons = document.querySelectorAll('[data-role="save-draft"]');
                const submitButtons = document.querySelectorAll('[data-action="submit_voucher"]');
                const postButtons = document.querySelectorAll('[data-action="post_voucher"]');
                if (state === 'draft_saved') {
                    draftButtons.forEach(btn => { btn.disabled = true; });
                    submitButtons.forEach(btn => { btn.disabled = false; });
                    postButtons.forEach(btn => { btn.disabled = false; });
                } else {
                    draftButtons.forEach(btn => { btn.disabled = false; });
                }
            };

            const showPostSuccessModal = (payload) => {
                if (!payload || !window.Swal) return;
                const detailUrl = payload.detail_url;
                const createUrl = payload.create_url;
                Swal.fire({
                    title: 'Voucher posted',
                    text: 'What would you like to do next?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'View Detail',
                    cancelButtonText: 'Create New',
                    confirmButtonColor: '#1c84ee',
                    cancelButtonColor: '#47bd9a',
                }).then((result) => {
                    if (result.isConfirmed && detailUrl) {
                        window.location.href = detailUrl;
                    } else if (createUrl) {
                        window.location.href = createUrl;
                    }
                });
            };

            const handleTrigger = (detail) => {
                const trigger = detail.xhr && detail.xhr.getResponseHeader('HX-Trigger');
                if (!trigger) return;
                let data = null;
                try {
                    data = JSON.parse(trigger);
                } catch (err) {
                    return;
                }
                const saveState = data['voucher:save'];
                const journalState = data['voucher:journal'];
                const postState = data['voucher:post'];
                const invState = data['voucher:inventory'];
                const completeState = data['voucher:complete'];
                if (saveState) setStepState('save', saveState);
                if (journalState) setStepState('journal', journalState);
                if (postState) setStepState('post', postState);
                if (invState) setStepState('inventory', invState);
                if (completeState) setStepState('complete', completeState);
                if (trackerNote && data['voucher:message']) {
                    trackerNote.textContent = data['voucher:message'];
                }
                if (data['voucher:state']) {
                    setDraftState(data['voucher:state']);
                }
                if (data['voucher:post_success']) {
                    showPostSuccessModal(data['voucher:post_success']);
                }
            };

            document.body.addEventListener('htmx:afterRequest', (evt) => {
                handleTrigger(evt.detail);
                toggleActions(false);
            });
            document.body.addEventListener('htmx:responseError', (evt) => {
                handleTrigger(evt.detail);
                toggleActions(false);
            });
        };

        initVoucherForm();
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            if (evt.detail && evt.detail.target && evt.detail.target.id === 'generic-voucher-panel') {
                initVoucherForm();
            }
        });
    })();

    // ===== Small, production-safe helpers (no external dependencies) =====

    // 1) Ensure correct "action" value is submitted based on clicked button.
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const form = btn.form || document.getElementById('voucher-form');
        if (!form) return;
        const actionInput = document.getElementById('voucher-action');
        if (actionInput) actionInput.value = btn.dataset.action || 'save';
    }, true);

    // 2) Keyboard shortcuts: Alt+N add line, Ctrl+Enter post voucher.
    document.addEventListener('keydown', function (e) {
        const activeTag = (document.activeElement && document.activeElement.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(activeTag);

        // Alt+N: add line (works even while typing)
        if (e.altKey && (e.key === 'n' || e.key === 'N')) {
            const addBtn = document.querySelector('[data-line-action="add-line"]');
            if (addBtn) { e.preventDefault(); addBtn.click(); }
        }

        // Ctrl+Enter: post (only when in form area)
        if (e.ctrlKey && e.key === 'Enter') {
            const postBtn = document.querySelector('button[data-action="post_voucher"]');
            if (postBtn) {
                e.preventDefault();
                // Respect user intent: if they are typing in a multiline textarea, do not hijack unless they hold Ctrl.
                postBtn.click();
            }
        }
    });

    // 3) Optional: keep lines-count up to date (safe fallback; your backend can override).
    function updateLineCount() {
        const rows = document.querySelectorAll('#lines-container tr.generic-line-row');
        const el = document.getElementById('lines-count');
        if (el) el.textContent = `Showing ${rows.length} line${rows.length === 1 ? '' : 's'}`;
    }
    document.addEventListener('htmx:afterSwap', updateLineCount);
    document.addEventListener('DOMContentLoaded', updateLineCount);
</script>
{% endblock %}
