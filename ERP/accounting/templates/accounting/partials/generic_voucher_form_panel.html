{% load generic_voucher_tags %}
{% url 'accounting:generic_voucher_line' as default_line_endpoint %}
<div id="generic-voucher-panel">
  {% if alert_message %}
  <div class="alert alert-{{ alert_level|default:'info' }} py-2 px-3 mb-3" role="alert">
    {{ alert_message }}
  </div>
  {% endif %}
  {% if header_form and line_formset %}
  {% if header_form.errors or line_formset.errors or line_formset.non_form_errors %}
  <div class="alert alert-danger py-2 px-3 mb-3" role="alert">
    <strong>Please correct the errors in the form.</strong>
  </div>
  {% endif %}
  <form id="voucher-form" class="generic-voucher-entry-page" method="post" enctype="multipart/form-data" hx-post="."
    hx-target="#generic-voucher-panel" hx-swap="innerHTML" hx-encoding="multipart/form-data"
    hx-indicator="#generic-voucher-loading">
    {% csrf_token %}
    <input type="hidden" name="action" id="voucher-action" value="save">
    <input type="hidden" name="idempotency_key" value="{{ idempotency_key }}">


    <!-- Header fields: compact, single card, no extra column waste -->
    <div class="card border-0 shadow-sm gv-card header-card h-100">
      <div class="card-body gv-card-body">

        <div class="row g-2 align-items-end">
          {% for field in header_fields %}
            {% with widget_name=field|widget_type %}
              {% if widget_name == "Textarea" %}
                <div class="col-12 col-lg-6">
              {% else %}
                <div class="col-12 col-md-6 col-lg-3">
              {% endif %}
                  <label class="form-label gv-label mb-1">
                    {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                  </label>
                  {% if widget_name == "CheckboxInput" %}
                    <div class="form-check m-0">
                      {{ field|add_class:"form-check-input align-middle" }}
                    </div>
                  {% elif widget_name == "DualCalendarWidget" %}
                    <div class="dual-calendar-wrapper">
                      {{ field }}
                    </div>
                  {% elif widget_name == "Select" or widget_name == "SelectMultiple" %}
                    {{ field|add_class:"form-select form-select-sm" }}
                  {% else %}
                    {{ field|add_class:"form-control form-control-sm" }}
                  {% endif %}
                  {% if field.errors %}
                    <div class="invalid-feedback d-block">
                      {{ field.errors|join:", " }}
                    </div>
                  {% elif field.name|slice:"-8:" == "_display" %}
                    {% with base_name=field.name|slice:":-8" %}
                      {% with base_field=header_form|get_field:base_name %}
                        {% if base_field.errors %}
                          <div class="invalid-feedback d-block">
                            {{ base_field.errors|join:", " }}
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% endif %}
                </div>
            {% endwith %}
          {% endfor %}
        </div>

        {% for hidden in header_form.hidden_fields %}
        {{ hidden }}
        {% endfor %}

        <!-- Compact utilities row: tools dropdown + inline status -->
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mt-2">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-wrench me-1"></i>Tools
              </button>
              <ul class="dropdown-menu">
                <li><button type="button" class="dropdown-item" data-line-action="duplicate-last"><i class="fas fa-copy me-2"></i>Duplicate last line</button></li>
                <li><button type="button" class="dropdown-item" data-line-action="auto-balance"><i class="fas fa-balance-scale me-2"></i>Auto balance</button></li>
                <li><button type="button" class="dropdown-item" data-line-action="sort"><i class="fas fa-sort-alpha-down me-2"></i>Sort by account</button></li>
                <li><hr class="dropdown-divider"></li>
                <li><button type="button" class="dropdown-item" data-line-action="import"><i class="fas fa-upload me-2"></i>Import CSV</button></li>
                <li><button type="button" class="dropdown-item" data-line-action="export"><i class="fas fa-download me-2"></i>Export CSV</button></li>
              </ul>
            </div>

            <div id="action-status" class="alert alert-info py-1 px-2 mb-0 d-none" role="alert">
              <small id="action-status-message">Ready</small>
            </div>
          </div>

          <div class="text-muted small d-flex align-items-center gap-2">
            <span class="d-none d-md-inline">Tip:</span>
            <span class="gv-kbd">Ctrl</span><span class="gv-kbd">Enter</span><span class="d-none d-md-inline">Post</span>
            <span class="text-muted">|</span>
            <span class="gv-kbd">Alt</span><span class="gv-kbd">N</span><span class="d-none d-md-inline">Add line</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Lines grid: main focus, more viewport, with sticky header and sticky first/last columns -->
    <div class="card border-0 shadow-sm gv-card mt-2">
      <div class="card-header bg-white border-0 gv-card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="min-w-0">
            <h5 class="mb-0">Journal Lines</h5>
            <div class="text-muted small" id="lines-count">Showing {{ line_formset.total_form_count }} line{{ line_formset.total_form_count|pluralize }}</div>
          </div>
          <div class="d-flex gap-1 flex-wrap">
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-row" data-line-action="add-line">
              <i class="fas fa-plus me-1"></i>Add
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-line-action="add-ten">+10</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-line-action="clear-lines">
              <i class="fas fa-eraser me-1"></i>Clear
            </button>
          </div>
        </div>
      </div>

      <div class="card-body gv-card-body pt-2">
        {% if line_formset.non_form_errors %}
        <div class="alert alert-danger py-2 px-3 mb-3">
          <i class="fas fa-exclamation-circle me-2"></i>
          <strong>Line Validation Errors:</strong>
          {{ line_formset.non_form_errors|join:" " }}
        </div>
        {% endif %}
        {{ line_formset.management_form }}
        <div class="table-responsive gv-table-wrap" id="lines-table-wrapper">
          <table class="table table-sm table-bordered align-middle mb-0 gv-grid" id="generic-lines-table">
            <thead class="table-light gv-grid-head">
              <tr>
                <th class="text-center gv-sticky-start gv-col-n" scope="col">#</th>
                {% for col in line_columns %}
                  <th scope="col">{{ col.label }}</th>
                {% endfor %}
                <th class="text-center gv-sticky-end gv-col-act" scope="col">&nbsp;</th>
              </tr>
            </thead>

            <tbody id="lines-container" class="lines-grid-body" data-line-endpoint="{{ line_endpoint|default:default_line_endpoint }}" data-voucher-code="{{ config.code|escapejs }}">
              {% if line_formset.forms %}
              {% for form in line_formset %}
              {% with index=forloop.counter0 %}
              {% if form.non_field_errors %}
              <tr class="error-row bg-danger bg-opacity-10">
                <td colspan="999" class="py-2">
                  <div class="alert alert-danger mb-0 py-2 px-3 d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                      <strong>Line {{ index|add:1 }} Error:</strong>
                      {{ form.non_field_errors|join:", " }}
                    </div>
                  </div>
                </td>
              </tr>
              {% endif %}
              <tr class="generic-line-row{% if form.non_field_errors or form.errors %} table-danger{% endif %}" data-line-index="{{ index }}" id="line-{{ index }}">
                <td class="text-center text-muted small gv-sticky-start gv-col-n">{{ index|add:1 }}</td>

                {% for col in line_columns %}
                  {% with field=form|get_field:col.name widget_name=field|widget_type %}
                    <td>
                      {% if widget_name == "CheckboxInput" %}
                        <div class="form-check m-0">
                          {{ field|add_class:"form-check-input gv-cell grid-cell" }}
                        </div>
                      {% elif widget_name == "DualCalendarWidget" %}
                        <div class="dual-calendar-wrapper">
                          {{ field }}
                        </div>
                      {% elif widget_name == "Select" or widget_name == "SelectMultiple" %}
                        {{ field|add_class:"form-select form-select-sm gv-cell grid-cell" }}
                      {% else %}
                        {{ field|add_class:"form-control form-control-sm gv-cell grid-cell" }}
                      {% endif %}
                  {% if field.errors %}
                        <div class="invalid-feedback d-block">
                          {{ field.errors|join:", " }}
                        </div>
                  {% elif col.name|slice:"-8:" == "_display" %}
                    {% with base_name=col.name|slice:":-8" %}
                      {% with base_field=form|get_field:base_name %}
                        {% if base_field.errors %}
                          <div class="invalid-feedback d-block">
                            {{ base_field.errors|join:", " }}
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% endif %}
                    </td>
                  {% endwith %}
                {% endfor %}

                <td class="text-center gv-sticky-end gv-col-act">
                  <button type="button" class="btn btn-outline-danger btn-sm gv-icon-btn remove-line-btn" title="Remove row" aria-label="Remove row">
                    <i class="fas fa-times"></i>
                  </button>

                  {% for hidden in form.hidden_fields %}
                  {{ hidden }}
                  {% endfor %}
                </td>
              </tr>
              {% endwith %}
              {% endfor %}
              {% endif %}

              <tr id="no-lines-placeholder" {% if line_formset.forms %} class="d-none" {% endif %}>
                <td colspan="999" class="text-center text-muted py-4">
                  <i class="fas fa-plus-circle fa-2x mb-2"></i>
                  <div class="mb-1">No lines yet</div>
                  <div class="small">Use "Add" to begin entering journal items.</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sticky summary: always visible, compact -->
      <div class="card-footer bg-white border-top gv-summary sticky-bottom" id="generic-voucher-summary"
           hx-post="{% url 'accounting:generic_voucher_recalc' %}" hx-trigger="input changed delay:400ms from:#voucher-form" hx-include="#voucher-form" hx-target="#generic-voucher-summary" hx-swap="innerHTML">

        {% include "accounting/partials/generic_voucher_summary.html" %}
      </div>
    </div>

    {% if additional_charges_formset %}
    <div class="card border-0 shadow-sm gv-card mt-2">
      <div class="card-header bg-white border-0 gv-card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="min-w-0">
            <h5 class="mb-0">Additional Charges</h5>
            <div class="text-muted small">Add charges or taxes to apply on this voucher.</div>
          </div>
          <div class="d-flex gap-1 flex-wrap">
            <button type="button" class="btn btn-sm btn-outline-primary" data-ac-add>
              <i class="fas fa-plus me-1"></i>Add Charge
            </button>
          </div>
        </div>
      </div>

      <div class="card-body gv-card-body pt-2">
        {{ additional_charges_formset.management_form }}
        <div class="table-responsive gv-table-wrap">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                {% if additional_charges_formset.forms %}
                  {% for field in additional_charges_formset.forms.0.visible_fields %}
                    {% if field.name != 'DELETE' %}
                      <th scope="col">{{ field.label }}</th>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                <th scope="col" class="text-center" style="width: 52px;">&nbsp;</th>
              </tr>
            </thead>
            <tbody id="additional-charges-body">
              {% for form in additional_charges_formset %}
              <tr>
                {% for field in form.visible_fields %}
                  {% if field.name == 'DELETE' %}
                    {{ field.as_hidden }}
                  {% else %}
                    <td>
                      {% with widget_name=field|widget_type %}
                        {% if widget_name == "Select" or widget_name == "SelectMultiple" %}
                          {{ field|add_class:"form-select form-select-sm" }}
                        {% else %}
                          {{ field|add_class:"form-control form-control-sm" }}
                        {% endif %}
                      {% endwith %}
                      {% if field.errors %}
                        <div class="invalid-feedback d-block">
                          {{ field.errors|join:", " }}
                        </div>
                      {% endif %}
                    </td>
                  {% endif %}
                {% endfor %}
                <td class="text-center">
                  <button type="button" class="btn btn-outline-danger btn-sm" data-ac-remove title="Remove">
                    <i class="fas fa-times"></i>
                  </button>
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <template id="additional-charge-template">
          <tr>
            {% for field in additional_charges_formset.empty_form.visible_fields %}
              {% if field.name == 'DELETE' %}
                {{ field.as_hidden }}
              {% else %}
                <td>
                  {% with widget_name=field|widget_type %}
                    {% if widget_name == "Select" or widget_name == "SelectMultiple" %}
                      {{ field|add_class:"form-select form-select-sm" }}
                    {% else %}
                      {{ field|add_class:"form-control form-control-sm" }}
                    {% endif %}
                  {% endwith %}
                </td>
              {% endif %}
            {% endfor %}
            <td class="text-center">
              <button type="button" class="btn btn-outline-danger btn-sm" data-ac-remove title="Remove">
                <i class="fas fa-times"></i>
              </button>
              {% for hidden in additional_charges_formset.empty_form.hidden_fields %}
                {{ hidden }}
              {% endfor %}
            </td>
          </tr>
        </template>
      </div>
    </div>
    {% endif %}

    </div>

  </form>
  {% else %}
  <div class="alert alert-danger py-2 px-3 mb-0" role="alert">
    {{ alert_message|default:"Invalid voucher schema. Please contact an administrator." }}
  </div>
  {% endif %}
</div>
{% if additional_charges_formset %}
<script>
  (function () {
    const addBtn = document.querySelector('[data-ac-add]');
    const body = document.getElementById('additional-charges-body');
    const template = document.getElementById('additional-charge-template');
    const totalInput = document.getElementById('id_additional_charges-TOTAL_FORMS');
    if (!addBtn || !body || !template || !totalInput) return;

    const addRow = () => {
      const index = parseInt(totalInput.value || '0', 10);
      const html = template.innerHTML.replace(/__prefix__/g, index);
      const wrapper = document.createElement('tbody');
      wrapper.innerHTML = html.trim();
      const row = wrapper.firstElementChild;
      if (row) {
        body.appendChild(row);
        totalInput.value = index + 1;
      }
    };

    const markDeleted = (row) => {
      if (!row) return;
      const delInput = row.querySelector('input[name$="-DELETE"]');
      if (delInput) {
        delInput.value = 'on';
        row.classList.add('d-none');
        return true;
      }
      return false;
    };

    addBtn.addEventListener('click', addRow);
    body.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-ac-remove]');
      if (!btn) return;
      const row = btn.closest('tr');
      if (markDeleted(row)) return;
      row.remove();
      const current = parseInt(totalInput.value || '0', 10);
      totalInput.value = Math.max(0, current - 1);
    });
  })();
</script>
{% endif %}
