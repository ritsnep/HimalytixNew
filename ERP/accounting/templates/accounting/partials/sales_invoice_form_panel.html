<div id="sales-invoice-panel" class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="card-title mb-0">{{ form_title|default:"Sales Invoice" }}</h4>
            <p class="text-muted mb-0">Pick customers, stocked items, and let due dates and VAT calculate automatically.</p>
        </div>
        <a href="{% url back_url %}" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>
    <div class="card-body">
        <form method="post" novalidate hx-post="." hx-target="#sales-invoice-panel" hx-swap="outerHTML">
            {% csrf_token %}
            {% if alert_message %}
            <div class="alert alert-{{ alert_level|default:'info' }} small mb-3">
                {{ alert_message }}
            </div>
            {% endif %}
            {% if form.non_field_errors %}
            <div class="alert alert-danger small mb-3">
                {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
            </div>
            {% endif %}

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.customer.id_for_label }}">Customer</label>
                    {{ form.customer }}
                    <div class="form-text" id="customer-tax-hint">Tax ID will appear after selecting a customer.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.invoice_number.id_for_label }}">Invoice Number</label>
                    {{ form.invoice_number }}
                    <div class="form-text">Auto-numbered on save.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.reference_number.id_for_label }}">Reference</label>
                    {{ form.reference_number }}
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.invoice_date.id_for_label }}">Invoice Date</label>
                    {{ form.invoice_date }}
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.due_date.id_for_label }}">Payment Due Date</label>
                    {{ form.due_date }}
                    <div class="form-text">Auto-calculated from the payment term.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.payment_term.id_for_label }}">Payment Term</label>
                    {{ form.payment_term }}
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.currency.id_for_label }}">Currency</label>
                    {{ form.currency }}
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.exchange_rate.id_for_label }}">Exchange Rate</label>
                    {{ form.exchange_rate }}
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ form.warehouse.id_for_label }}">Warehouse (for inventory items)</label>
                    {{ form.warehouse }}
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-12">
                    <label class="form-label" for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes }}
                </div>
            </div>

            <div class="table-responsive border rounded mt-4">
                {{ formset.management_form }}
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 18%">Item / Code</th>
                            <th style="width: 18%">Description</th>
                            <th class="text-end" style="width: 8%">Qty</th>
                            <th class="text-end" style="width: 10%">Rate</th>
                            <th class="text-end" style="width: 10%">Discount</th>
                            <th style="width: 13%">Revenue Account</th>
                            <th style="width: 13%">Taxes</th>
                            <th class="text-end" style="width: 8%">Tax</th>
                            <th class="text-end" style="width: 10%">Line Total</th>
                            <th class="text-center" style="width: 6%"></th>
                        </tr>
                    </thead>
                    <tbody id="line-items">
                        {% for line_form in formset %}
                        <tr class="line-row">
                            {% for hidden in line_form.hidden_fields %}{{ hidden }}{% endfor %}
                            <td>
                                {{ line_form.product_code }}
                                {% if line_form.product_code.errors %}<div class="text-danger small">{{ line_form.product_code.errors|join:", " }}</div>{% endif %}
                            </td>
                            <td>
                                {{ line_form.description }}
                                {% if line_form.description.errors %}<div class="text-danger small">{{ line_form.description.errors|join:", " }}</div>{% endif %}
                            </td>
                            <td class="text-end">{{ line_form.quantity }}</td>
                            <td class="text-end">{{ line_form.unit_price }}</td>
                            <td class="text-end">{{ line_form.discount_amount }}</td>
                            <td>{{ line_form.revenue_account }}</td>
                            <td>
                                {{ line_form.tax_codes }}
                                {% if line_form.tax_codes.errors %}<div class="text-danger small">{{ line_form.tax_codes.errors|join:", " }}</div>{% endif %}
                            </td>
                            <td class="text-end">{{ line_form.tax_amount }}</td>
                            <td class="text-end"><span class="line-total fw-semibold">0.00</span></td>
                            <td class="text-center">
                                {% if formset.can_delete %}
                                <div class="form-check">
                                    {{ line_form.DELETE }}
                                    <label class="form-check-label" for="{{ line_form.DELETE.id_for_label }}">Delete</label>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-3">Add at least one line item.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-line">Add line</button>
                <div class="text-end small">
                    <div>Subtotal: <span id="subtotal-display" class="fw-semibold">0.00</span></div>
                    <div>Tax: <span id="tax-display" class="fw-semibold">0.00</span></div>
                    <div class="fs-5">Total: <span id="total-display" class="fw-bold">0.00</span></div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="submit" name="action" value="save" class="btn btn-outline-secondary">Save Draft</button>
                <button type="submit" name="action" value="post" class="btn btn-primary">Save &amp; Post</button>
            </div>
        </form>
    </div>
</div>

<template id="empty-line-template">
    <tr class="line-row">
        {% with form=formset.empty_form %}
            {% for hidden in form.hidden_fields %}{{ hidden.as_widget|safe }}{% endfor %}
            <td>{{ form.product_code.as_widget }}</td>
            <td>{{ form.description.as_widget }}</td>
            <td class="text-end">{{ form.quantity.as_widget }}</td>
            <td class="text-end">{{ form.unit_price.as_widget }}</td>
            <td class="text-end">{{ form.discount_amount.as_widget }}</td>
            <td>{{ form.revenue_account.as_widget }}</td>
            <td>{{ form.tax_codes.as_widget }}</td>
            <td class="text-end">{{ form.tax_amount.as_widget }}</td>
            <td class="text-end"><span class="line-total fw-semibold">0.00</span></td>
            <td class="text-center">
                <div class="form-check">
                    {{ form.DELETE }}
                    <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">Delete</label>
                </div>
            </td>
        {% endwith %}
    </tr>
</template>
<datalist id="product-options"></datalist>
