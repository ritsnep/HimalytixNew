{% extends "accounting/base_voucher.html" %}
{% load i18n %}

{% block title %}{{ i18n["approval.dashboard.title"]|default:"Approval Dashboard" }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">{{ i18n["approval.dashboard.title"]|default:"Approval Dashboard" }}</h2>
    
    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">{{ i18n["approval.status.pending"]|default:"Pending" }}</h6>
                    <h3>{{ stats.total_pending }}</h3>
                    <small class="text-muted">{{ i18n["approval.awaiting_approval"]|default:"awaiting approval" }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">{{ i18n["approval.status.approved"]|default:"Approved" }}</h6>
                    <h3>{{ stats.total_approved }}</h3>
                    <small>{{ i18n["approval.this_month"]|default:"this month" }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">{{ i18n["approval.status.rejected"]|default:"Rejected" }}</h6>
                    <h3>{{ stats.total_rejected }}</h3>
                    <small>{{ i18n["approval.requiring_resubmission"]|default:"requiring resubmission" }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">{{ i18n["approval.approval_rate"]|default:"Approval Rate" }}</h6>
                    <h3>{{ stats.approval_rate }}%</h3>
                    <small>{{ i18n["approval.of_total_submissions"]|default:"of total submissions" }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>{{ i18n["approval.average_approval_time"]|default:"Average Approval Time" }}</h5>
                </div>
                <div class="card-body">
                    <div class="display-4">
                        {{ stats.avg_approval_time }} <small>{{ i18n["approval.hours"]|default:"hours" }}</small>
                    </div>
                    <p class="text-muted mb-0">{{ i18n["approval.from_submission_to_completion"]|default:"from submission to completion" }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>{{ i18n["approval.approval_efficiency"]|default:"Approval Efficiency" }}</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div 
                            class="progress-bar bg-success" 
                            role="progressbar" 
                            style="width: {{ stats.approval_rate }}%"
                            aria-valuenow="{{ stats.approval_rate }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100"
                        >
                            {{ stats.approval_rate }}%
                        </div>
                    </div>
                    <p class="text-muted mt-2 mb-0">{{ i18n["approval.success_rate"]|default:"success rate" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Workflows Performance -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5>{{ i18n["approval.workflow_performance"]|default:"Workflow Performance" }}</h5>
        </div>
        <div class="card-body">
            {% if workflow_stats %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>{{ i18n["approval.workflow"]|default:"Workflow" }}</th>
                                <th class="text-end">{{ i18n["approval.total"]|default:"Total" }}</th>
                                <th class="text-end">{{ i18n["approval.status.approved"]|default:"Approved" }}</th>
                                <th class="text-end">{{ i18n["approval.status.rejected"]|default:"Rejected" }}</th>
                                <th class="text-end">{{ i18n["approval.status.pending"]|default:"Pending" }}</th>
                                <th>{{ i18n["approval.status"]|default:"Status" }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for workflow in workflow_stats %}
                                <tr>
                                    <td>{{ workflow.workflow.name }}</td>
                                    <td class="text-end">{{ workflow.total }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-success">{{ workflow.approved }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-danger">{{ workflow.rejected }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-warning text-dark">{{ workflow.pending }}</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            {% widthratio workflow.approved workflow.total 100 as approval_percent %}
                                            <div 
                                                class="progress-bar bg-success" 
                                                style="width: {{ approval_percent }}%"
                                            ></div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">{{ i18n["approval.no_workflow_data"]|default:"No workflow data available." }}</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Per-User Performance -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5>{{ i18n["approval.approver_performance"]|default:"Approver Performance" }}</h5>
        </div>
        <div class="card-body">
            {% if per_user_stats %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>{{ i18n["approval.approver"]|default:"Approver" }}</th>
                                <th class="text-end">{{ i18n["approval.status.approved"]|default:"Approved" }}</th>
                                <th class="text-end">{{ i18n["approval.status.rejected"]|default:"Rejected" }}</th>
                                <th class="text-end">{{ i18n["approval.total_decisions"]|default:"Total Decisions" }}</th>
                                <th>{{ i18n["approval.approval_rate"]|default:"Approval Rate" }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_stat in per_user_stats %}
                                {% with total=user_stat.approved|add:user_stat.rejected %}
                                    {% if total > 0 %}
                                        {% widthratio user_stat.approved total 100 as rate %}
                                        <tr>
                                            <td>{{ user_stat.user.get_full_name }}</td>
                                            <td class="text-end">
                                                <span class="badge bg-success">{{ user_stat.approved }}</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-danger">{{ user_stat.rejected }}</span>
                                            </td>
                                            <td class="text-end">{{ total }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div 
                                                        class="progress-bar bg-info" 
                                                        style="width: {{ rate }}%"
                                                    >{{ rate }}%</div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">{% trans "No approver data available." %}</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Actions -->
    <div class="row">
        <div class="col-md-12">
            <a href="{% url 'accounting:approval_queue' %}" class="btn btn-primary">
                <i class="bi bi-inbox"></i> {{ i18n["approval.go_to_queue"]|default:"Go to Approval Queue" }}
            </a>
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .display-4 {
        font-size: 2.5rem;
        font-weight: 700;
    }
</style>
{% endblock %}
