{% extends "accounting/base.html" %}
{% load static %}
{% block title %}Advanced Journal Entry{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/journals.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header Form (from default config) -->
    <form method="post" id="journal-header-form" class="mb-3">
        {% csrf_token %}
        <div class="row g-3 align-items-end">
            <div class="col-md-2">{{ header_form.journal_type.label_tag }}{{ header_form.journal_type }}</div>
            <div class="col-md-2">{{ header_form.period.label_tag }}{{ header_form.period }}</div>
            <div class="col-md-2">{{ header_form.journal_date.label_tag }}{{ header_form.journal_date }}</div>
            <div class="col-md-2">{{ header_form.reference.label_tag }}{{ header_form.reference }}</div>
            <div class="col-md-4">{{ header_form.description.label_tag }}{{ header_form.description }}</div>
        </div>
    </form>

    <!-- Alert Tiles, AI Assist, etc. (as before) -->
    <div class="bg-white border-bottom px-4 py-2 d-flex gap-3 overflow-auto">
        <div class="flex-shrink-0 bg-danger bg-opacity-10 border border-danger rounded px-3 py-2 d-flex align-items-center gap-2">
            <i class="fas fa-exclamation-circle text-danger"></i>
            <span class="small fw-medium text-danger">2 validation errors</span>
        </div>
        <div class="flex-shrink-0 bg-warning bg-opacity-10 border border-warning rounded px-3 py-2 d-flex align-items-center gap-2">
            <i class="fas fa-clock text-warning"></i>
            <span class="small fw-medium text-warning">3 pending approvals</span>
        </div>
        <div class="flex-shrink-0 bg-info bg-opacity-10 border border-info rounded px-3 py-2 d-flex align-items-center gap-2">
            <i class="fas fa-info-circle text-info"></i>
            <span class="small fw-medium text-info">5 batches on hold</span>
        </div>
    </div>

    <!-- AI Assist Bar -->
    <div class="bg-primary bg-opacity-10 border-bottom border-primary px-4 py-2 d-flex align-items-center">
        <div class="flex-grow-1 position-relative">
            <input type="text" id="ai-assist-input" placeholder="Describe your journal entry (e.g. 'Accrue March AWS bill')..." class="form-control border-primary rounded" />
            <button id="ai-suggest" class="position-absolute top-50 end-0 translate-middle-y btn btn-link text-primary"><i class="fas fa-magic"></i></button>
        </div>
    </div>

    <!-- Journal Entry Grid -->
    <form method="post" id="journal-lines-form">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="bg-light sticky-top">
                    <tr>
                        <th>#</th>
                        <th>Account</th>
                        <th>Description</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Department</th>
                        <th>Project</th>
                        <th>Cost Center</th>
                        <th>Tax Code</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in line_formset.forms %}
                        {% include 'accounting/partials/journal_line_form.html' with form=form forloop=forloop %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- Balance Footer -->
    <div class="position-sticky bottom-0 bg-white border-top px-4 py-3 d-flex align-items-center justify-content-between shadow">
        <div class="d-flex align-items-center gap-2">
            <button id="add-row" class="btn btn-light btn-sm d-flex align-items-center gap-1"><i class="fas fa-plus text-secondary"></i>Add Row</button>
            <button id="auto-balance" class="btn btn-success btn-sm d-flex align-items-center gap-1"><i class="fas fa-balance-scale"></i>Auto-Balance</button>
        </div>
        <div class="d-flex align-items-center gap-4">
            <div class="small"><span class="fw-medium text-secondary">Total Debit:</span> <span id="total-debit" class="ms-1 fw-bold">0.00</span></div>
            <div class="small"><span class="fw-medium text-secondary">Total Credit:</span> <span id="total-credit" class="ms-1 fw-bold">0.00</span></div>
            <div class="position-relative w-25" style="height: 8px; min-width: 120px;">
                <div id="imbalance-bar" class="position-absolute h-100 imbalance-indicator bg-danger rounded-pill"></div>
                <div class="bg-light rounded-pill w-100 h-100"></div>
            </div>
            <div id="balance-status" class="small fw-medium text-success">Balanced</div>
        </div>
        <div>
            <button id="preview-impact" class="btn btn-light btn-sm d-flex align-items-center gap-1 text-purple"><i class="fas fa-eye"></i>Preview Ledger Impact</button>
        </div>
    </div>

    <!-- Side Panel -->
    <div id="side-panel" class="bg-white border-start d-flex flex-column transition-all" style="width: 350px; min-width: 300px; max-width: 400px;">
        <div class="border-bottom px-4 py-3 d-flex align-items-center justify-content-between">
            <h3 class="fs-6 fw-medium mb-0">Entry Details</h3>
            <button id="toggle-panel" class="btn btn-link text-secondary p-0"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="flex-grow-1 overflow-auto p-4">
            <div id="empty-state" class="text-center py-5">
                <i class="fas fa-mouse-pointer text-secondary fs-1 mb-3"></i>
                <p class="text-secondary">Select a row to view details</p>
            </div>
            <div id="detail-view" class="d-none">
                <div class="mb-4">
                    <h4 class="fs-6 fw-medium text-secondary mb-2">Account Information</h4>
                    <div class="bg-primary bg-opacity-10 border border-primary rounded p-3">
                        <div class="d-flex align-items-start gap-3">
                            <div class="bg-primary bg-opacity-25 p-2 rounded-circle"><i class="fas fa-wallet text-primary"></i></div>
                            <div>
                                <h5 class="fs-6 fw-medium mb-1" id="account-name">Account Name</h5>
                                <p class="small text-secondary mb-0" id="account-code">1000-00</p>
                                <p class="small mt-1 mb-0" id="account-type">Asset - Cash</p>
                            </div>
                        </div>
                        <div class="mt-3 row row-cols-2 g-2 small">
                            <div><span class="text-secondary">Balance:</span> <span id="account-balance" class="fw-medium">$12,345.67</span></div>
                            <div><span class="text-secondary">YTD Activity:</span> <span id="account-ytd" class="fw-medium">$45,678.90</span></div>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="fs-6 fw-medium text-secondary mb-2">Validation Messages</h4>
                    <div id="validation-messages" class="mb-2"></div>
                </div>
                <div class="mb-4">
                    <h4 class="fs-6 fw-medium text-secondary mb-2">AI Insights</h4>
                    <div class="bg-success bg-opacity-10 border border-success rounded p-3">
                        <div class="d-flex align-items-start gap-3">
                            <div class="bg-success bg-opacity-25 p-2 rounded-circle"><i class="fas fa-robot text-success"></i></div>
                            <div><p class="small mb-0" id="ai-insight">This appears to be a standard monthly accrual based on historical patterns. Similar entries were posted on the 15th of each month.</p></div>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="fs-6 fw-medium text-secondary mb-2">Attachments</h4>
                    <div class="border rounded mb-2">
                        <div class="p-2 d-flex align-items-center gap-2 hover-bg-light cursor-pointer"><i class="fas fa-file-pdf text-danger"></i><span class="small">Invoice_202303.pdf</span></div>
                        <div class="p-2 d-flex align-items-center gap-2 hover-bg-light cursor-pointer"><i class="fas fa-file-excel text-success"></i><span class="small">Accruals_March.xlsx</span></div>
                    </div>
                    <button class="btn btn-link text-primary btn-sm mt-2 d-flex align-items-center gap-1"><i class="fas fa-plus"></i>Add Attachment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Ledger Impact Modal -->
    <div id="preview-modal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Preview Ledger Impact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead class="bg-light">
                            <tr>
                                <th>Account</th>
                                <th>Description</th>
                                <th>Debit</th>
                                <th>Credit</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody id="preview-content">
                            <!-- Preview content will be added here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Confirm and Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortcut Helper -->
    <div id="shortcut-helper" class="position-fixed bottom-0 end-0 m-4 bg-white rounded shadow border p-4 d-none" style="z-index: 1050; width: 350px;">
        <div class="row row-cols-3 g-3">
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Ctrl+Enter</div>
                <p class="text-secondary small mt-1 mb-0">Save</p>
            </div>
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Alt+A</div>
                <p class="text-secondary small mt-1 mb-0">Add Row</p>
            </div>
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Alt+B</div>
                <p class="text-secondary small mt-1 mb-0">Auto-Balance</p>
            </div>
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Tab</div>
                <p class="text-secondary small mt-1 mb-0">Next Cell</p>
            </div>
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Shift+Tab</div>
                <p class="text-secondary small mt-1 mb-0">Prev Cell</p>
            </div>
            <div class="text-center">
                <div class="bg-light rounded p-2 font-monospace small">Ctrl+D</div>
                <p class="text-secondary small mt-1 mb-0">Duplicate Row</p>
            </div>
        </div>
    </div>
</div>
{% endblock %} 