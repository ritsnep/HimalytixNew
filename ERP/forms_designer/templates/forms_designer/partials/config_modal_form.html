{% load static %}
{% if debug_modal %}
<div class="alert alert-info">[DEBUG] Modal form partial loaded via AJAX/HTMX</div>
{% endif %}
<form method="post" id="config-modal-form" autocomplete="off">
    {% csrf_token %}
    <h4 class="mb-3">Edit Voucher Configuration: <span class="fw-bold">{{ config }}</span></h4>
    <div class="mb-3">
        <label for="config_name" class="form-label">Name <span class="text-danger">*</span></label>
        <input type="text" id="config_name" name="config_name" class="form-control" value="{{ config.name }}" required maxlength="100" aria-describedby="config_name_help">
        <div id="config_name_help" class="form-text">A descriptive name for this voucher configuration.</div>
    </div>
    <div class="mb-3">
        <label for="config_description" class="form-label">Description</label>
        <textarea id="config_description" name="config_description" rows="2" class="form-control" aria-describedby="config_description_help">{{ config.description }}</textarea>
        <div id="config_description_help" class="form-text">Optional description for this configuration.</div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Journal Type</label>
            <input type="text" class="form-control-plaintext" value="{{ config.journal_type }}" readonly tabindex="-1">
        </div>
        <div class="col-md-6">
            <label class="form-label">Layout Style</label>
            <input type="text" class="form-control-plaintext" value="{{ config.get_layout_style_display }}" readonly tabindex="-1">
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if config.is_active %}checked{% endif %}>
                <label class="form-check-label" for="is_active">Active</label>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="is_default" name="is_default" {% if config.is_default %}checked{% endif %}>
                <label class="form-check-label" for="is_default">Set as Default</label>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label for="schema_json" class="form-label">Schema JSON <span class="text-danger">*</span></label>
        <textarea id="schema_json" name="schema_json" rows="10" class="form-control" required aria-describedby="schema_json_help">{{ schema_json|default:schema|safe }}</textarea>
        <div id="schema_json_help" class="form-text">JSON configuration for the voucher form layout. <a href="#" tabindex="0" data-bs-toggle="popover" data-bs-content="Refer to the documentation for schema format.">Help</a></div>
    </div>
    <div id="modal-form-errors" class="alert alert-danger d-none" role="alert" aria-live="assertive"></div>
    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Save
        </button>
    </div>
</form>
<script>
// Bootstrap popover for help
function initConfigModalForm() {
    var form = document.getElementById('config-modal-form');
    if (!form) return;
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function (popoverTriggerEl) {
      new bootstrap.Popover(popoverTriggerEl, {trigger: 'focus'});
    });
    form.onsubmit = function(e) {
        e.preventDefault();
        var errors = [];
        var name = form.config_name.value.trim();
        var schema = form.schema_json.value.trim();
        if (!name) errors.push('Name is required.');
        if (!schema) errors.push('Schema JSON is required.');
        else {
            try { JSON.parse(schema); } catch (err) { errors.push('Schema JSON is not valid JSON.'); }
        }
        var errorDiv = document.getElementById('modal-form-errors');
        if (errors.length) {
            errorDiv.innerHTML = errors.join('<br>');
            errorDiv.classList.remove('d-none');
            errorDiv.focus();
            return false;
        } else {
            errorDiv.classList.add('d-none');
        }
        var spinner = form.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        var data = new FormData(form);
        fetch(window.location.href, {
            method: 'POST',
            headers: {'HX-Request': 'true'},
            body: data
        }).then(r => r.text()).then(html => {
            spinner.classList.add('d-none');
            document.getElementById('config-modal-content').innerHTML = html;
            // If the form is gone, modal was replaced by success partial
            if (!document.getElementById('config-modal-form')) {
                var modalEl = document.getElementById('configModal');
                var modal = bootstrap.Modal.getInstance(modalEl);
                setTimeout(function() {
                    if (modal) modal.hide();
                    window.location.reload();
                }, 1000);
            } else {
                // Re-initialize form if still present (for errors)
                initConfigModalForm();
            }
        }).catch(() => {
            spinner.classList.add('d-none');
            errorDiv.innerHTML = 'An error occurred while saving.';
            errorDiv.classList.remove('d-none');
            errorDiv.focus();
        });
    };
}
// Run on initial load and after every modal content replacement
initConfigModalForm();
// Also observe for dynamic content replacement
var observer = new MutationObserver(function() {
    initConfigModalForm();
});
observer.observe(document.getElementById('config-modal-content'), {childList: true});
</script> 