{% load static %}
<!DOCTYPE html>
<html lang="{{ current_language|default:'en' }}">

<head>
    <meta charset="utf-8" />
    <title>{% block title %}{% endblock title %} | Himalytix </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <script>
        // Migrate any legacy storage keys from older Dason branding to Himalytix
        (function(){
          try {
            var oldLang = localStorage.getItem('Dason-language');
            if (oldLang && !localStorage.getItem('himalytix-language')) {
              localStorage.setItem('himalytix-language', oldLang);
            }
          } catch (e) { /* ignore: localStorage may be blocked */ }
        })();
      </script>
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
    <meta content="Themesdesign" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="{{ branding.favicon_url }}">

    {% block css %}
    {% block extra_css %}
    {% endblock extra_css %}
    <!-- preloader css -->
    <link rel="stylesheet" href="{% static 'css/preloader.min.css'%}" type="text/css" />

    <!-- Bootstrap Css -->
    <link href="{% static 'css/bootstrap.min.css'%}" id="bootstrap-style" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="{% static 'css/icons.min.css'%}" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="{% static 'css/app.min.css'%}" id="app-style" rel="stylesheet" type="text/css" />
    <!-- Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" type="text/css" />
    {% endblock css %}

</head>

<body {% block extra_body %} data-topbar="dark"{% endblock extra_body %}>
  {# Hidden layout controls to prevent vendor script null errors on pages without right sidebar #}
  <div id="layout-guard" style="display:none">
    <input type="checkbox" id="layout-horizontal" />
    <input type="checkbox" id="layout-vertical" />
    <input type="checkbox" id="layout-mode-dark" />
    <input type="checkbox" id="layout-mode-light" />
    <input type="checkbox" id="layout-width-boxed" />
    <input type="checkbox" id="layout-width-fuild" />
    <input type="checkbox" id="layout-position-scrollable" />
    <input type="checkbox" id="layout-position-fixed" />
    <input type="checkbox" id="topbar-color-dark" />
    <input type="checkbox" id="topbar-color-light" />
    <input type="checkbox" id="sidebar-size-small" />
    <input type="checkbox" id="sidebar-size-compact" />
    <input type="checkbox" id="sidebar-size-default" />
    <input type="checkbox" id="sidebar-color-brand" />
    <input type="checkbox" id="sidebar-color-dark" />
    <input type="checkbox" id="sidebar-color-light" />
    <input type="checkbox" id="layout-direction-rtl" />
    <input type="checkbox" id="layout-direction-ltr" />
  </div>
    <!-- Begin page -->
    <div id="layout-wrapper">
        {% block header %}
        {% include "partials/header.html" %}
        {% endblock header %}

        {% block left_sidebar %}
        {% include 'partials/left-sidebar.html' %}
        {% endblock left_sidebar %}


        <main class="flex-grow-1" id="main-container">
        {% block content %}
            {# Django messages block #}
            {% if messages %}
              <div class="container mt-2">
                <ul class="list-unstyled">
                  {% for message in messages %}
                    <li class="alert alert-{{ message.tags }}">{{ message }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% block footer %}
            {% endblock footer %}
        {% endblock content %}
        </main>
    </div>
    <!-- END layout-wrapper -->


    {% block right_sidebar %}
        {% if user.is_staff and not voucher_entry_page %}
            {% include 'partials/right-sidebar.html' %}
        {% endif %}
    {% endblock right_sidebar %}


    {% block javascript %}
    <!-- JAVASCRIPT -->
    <script src="{% static 'libs/jquery/dist/jquery.min.js'%}"></script>
    <script src="{% static 'libs/bootstrap/dist/js/bootstrap.bundle.min.js'%}"></script>
    <script src="{% static 'libs/metismenu/dist/metisMenu.min.js'%}"></script>
    <script src="{% static 'libs/simplebar/dist/simplebar.min.js'%}"></script>
    <script src="{% static 'libs/node-waves/dist/waves.min.js'%}"></script>
    <script src="{% static 'libs/feather-icons/dist/feather.min.js'%}"></script>
    <!-- pace js -->
    <script src="{% static 'libs/pace-js/pace.min.js'%}"></script>
    <!-- HTMX -->
    <script src="{% static 'libs/htmx.org/dist/htmx.min.js' %}"></script>
    <!-- Pristine.js (local) to avoid CDN/tracking blocks -->
    <script src="{% static 'libs/pristinejs/dist/pristine.min.js' %}"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
      // Ensure HTMX sends the Django CSRF token for POST/PUT/DELETE.
      (function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        document.body.addEventListener('htmx:configRequest', function (evt) {
          const token = getCookie('csrftoken');
          if (token) {
            evt.detail.headers['X-CSRFToken'] = token;
          }
        });
      })();
    </script>
    {% block extra_js %}
    {% endblock extra_js %}
    {# Expose i18n to JS safely #}
    <script id="i18n-json" type="application/json">{{ i18n|json_script:"i18n-json" }}</script>
    <script>
      (function(){
        try {
          var node = document.getElementById('i18n-json');
          var raw = node ? node.textContent : '{}';
          window.I18N = JSON.parse(raw || '{}');
        } catch (e) {
          window.I18N = {};
        }
        window.CURRENT_LANGUAGE = '{{ current_language|default:"en" }}';
        window.CURRENT_REGION = '{{ current_region|default:"US" }}';
        window.t = function(key, fallback){
          if (window.I18N && Object.prototype.hasOwnProperty.call(window.I18N, key)) return window.I18N[key];
          return fallback || key;
        };
      })();
    </script>
    <script src="{% static 'js/app.js'%}"></script>
    {% if maintenance_state %}
      {{ maintenance_state|json_script:"maintenance-state" }}
    {% endif %}
    {% if maintenance_snapshot %}
      {{ maintenance_snapshot|json_script:"maintenance-snapshot" }}
    {% endif %}

    <script>
        // Configure toastr
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        // HTMX Toast Notifications
        document.body.addEventListener('showMessage', function(evt) {
            const message = evt.detail.message;
            const type = evt.detail.type || 'success';
            toastr[type](message);
        });

        // Maintenance + cache-busting client helper.
        (function() {
          var storageKey = 'himalytix-app-version';
          var serverVersion = '{{ app_version }}';
          var maintenanceStateNode = document.getElementById('maintenance-state');
          var maintenanceSnapshotNode = document.getElementById('maintenance-snapshot');

          function clearCachesThenReload(newVersion) {
            try {
              if (window.caches && window.caches.keys) {
                window.caches.keys().then(function(names) {
                  names.forEach(function(name) { window.caches.delete(name); });
                });
              }
              sessionStorage.clear();
              localStorage.setItem(storageKey, newVersion);
            } catch (e) {
              // Non-blocking best-effort cache purge.
            }
            window.location.reload();
          }

          try {
            var previous = localStorage.getItem(storageKey);
            if (serverVersion) {
              if (previous && previous !== serverVersion) {
                clearCachesThenReload(serverVersion);
                return;
              }
              localStorage.setItem(storageKey, serverVersion);
            }
          } catch (e) {
            // Ignore storage failures (private browsing, etc.)
          }

          function handleState(state) {
            if (!state) return;
            if (state.app_version && serverVersion && state.app_version !== serverVersion) {
              clearCachesThenReload(state.app_version);
              return;
            }
            if (state.enabled) {
              toastr.warning(state.status_text || 'Maintenance mode enabled. We will resume shortly.');
              setTimeout(function() { window.location.reload(); }, 1000);
            }
          }

          if (maintenanceStateNode) {
            try {
              handleState(JSON.parse(maintenanceStateNode.textContent || '{}'));
            } catch (e) { /* ignore */ }
          }

          if (maintenanceSnapshotNode) {
            try {
              var snap = JSON.parse(maintenanceSnapshotNode.textContent || '{}');
              if (snap && snap.path) {
                toastr.info('We saved your last action at ' + snap.path + '. Resume once maintenance ends.');
              }
            } catch (e) { /* ignore */ }
          }

          // Only connect to SSE stream if we detect maintenance mode might be active
          // This prevents unnecessary long-polling connections on every page
          // Check if maintenance banner is visible or maintenance mode flag is set
          var maintenanceBanner = document.getElementById('maintenance-banner');
          var shouldConnectSSE = maintenanceBanner && maintenanceBanner.style.display !== 'none';
          
          if (window.EventSource && shouldConnectSSE) {
            try {
              var es = new EventSource("{% url 'maintenance_stream' %}");
              es.onmessage = function(evt) {
                try {
                  var state = JSON.parse(evt.data || '{}');
                  handleState(state);
                  // Close connection if maintenance is not active
                  if (!state.active) {
                    es.close();
                  }
                } catch (e) { /* ignore */ }
              };
              // Auto-close after 2 minutes to prevent hanging connections
              setTimeout(function() { es.close(); }, 120000);
            } catch (err) {
              // SSE not available; nothing to do.
            }
          }
        })();
    </script>
    {% endblock javascript %}
</body>

</html>
