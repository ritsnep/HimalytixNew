<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h5 class="mb-1">PO {{ po.number|default:po.pk }}</h5>
    <p class="text-muted mb-0">
      Vendor: {{ po.vendor.display_name }} | Order date: {{ po.order_date }}
    </p>
  </div>
  <div class="text-end">
    <span class="badge bg-light text-dark text-uppercase mb-2">{{ po.get_status_display }}</span>
    <div class="d-flex gap-2 justify-content-end">
      {% if po.status == po.Status.DRAFT %}
      <form
        hx-post="{% url 'purchasing:po_approve' po.id %}"
        hx-target="#po-detail-panel"
        hx-swap="innerHTML">
        {% csrf_token %}
        <button class="btn btn-success btn-sm" type="submit">Approve</button>
      </form>
      <form
        hx-post="{% url 'purchasing:po_cancel' po.id %}"
        hx-target="#po-detail-panel"
        hx-swap="innerHTML">
        {% csrf_token %}
        <button class="btn btn-outline-danger btn-sm" type="submit">Cancel</button>
      </form>
      {% elif po.status == po.Status.APPROVED %}
      <form
        hx-post="{% url 'purchasing:po_send' po.id %}"
        hx-target="#po-detail-panel"
        hx-swap="innerHTML">
        {% csrf_token %}
        <button class="btn btn-primary btn-sm" type="submit">Mark Sent</button>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Vendor</div>
      <div class="fw-semibold">{{ po.vendor.display_name }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Dates</div>
      <div class="fw-semibold">Order: {{ po.order_date }}</div>
      <div class="text-muted small">Due: {{ po.due_date|default:"-" }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Totals</div>
      <div class="fw-semibold">{{ po.currency.currency_code }} {{ po.total_amount }}</div>
      <div class="text-muted small">Subtotal {{ po.subtotal }} | Tax {{ po.tax_amount }}</div>
    </div>
  </div>
</div>

{% if po.notes %}
<div class="alert alert-secondary py-2">
  <div class="fw-semibold mb-1">Notes</div>
  <div class="mb-0">{{ po.notes }}</div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <h6 class="mb-0">Line Items</h6>
  {% if po.status == po.Status.DRAFT %}
  <button
    class="btn btn-outline-primary btn-sm"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#po-line-add-form"
    aria-expanded="false"
    aria-controls="po-line-add-form">
    Add Line
  </button>
  {% endif %}
</div>

<div class="table-responsive mb-3">
  <table class="table table-bordered table-sm align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th>Product</th>
        <th class="text-end">Qty Ordered</th>
        <th class="text-end">Qty Received</th>
        <th class="text-end">Qty Invoiced</th>
        <th class="text-end">Unit Price</th>
        <th class="text-end">Line Total</th>
      </tr>
    </thead>
    <tbody id="po-lines-body">
      {% for line in po.lines.all %}
        {% include "purchasing/partials/po_line.html" with line=line po=po %}
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted py-4">No lines yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if po.status == po.Status.DRAFT %}
<div class="collapse" id="po-line-add-form">
  <div class="card card-body border p-3">
    <form
      hx-post="{% url 'purchasing:po_line_add' po.id %}"
      hx-target="#po-lines-body"
      hx-swap="beforeend">
      {% csrf_token %}
      <div class="row g-3">
        {% if line_form %}
          {% for field in line_form %}
          <div class="col-md-4">
            <label class="form-label">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <div class="text-danger small">{{ field.errors|striptags }}</div>
            {% endif %}
          </div>
          {% endfor %}
        {% endif %}
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary btn-sm">Add line</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endif %}
