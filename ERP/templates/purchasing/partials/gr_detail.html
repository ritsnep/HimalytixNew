<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h5 class="mb-1">GR {{ gr.number|default:gr.pk }}</h5>
    <p class="text-muted mb-0">
      PO {{ gr.purchase_order.number }} | {{ gr.purchase_order.vendor.display_name }} | {{ gr.warehouse.name }}
    </p>
  </div>
  <div class="text-end">
    <div class="mb-2">
      <span class="badge bg-light text-dark text-uppercase">{{ gr.get_status_display }}</span>
      {% if match_result %}
        {% if match_result.status == "pass" %}
        <span class="badge bg-success-subtle text-success text-uppercase">3-way OK</span>
        {% elif match_result.status == "warn" %}
        <span class="badge bg-warning-subtle text-warning text-uppercase">3-way Warn</span>
        {% else %}
        <span class="badge bg-danger-subtle text-danger text-uppercase">3-way Fail</span>
        {% endif %}
      {% endif %}
    </div>
    <div class="d-flex gap-2 justify-content-end">
      {% if gr.status == gr.Status.DRAFT %}
      <form
        hx-post="{% url 'purchasing:gr_post' gr.id %}"
        hx-target="#gr-detail-panel"
        hx-swap="innerHTML">
        {% csrf_token %}
        <button class="btn btn-success btn-sm" type="submit">Post</button>
      </form>
      <form
        hx-post="{% url 'purchasing:gr_cancel' gr.id %}"
        hx-target="#gr-detail-panel"
        hx-swap="innerHTML">
        {% csrf_token %}
        <button class="btn btn-outline-danger btn-sm" type="submit">Cancel</button>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Dates</div>
      <div class="fw-semibold">Receipt: {{ gr.receipt_date }}</div>
      <div class="text-muted small">Reference: {{ gr.reference_number|default:"-" }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Warehouse</div>
      <div class="fw-semibold">{{ gr.warehouse.name }}</div>
      <div class="text-muted small">{{ gr.warehouse.code }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="border rounded p-3 h-100">
      <div class="text-muted small">Totals</div>
      <div class="fw-semibold">Lines: {{ gr.line_count|default:gr.lines.count }}</div>
      <div class="text-muted small">Accepted: {{ gr.total_accepted|default:0 }}</div>
    </div>
  </div>
</div>

{% if gr.notes %}
<div class="alert alert-secondary py-2">
  <div class="fw-semibold mb-1">Notes</div>
  <div class="mb-0">{{ gr.notes }}</div>
  {% if gr.qc_notes %}<div class="text-muted small mt-1">{{ gr.qc_notes }}</div>{% endif %}
</div>
{% endif %}

<h6 class="mb-2">Line Items</h6>
<div class="table-responsive">
  <table class="table table-bordered table-sm align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th>Product</th>
        <th class="text-end">PO Qty</th>
        <th class="text-end">Received</th>
        <th class="text-end">Accepted</th>
        <th class="text-end">Rejected</th>
        <th class="text-end">QC</th>
        {% if match_result %}<th class="text-end">Match</th>{% endif %}
        {% if gr.status == gr.Status.DRAFT %}<th class="text-end">Update</th>{% endif %}
      </tr>
    </thead>
    <tbody id="gr-lines-body">
      {% for line in gr.lines.all %}
        {% include "purchasing/partials/gr_line.html" with line=line gr=gr match_result=match_result %}
      {% empty %}
      <tr>
        <td colspan="8" class="text-center text-muted py-4">No receipt lines yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% if gr.status == gr.Status.DRAFT %}
  <div class="text-muted small mt-2">Update received/accepted to match the PO quantities before posting.</div>
{% endif %}
</div>
