{% extends 'partials/base.html' %}
{% load static %}
{% load permission_tags %}

{% block title %}Point of Sale - {{ organization.name }}{% endblock %}

{% block css %}
{{ block.super }}
<link rel="manifest" href="{% static 'manifest.json' %}">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Himalytix POS">
<link rel="apple-touch-icon" href="{% static 'images/icon-192.png' %}">
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
/* POS LAYOUT */
.pos-container {
    height: calc(100vh - 120px);
    display: grid;
    grid-template-columns: 2fr 1.6fr 1.2fr;
    gap: 1rem;
}

/* Responsive collapse */
@media (max-width: 1200px) {
    .pos-container {
        grid-template-columns: 1.8fr 1.8fr;
        grid-template-rows: auto auto;
    }
    .checkout-section {
        grid-column: 1 / -1;
        order: -1;
    }
}

@media (max-width: 768px) {
    .pos-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        height: auto;
    }
}

/* Panels */
.products-section,
.order-section,
.checkout-section {
    background: #ffffff;
    border-radius: 10px;
    padding: 0.85rem 0.9rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    min-width: 0;
    width: 100%;
}

/* SECTION HEADERS */
.pos-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.pos-section-header h5 {
    margin-bottom: 0;
    font-weight: 600;
}

/* Status pill */
.pos-status-pill {
    padding: 0.15rem 0.55rem;
    border-radius: 999px;
    font-size: 0.75rem;
}

/* PRODUCTS */
.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.6rem;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.25rem;
}

.product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.6rem;
    text-align: left;
    cursor: pointer;
    transition: all 0.18s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 90px;
}

.product-card-name {
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.2rem;
    line-height: 1.2;
}

.product-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
}

.product-card-price {
    font-weight: 600;
}

.product-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13,110,253,0.18);
    transform: translateY(-1px);
}

.product-card.selected {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

/* SEARCH & NUMPAD */
.barcode-input {
    font-size: 1.2rem;
    font-weight: 600;
    text-align: center;
}

.numpad {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.5rem;
    margin: 0.75rem 0;
}

.numpad button {
    padding: 0.75rem 0.25rem;
    font-size: 1.1rem;
    border-radius: 10px;
    border: 1px solid #dee2e6;
    background: #ffffff;
    cursor: pointer;
    transition: all 0.12s ease-out;
    font-weight: 500;
}

.numpad button:hover {
    background-color: #f8f9fa;
}

.numpad button:active {
    background-color: #e9ecef;
    transform: scale(0.98);
}

/* ORDER / CART */
.cart-items {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.25rem;
    border-top: 1px solid #f1f3f5;
    border-bottom: 1px solid #f1f3f5;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-item-main {
    flex: 1;
    margin-right: 0.5rem;
}

.cart-item-name {
    font-size: 0.85rem;
    font-weight: 500;
}

.cart-item-meta {
    font-size: 0.78rem;
    color: #6c757d;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.quantity-controls button {
    width: 24px;
    height: 24px;
    border-radius: 999px;
    border: 1px solid #dee2e6;
    background: #ffffff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

/* CART TOTAL (detailed breakdown) */
.cart-total {
    border-top: 2px solid #e9ecef;
    padding-top: 0.4rem;
    margin-top: 0.3rem;
    font-size: 0.9rem;
}

.cart-total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.cart-total-row.cart-total-grand {
    font-size: 1.05rem;
    font-weight: 600;
    margin-top: 0.15rem;
}

/* ORDER FOOTER BUTTONS */
.order-footer {
    margin-top: 0.4rem;
    display: flex;
    gap: 0.5rem;
}

/* CHECKOUT / PAYMENT COLUMN */
.checkout-section {
    justify-content: flex-start;
    position: relative;
    width: 100%;
    min-height: 100%;
}

/* Big total card on right */
.grand-total-card {
    border-radius: 10px;
    background: #0d6efd;
    color: #ffffff;
    padding: 0.6rem 0.75rem;
    margin-bottom: 0.7rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

@media (max-width: 768px) {
    .checkout-section {
        order: -1;
        position: sticky;
        top: 64px;
        z-index: 20;
    }
    .grand-total-card {
        position: relative;
        top: auto;
    }
}

.grand-total-label {
    font-size: 0.8rem;
    opacity: 0.9;
}

.grand-total-value {
    font-size: 1.6rem;
    font-weight: 700;
    line-height: 1.1;
}

/* Payment section */
.payment-section {
    margin-top: 0.25rem;
    padding-top: 0.5rem;
    border-top: 1px solid #dee2e6;
}

.payment-methods {
    display: flex;
    gap: 0.4rem;
    margin-bottom: 0.6rem;
}

.payment-method {
    flex: 1;
    padding: 0.4rem 0.2rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #ffffff;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s ease-out;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
}

.payment-method i {
    font-size: 1rem;
    margin-right: 0.25rem;
}

.payment-method.active {
    border-color: #0d6efd;
    background-color: #e7f3ff;
}

/* Quick cash buttons */
.quick-cash {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    margin-top: 0.4rem;
}

.quick-cash button {
    flex: 1 1 30%;
    min-width: 0;
    padding: 0.3rem 0.2rem;
    font-size: 0.8rem;
    border-radius: 999px;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    cursor: pointer;
}

/* Cash input */
.cash-input {
    margin-top: 0.35rem;
}

/* Receipt / Aux actions */
.receipt-actions {
    margin-top: 0.75rem;
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
}

/* Toasts & misc */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.search-results-container {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 0.25rem;
}

/* HTMX indicator */
.htmx-indicator {
    opacity: 0.2;
}

.htmx-request .htmx-indicator {
    opacity: 1;
}

/* Spinner */
.loading {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="main-content" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <div class="page-content">
        <div class="container-fluid">
            <!-- PAGE HEADER -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="page-title mb-0">Point of Sale</h4>
                            <small class="text-muted">
                                {{ organization.name }} POS Terminal - {{ request.user.username }}
                            </small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span id="pos-online-status" class="badge bg-success pos-status-pill">
                                Online
                            </span>
                            <button id="pwa-install-btn" class="btn btn-outline-success btn-sm d-none" type="button" onclick="promptPWAInstall()">
                                <i class="mdi mdi-download"></i> Install App
                            </button>
                            <button class="btn btn-outline-primary btn-sm"
                                    hx-post="{% url 'pos:clear_cart' %}"
                                    hx-target="#cart-items,#cart-total,#customer-name"
                                    hx-swap="innerHTML"
                                    hx-vals='{"customer_name": ""}'>
                                <i class="mdi mdi-refresh"></i> New Transaction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POS LAYOUT -->
            <div class="pos-container mt-2">
                <!-- PRODUCTS SECTION (LEFT) -->
                <div class="products-section">
                    <div class="pos-section-header">
                        <h5>Products</h5>
                        <span class="badge bg-light text-muted">
                            Scan / Search (F2)
                        </span>
                    </div>

                    <!-- Product Search -->
                    <div class="mb-2">
                        <div class="input-group">
                            <input type="text"
                                   id="search-input"
                                   class="form-control barcode-input"
                                   name="search_query"
                                   placeholder="Scan barcode or enter product code..."
                                   autocomplete="off"
                                   hx-get="{% url 'pos:search_products' %}"
                                   hx-target="#search-results"
                                   hx-trigger="input changed delay:300ms, keyup[key=='Enter']"
                                   hx-indicator="#search-indicator">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="mdi mdi-barcode-scan"></i>
                            </button>
                            <span id="search-indicator" class="htmx-indicator loading"></span>
                        </div>
                    </div>

                    <!-- Number Pad -->
                    <div class="numpad" id="numpad">
                        <button type="button" onclick="appendToSearch('1')">1</button>
                        <button type="button" onclick="appendToSearch('2')">2</button>
                        <button type="button" onclick="appendToSearch('3')">3</button>
                        <button type="button" onclick="appendToSearch('4')">4</button>
                        <button type="button" onclick="appendToSearch('5')">5</button>
                        <button type="button" onclick="appendToSearch('6')">6</button>
                        <button type="button" onclick="appendToSearch('7')">7</button>
                        <button type="button" onclick="appendToSearch('8')">8</button>
                        <button type="button" onclick="appendToSearch('9')">9</button>
                        <button type="button" onclick="appendToSearch('0')">0</button>
                        <button type="button" onclick="clearSearchInput()">
                            <i class="mdi mdi-backspace"></i>
                        </button>
                        <button type="button" onclick="addProductByCode()">
                            <i class="mdi mdi-check"></i>
                        </button>
                    </div>

                    <!-- Search / Popular Products -->
                    <div id="search-results"
                         class="search-results-container"
                         hx-get="{% url 'pos:top_products' %}"
                         hx-trigger="load"
                         hx-target="#search-results"
                         hx-swap="innerHTML">
                    </div>
                </div>

                <!-- ORDER SECTION (CENTER) -->
                <div class="order-section">
                    <div class="pos-section-header">
                        <h5>Current Order</h5>
                        <div class="d-flex gap-1">
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    hx-post="{% url 'pos:hold_cart' %}"
                                    hx-target="#cart-items,#cart-total,#held-orders"
                                    hx-swap="innerHTML">
                                <i class="mdi mdi-pause-circle-outline"></i> Hold
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    hx-get="{% url 'pos:list_held_carts' %}"
                                    hx-target="#held-orders"
                                    hx-swap="innerHTML">
                                <i class="mdi mdi-play-circle-outline"></i> Held
                            </button>
                        </div>
                    </div>

                    <div id="held-orders"></div>

                    <!-- Customer Info -->
                    <div class="mb-2">
                        <label class="form-label mb-1">Customer</label>
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   id="customer-name"
                                   class="form-control"
                                   name="customer_name"
                                   value="{{ cart.customer_name|default:'Walk-in Customer' }}"
                                   placeholder="Walk-in Customer"
                                   onblur="saveOrderMeta()">
                            <button class="btn btn-outline-secondary" type="button"
                                    onclick="searchCustomer()">
                                <i class="mdi mdi-account-search-outline"></i>
                            </button>
                        </div>
                        <div id="customer-search-results"></div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label mb-1">Order Notes</label>
                        <textarea class="form-control" id="order-notes" rows="2" placeholder="Add notes" onblur="saveOrderMeta()">{{ cart.notes }}</textarea>
                    </div>

                    <!-- Cart Items -->
                    <div id="cart-items" class="cart-items">
                        {% include 'pos/fragments/cart_items.html' %}
                    </div>

                    <!-- Cart Totals (detail) -->
                    <div id="cart-total"
                         class="cart-total"
                         data-total="{{ cart.total|floatformat:2 }}">
                        <div class="cart-total-row">
                            <span>Subtotal</span>
                            <span>${{ cart.subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="cart-total-row">
                            <span>Tax</span>
                            <span>${{ cart.tax_total|floatformat:2 }}</span>
                        </div>
                        <div class="cart-total-row cart-total-grand">
                            <span>Total</span>
                            <span class="grand-total-amount">${{ cart.total|floatformat:2 }}</span>
                        </div>
                    </div>

                    <!-- Order footer: quick actions -->
                    <div class="order-footer">
                        <button type="button"
                                class="btn btn-outline-danger btn-sm flex-grow-1"
                                hx-post="{% url 'pos:clear_cart' %}"
                                hx-target="#cart-items,#cart-total,#customer-name"
                                hx-swap="innerHTML"
                                hx-vals='{"customer_name": ""}'>
                            <i class="mdi mdi-trash-can-outline"></i> Clear
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm flex-grow-1"
                                onclick="addOrderNote()">
                            <i class="mdi mdi-note-text-outline"></i> Note
                        </button>
                    </div>
                </div>

                <!-- CHECKOUT / PAYMENT SECTION (RIGHT) -->
                <div class="checkout-section">
                    <!-- Big Total -->
                    <div class="grand-total-card">
                        <div class="grand-total-label">Amount Due</div>
                        <div id="grand-total-display" class="grand-total-value">
                            {{ cart.total|floatformat:2 }}
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="payment-section">
                        <h6 class="mb-2">Payment</h6>

                        <div class="payment-methods">
                            <div class="payment-method active"
                                 id="payment-cash"
                                 onclick="selectPaymentMethod('cash')">
                                <i class="mdi mdi-cash"></i> Cash
                            </div>
                            <div class="payment-method"
                                 id="payment-card"
                                 onclick="selectPaymentMethod('card')">
                                <i class="mdi mdi-credit-card-outline"></i> Card
                            </div>
                            <div class="payment-method"
                                 id="payment-other"
                                 onclick="selectPaymentMethod('other')">
                                <i class="mdi mdi-qrcode-scan"></i> Other
                            </div>
                        </div>

                        <div id="cash-input-section" class="cash-input">
                            <label class="form-label mb-1">Cash Received</label>
                            <input type="number"
                                   id="cash-received"
                                   class="form-control form-control-sm"
                                   name="cash_received"
                                   step="0.01"
                                   placeholder="0.00"
                                   oninput="calculateChange()">
                            <div class="quick-cash">
                                <button type="button" onclick="setQuickCash(100)">100</button>
                                <button type="button" onclick="setQuickCash(500)">500</button>
                                <button type="button" onclick="setQuickCash(1000)">1000</button>
                                <button type="button" onclick="setQuickCash('exact')">Exact</button>
                            </div>
                            <div class="mt-2 d-flex justify-content-between small">
                                <span>Change</span>
                                <span id="change-amount" class="fw-bold">$0.00</span>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-3"
                                id="checkout-btn"
                                type="button"
                                onclick="checkout()">
                            <i class="mdi mdi-cash-register"></i>
                            Complete Sale
                        </button>
                    </div>

                    <!-- Receipt & post actions -->
                    <div id="receipt-actions" class="receipt-actions" style="display: none;">
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="printReceipt()">
                            <i class="mdi mdi-printer"></i> Print
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="emailReceipt()">
                            <i class="mdi mdi-email-outline"></i> Email
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="whatsappReceipt()">
                            <i class="mdi mdi-whatsapp"></i> WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

/* Service Worker & PWA */
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('POS Service Worker registered:', registration.scope);

                registration.addEventListener('updatefound', function() {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', function() {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm('A new version of POS is available. Reload to update?')) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(function(error) {
                console.log('POS Service Worker registration failed:', error);
            });
    });

    window.addEventListener('online', function() {
        console.log('Back online - retrying queued requests...');
        const status = document.getElementById('pos-online-status');
        if (status) {
            status.classList.remove('bg-danger');
            status.classList.add('bg-success');
            status.textContent = 'Online';
        }
        if ('sync' in window.ServiceWorkerRegistration.prototype) {
            navigator.serviceWorker.ready.then(function(registration) {
                return registration.sync.register('retry-queued-requests');
            });
        }
    });

    window.addEventListener('offline', function() {
        console.log('Gone offline - requests will be queued');
        const status = document.getElementById('pos-online-status');
        if (status) {
            status.classList.remove('bg-success');
            status.classList.add('bg-danger');
            status.textContent = 'Offline';
        }
    });
}

// PWA install prompt (require user gesture)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.getElementById('pwa-install-btn');
    if (btn) {
        btn.classList.remove('d-none');
    }
});

function promptPWAInstall() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function(choiceResult) {
        console.log('Install prompt outcome:', choiceResult.outcome);
        deferredPrompt = null;
        const btn = document.getElementById('pwa-install-btn');
        if (btn) {
            btn.classList.add('d-none');
        }
    });
}

// CSRF token helper (works with HttpOnly CSRF cookies by reading meta)
function getCSRFToken() {
    const meta = document.querySelector('meta[name=\"csrf-token\"]');
    if (meta && meta.content) return meta.content;
    // fallback if cookie not HttpOnly
    const value = `; ${document.cookie}`;
    const parts = value.split('; csrftoken=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrftoken = getCSRFToken();
    if (csrftoken) {
        evt.detail.headers['X-CSRFToken'] = csrftoken;
    }
});

if (window.htmx) {
    const csrftoken = getCSRFToken();
    if (csrftoken) {
        window.htmx.config.headers = window.htmx.config.headers || {};
        window.htmx.config.headers['X-CSRFToken'] = csrftoken;
    }
    window.htmx.config.withCredentials = true;
}

if (window.htmx) {
    // Ensure cookies/CSRF travel with HTMX requests
    window.htmx.config.withCredentials = true;
}

/* --- POS JS (minimal, HTMX-friendly) --- */

let currentPaymentMethod = 'cash';
let lastInvoiceId = null;

/* Helpers */
function getCartTotal() {
    const cartTotalEl = document.getElementById('cart-total');
    if (!cartTotalEl) return 0;

    const attr = parseFloat(cartTotalEl.getAttribute('data-total'));
    if (!isNaN(attr)) return attr;

    const displaySpan = cartTotalEl.querySelector('.grand-total-amount');
    if (!displaySpan) return 0;
    const text = displaySpan.textContent.replace(/[^0-9.-]/g, '');
    return parseFloat(text) || 0;
}

function updateGrandTotalDisplay() {
    const total = getCartTotal();
    const display = document.getElementById('grand-total-display');
    if (display && !isNaN(total)) {
        display.textContent = total.toFixed(2);
    }
}

/* NUMPAD + SEARCH */
function appendToSearch(digit) {
    const input = document.getElementById('search-input');
    if (!input) return;
    input.value += digit;
    input.dispatchEvent(new Event('input', { bubbles: true }));
}

function clearSearchInput() {
    const input = document.getElementById('search-input');
    if (!input) return;
    input.value = '';
    input.dispatchEvent(new Event('input', { bubbles: true }));
}

function addProductByCode() {
    const input = document.getElementById('search-input');
    if (!input || !input.value) return;
    addProduct(input.value);
}

/* ADD TO CART via HTMX */
function addProduct(productCode) {
    if (!productCode) return;
    const headers = { 'X-CSRFToken': getCookie('csrftoken') || '' };
    htmx.ajax('POST', '{% url "pos:add_to_cart" %}', {
        values: { product_code: productCode, quantity: 1 },
        target: '#cart-items,#cart-total',
        swap: 'innerHTML',
        headers: headers
    }).then(() => {
        updateGrandTotalDisplay();
    }).catch(() => {
        showToast('Error adding product', 'error');
    });
}

/* PAYMENT */
function selectPaymentMethod(method) {
    currentPaymentMethod = method;

    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('active');
    });
    const activeEl = document.getElementById(`payment-${method}`);
    if (activeEl) {
        activeEl.classList.add('active');
    }

    const cashSection = document.getElementById('cash-input-section');
    if (cashSection) {
        cashSection.style.display = (method === 'cash') ? 'block' : 'none';
    }
}

function setQuickCash(amount) {
    const input = document.getElementById('cash-received');
    if (!input) return;
    if (amount === 'exact') {
        const total = getCartTotal();
        input.value = total.toFixed(2);
    } else {
        input.value = parseFloat(amount).toFixed(2);
    }
    calculateChange();
}

function calculateChange() {
    const cashInput = document.getElementById('cash-received');
    const changeEl = document.getElementById('change-amount');
    if (!cashInput || !changeEl) return;

    const cashReceived = parseFloat(cashInput.value) || 0;
    const total = getCartTotal();
    const change = cashReceived - total;
    changeEl.textContent = `$${change.toFixed(2)}`;
}

/* CHECKOUT */
function checkout() {
    const cartTotal = getCartTotal();
    const customerInput = document.getElementById('customer-name');
    const customerName = customerInput ? customerInput.value : '';
    const cashInput = document.getElementById('cash-received');

    let cashReceived = cartTotal;
    if (currentPaymentMethod === 'cash' && cashInput) {
        cashReceived = parseFloat(cashInput.value) || 0;
    }

    if (cartTotal === 0) {
        showToast('Cart is empty', 'error');
        return;
    }

    if (currentPaymentMethod === 'cash' && cashReceived < cartTotal) {
        showToast('Insufficient cash received', 'error');
        return;
    }

    const headers = { 'X-CSRFToken': getCookie('csrftoken') || '' };
    htmx.ajax('POST', '{% url "pos:checkout" %}', {
        values: {
            payment_method: currentPaymentMethod,
            cash_received: cashReceived,
            customer_name: customerName
        },
        target: '#cart-items,#cart-total,#receipt-actions',
        swap: 'innerHTML',
        headers: headers
    }).then(() => {
        // NOTE: Ideally backend sets data-invoice-id on #receipt-actions
        const receipt = document.getElementById('receipt-actions');
        if (receipt && receipt.dataset.invoiceId) {
            lastInvoiceId = receipt.dataset.invoiceId;
        } else {
            lastInvoiceId = 'completed';
        }

        if (receipt) {
            receipt.style.display = 'flex';
        }

        updateGrandTotalDisplay();

        if (cashInput) {
            cashInput.value = '';
        }
        const changeEl = document.getElementById('change-amount');
        if (changeEl) {
            changeEl.textContent = '$0.00';
        }
    }).catch(() => {
        showToast('Checkout failed', 'error');
    });
}

/* RECEIPT ACTIONS */
function printReceipt() {
    if (!lastInvoiceId) {
        showToast('No invoice available', 'error');
        return;
    }
    window.open(`/accounting/sales-invoice/${lastInvoiceId}/print/`, '_blank');
}

function emailReceipt() {
    showToast('Email receipt feature coming soon');
}

function whatsappReceipt() {
    showToast('WhatsApp receipt feature coming soon');
}

function addOrderNote() {
    const notesInput = document.getElementById('order-notes');
    if (!notesInput) return;
    notesInput.focus();
}

/* Customer search + order meta */
function searchCustomer() {
    const nameInput = document.getElementById('customer-name');
    const q = (nameInput && nameInput.value) ? nameInput.value : '';
    htmx.ajax('GET', `{% url "pos:search_customers" %}?q=${encodeURIComponent(q)}`, {
        target: '#customer-search-results',
        swap: 'innerHTML'
    });
}

function selectCustomer(name) {
    const input = document.getElementById('customer-name');
    if (!input) return;
    input.value = name;
    saveOrderMeta();
    const results = document.getElementById('customer-search-results');
    if (results) results.innerHTML = '';
}

function saveOrderMeta() {
    const customerName = document.getElementById('customer-name') ? document.getElementById('customer-name').value : '';
    const notes = document.getElementById('order-notes') ? document.getElementById('order-notes').value : '';
    const headers = { 'X-CSRFToken': getCSRFToken() || '' };
    htmx.ajax('POST', '{% url "pos:update_cart_meta" %}', {
        values: { customer_name: customerName, notes: notes },
        headers: headers,
        target: '#cart-total',
        swap: 'none'
    }).catch(() => {
        showToast('Could not save details', 'error');
    });
}

/* TOASTS */
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(toast);

    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

/* Focus search input and sync totals on load */
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.focus();
    }
    updateGrandTotalDisplay();
});

/* When HTMX updates the cart-total, sync the big total on right */
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target && evt.target.id === 'cart-total') {
        updateGrandTotalDisplay();
        calculateChange();
    }
});
</script>
{% endblock %}
