<div id="sales-invoice-panel">
  <div id="sales-invoice-errors">
    {% if alert_message %}
    <div class="alert alert-{{ alert_level|default:'info' }} mb-3" role="alert">
      {{ alert_message }}
    </div>
    {% endif %}
  </div>
  <form
    id="invoiceForm"
    method="post"
    action="{% url 'billing:invoice_save' %}"
    hx-post="{% url 'billing:invoice_save' %}"
    hx-target="#sales-invoice-panel"
    hx-swap="innerHTML"
    hx-indicator="#sales-invoice-loading"
  >
    {% csrf_token %}
    <div class="invoice-form">
      <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="section-title mb-0">Customer & Billing</h3>
          <small class="text-muted">PAN, address, and A/R accounts come from the customer master.</small>
        </div>
        <div class="row g-3">
          <div class="col-md-5 position-relative">
            <label class="form-label">Customer *</label>
            <input type="text"
                   class="form-control"
                   id="customerSearch"
                   name="q"
                   placeholder="Search by name, phone, or PAN"
                   hx-get="{% url 'billing:customer_search' %}"
                   hx-trigger="keyup changed delay:300ms"
                   hx-target="#customerResults"
                   autocomplete="off">
            <input type="hidden" name="customer_id" id="customerId" value="{{ selected_customer_id|default:'' }}">
            <input type="hidden" name="customer_name" id="customerName" value="{{ selected_customer_name|default:'' }}">
            <div id="customerResults" class="customer-search-results d-none"></div>
          </div>
          <div class="col-md-2">
            <label class="form-label">Invoice Date *</label>
            <input type="date" class="form-control" name="invoice_date" value="{{ invoice_date|default:today|date:'Y-m-d' }}" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-control" name="due_date" value="{{ due_date|default:'' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Payment Term</label>
            <select name="payment_term" class="form-control">
              <option value="">Use customer default</option>
              {% for term in payment_terms %}
              <option value="{{ term.payment_term_id }}" data-net-days="{{ term.net_due_days }}">{{ term.name }} ({{ term.net_due_days }} days)</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-2">
            <label class="form-label">Currency *</label>
            <select name="currency" class="form-control">
              {% for currency in currencies %}
              <option value="{{ currency.currency_code }}" {% if default_currency and currency.currency_code == default_currency.currency_code %}selected{% endif %}>{{ currency.currency_code }} - {{ currency.currency_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Exchange Rate</label>
            <input type="number" step="0.0001" class="form-control" name="exchange_rate" value="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">Warehouse</label>
            <select name="warehouse" class="form-control">
              <option value="">Select warehouse (for inventory items)</option>
              {% for wh in warehouses %}
              <option value="{{ wh.warehouse_id }}">{{ wh.code }} - {{ wh.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Journal Type</label>
            <select name="journal_type" class="form-control">
              {% for jt in journal_types %}
              <option value="{{ jt.journal_type_id }}">{{ jt.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" name="reference_number" placeholder="PO or reference">
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">Invoice Items</h3>
          <button type="button" class="btn btn-primary btn-sm" onclick="addLineRow()">
            <i class="fas fa-plus"></i> Add Line
          </button>
        </div>
        <div id="invoiceLines">
          {% include 'billing/partials/invoice_line_row.html' with line_index=1 %}
        </div>
        <p class="text-muted small mt-2 mb-0">Tip: Select multiple tax codes for multi-tax regions (e.g., state + local). VAT (13%) can be set up as a single tax code.</p>
      </div>

      <div class="form-section">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Notes (Internal)</label>
            <textarea class="form-control" name="notes" rows="3" placeholder="Internal notes (not shown on print)"></textarea>
          </div>
          <div class="col-md-6">
            <div id="invoiceTotals">
              {% include 'billing/partials/invoice_totals.html' with subtotal=0 tax_total=0 total=0 currency_code=currency_code %}
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 justify-content-end">
        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
        <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary">
          <i class="fas fa-save"></i> Save as Draft
        </button>
        <button type="submit" name="action" value="post" class="btn btn-success">
          <i class="fas fa-check"></i> Post &amp; Submit to IRD
        </button>
        <div id="sales-invoice-loading" class="htmx-indicator text-muted small ms-2">Saving...</div>
      </div>
    </div>
  </form>
</div>
